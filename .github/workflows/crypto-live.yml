name: Crypto Live (Every 15 min) â€” LIVE

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      EXCHANGE: "kraken"
      DRY_RUN: "false"                # set "true" to paper trade
      SYMBOLS: "BTC/USDT,ETH/USDT,DOGE/USDT,XRP/USDT,ADA/USDT"

      PER_TRADE_USD: "10"
      DAILY_CAP_USD: "15"
      MIN_NOTIONAL_USD: "5"

      BUY_GATE_PCT: "0.0"

      TRAIL_ACTIVATE_PCT: "3.0"       # start trailing after +3%
      TRAIL_OFFSET_PCT: "1.0"         # sell if -1% from the anchor

      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Restore latest .state (positions/trails/daily_spend) from cache
      - name: Restore .state cache
        uses: actions/cache/restore@v4
        with:
          path: .state
          key: state-${{ github.run_id }}
          restore-keys: |
            state-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Run trader
        run: |
          echo "=== START TRADING OUTPUT ==="
          python main.py
          echo "=== END TRADING OUTPUT ==="

      # Save updated .state so the next run remembers positions & trails
      - name: Save .state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .state
          key: state-${{ github.run_id }}
