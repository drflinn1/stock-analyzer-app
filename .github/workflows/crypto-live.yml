name: Crypto Live (Every 15 min — LIVE)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes

concurrency:
  group: crypto-live
  cancel-in-progress: true

env:
  # --- Runtime ---
  PYTHON_VERSION: "3.11"
  DRY_RUN: "true"                       # keep true while verifying balances

  # --- Picker (Balanced) ---
  DROP_PCT: "2.5"
  ENABLE_RSI: "true"
  RSI_LEN: "14"
  RSI_MAX: "35"
  CANDLES_TIMEFRAME: "15m"
  MIN_ACTIVE_POSITION_USD: "2"

  # --- Exits ---
  TAKE_PROFIT_PCT: "3.0"
  STOP_LOSS_PCT: "2.0"
  TRAIL_START_PCT: "3.0"
  TRAIL_OFFSET_PCT: "1.0"

  # --- Sizing & caps ---
  POSITION_SIZE_USD: "10"
  DAILY_SPEND_CAP_USD: "15"
  MAX_OPEN_TRADES: "3"
  MIN_BALANCE_USD: "5"

  # --- Universe ---
  SYMBOLS: "BTC/USD,ETH/USD,DOGE/USD"

jobs:
  run:
    name: Run trader (LIVE)
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      # --- sanity: make sure secrets are actually present (no secret values printed) ---
      - name: Sanity — Kraken keys present?
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          if [ -z "${KRAKEN_API_KEY}" ] || [ -z "${KRAKEN_API_SECRET}" ]; then
            echo "❌ Kraken keys are missing. Add KRAKEN_API_KEY and KRAKEN_API_SECRET in repo Settings → Secrets → Actions."
            exit 1
          else
            echo "✅ Kraken keys detected."
          fi

      - name: Run trader
        env:
          # Kraken secrets (now required for private_api=ON)
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # If you previously added SIM_BALANCE_QUOTE, remove/comment it now so real balances show
          # SIM_BALANCE_QUOTE: "100"

          # pass-through knobs
          DRY_RUN: ${{ env.DRY_RUN }}
          DROP_PCT: ${{ env.DROP_PCT }}
          ENABLE_RSI: ${{ env.ENABLE_RSI }}
          RSI_LEN: ${{ env.RSI_LEN }}
          RSI_MAX: ${{ env.RSI_MAX }}
          CANDLES_TIMEFRAME: ${{ env.CANDLES_TIMEFRAME }}
          TAKE_PROFIT_PCT: ${{ env.TAKE_PROFIT_PCT }}
          STOP_LOSS_PCT: ${{ env.STOP_LOSS_PCT }}
          TRAIL_START_PCT: ${{ env.TRAIL_START_PCT }}
          TRAIL_OFFSET_PCT: ${{ env.TRAIL_OFFSET_PCT }}
          POSITION_SIZE_USD: ${{ env.POSITION_SIZE_USD }}
          DAILY_SPEND_CAP_USD: ${{ env.DAILY_SPEND_CAP_USD }}
          MAX_OPEN_TRADES: ${{ env.MAX_OPEN_TRADES }}
          MIN_BALANCE_USD: ${{ env.MIN_BALANCE_USD }}
          SYMBOLS: ${{ env.SYMBOLS }}
        run: |
          set -e
          python main.py
