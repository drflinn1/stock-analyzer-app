name: Crypto Live (Active — 5m, Auto-Universe)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes

concurrency:
  group: crypto-live
  cancel-in-progress: true

env:
  # --- Runtime ---
  PYTHON_VERSION: "3.11"
  DRY_RUN: "false"                 # set to "true" to pause live trading

  # --- Picker (Active) ---
  CANDLES_TIMEFRAME: "5m"
  DROP_PCT: "1.5"                  # looser than 2.5 → more entries
  ENABLE_RSI: "true"
  RSI_LEN: "14"
  RSI_MAX: "45"                    # looser than 35 → more entries

  # --- Exits ---
  TAKE_PROFIT_PCT: "3.0"
  STOP_LOSS_PCT: "2.0"
  TRAIL_START_PCT: "2.5"           # earlier trailing
  TRAIL_OFFSET_PCT: "0.8"          # tighter lock-in

  # --- Sizing & caps ---
  POSITION_SIZE_USD: "10"
  DAILY_SPEND_CAP_USD: "40"        # daily cap
  MAX_OPEN_TRADES: "5"
  MIN_BALANCE_USD: "5"
  MIN_ACTIVE_POSITION_USD: "2"     # ignore dust < $2 so it won't block buys

  # --- Universe ---
  # Choose mode: "auto" (top-N by 24h USD volume) or "manual"
  UNIVERSE_MODE: "auto"
  QUOTE: "USD"
  TOP_N_SYMBOLS: "12"
  MIN_USD_VOL: "1000000"           # only consider pairs with ≥ $1M 24h USD vol
  EXCLUDE_SYMBOLS: ""              # e.g., "XRP/USD,SHIB/USD"
  INCLUDE_SYMBOLS: "BTC/USD,ETH/USD"   # force-include favorites
  # Manual list is only used if UNIVERSE_MODE="manual" or auto yields nothing
  SYMBOLS: "BTC/USD,ETH/USD,SOL/USD,DOGE/USD,LTC/USD,LINK/USD,AVAX/USD,ADA/USD,DOT/USD"

jobs:
  run:
    name: Run trader (LIVE)
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      # sanity: ensure Kraken keys are wired
      - name: Sanity — Kraken keys present?
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY || vars.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET || vars.KRAKEN_API_SECRET }}
        run: |
          if [ -z "${KRAKEN_API_KEY}" ] || [ -z "${KRAKEN_API_SECRET}" ]; then
            echo "❌ Kraken keys are missing. Add KRAKEN_API_KEY and KRAKEN_API_SECRET under Settings → Secrets → Actions."
            exit 1
          else
            echo "✅ Kraken keys detected."
          fi

      - name: Run trader
        env:
          # Kraken credentials
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY || vars.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET || vars.KRAKEN_API_SECRET }}

          # runtime
          DRY_RUN: ${{ env.DRY_RUN }}

          # picker
          CANDLES_TIMEFRAME: ${{ env.CANDLES_TIMEFRAME }}
          DROP_PCT: ${{ env.DROP_PCT }}
          ENABLE_RSI: ${{ env.ENABLE_RSI }}
          RSI_LEN: ${{ env.RSI_LEN }}
          RSI_MAX: ${{ env.RSI_MAX }}

          # exits
          TAKE_PROFIT_PCT: ${{ env.TAKE_PROFIT_PCT }}
          STOP_LOSS_PCT: ${{ env.STOP_LOSS_PCT }}
          TRAIL_START_PCT: ${{ env.TRAIL_START_PCT }}
          TRAIL_OFFSET_PCT: ${{ env.TRAIL_OFFSET_PCT }}

          # sizing / caps
          POSITION_SIZE_USD: ${{ env.POSITION_SIZE_USD }}
          DAILY_SPEND_CAP_USD: ${{ env.DAILY_SPEND_CAP_USD }}
          MAX_OPEN_TRADES: ${{ env.MAX_OPEN_TRADES }}
          MIN_BALANCE_USD: ${{ env.MIN_BALANCE_USD }}
          MIN_ACTIVE_POSITION_USD: ${{ env.MIN_ACTIVE_POSITION_USD }}

          # universe controls
          UNIVERSE_MODE: ${{ env.UNIVERSE_MODE }}
          QUOTE: ${{ env.QUOTE }}
          TOP_N_SYMBOLS: ${{ env.TOP_N_SYMBOLS }}
          MIN_USD_VOL: ${{ env.MIN_USD_VOL }}
          EXCLUDE_SYMBOLS: ${{ env.EXCLUDE_SYMBOLS }}
          INCLUDE_SYMBOLS: ${{ env.INCLUDE_SYMBOLS }}
          SYMBOLS: ${{ env.SYMBOLS }}
        run: |
          set -e
          python main.py
