name: Crypto Live (Every 15 min — CONCENTRATED + PYRAMID + SWEEP + TAX)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: crypto-live-concentrated
  cancel-in-progress: false

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    # ===== Global ENV (available to all steps) =====
    env:
      # ---- Core ----
      MODE: "live"
      DRY_RUN: "false"
      EXCHANGE: "kraken"
      BASE_CCY: "USD"

      # Small fee cushion on buys (avoid 'insufficient funds' race)
      FEE_BUY_BUFFER_PCT: "0.50"

      # Sell safety & cleanup
      SELL_SAFETY_EPS_PCT: "0.25"                 # can sell up to 0.25% below free balance
      CANCEL_OPEN_ORDERS_BEFORE_SELL: "true"      # clean lingering reserves

      # ---- Universe & Ranking (Concentrated) ----
      AUTO_UNIVERSE: "true"
      UNIVERSE_TOP_N: "12"         # broaden candidates
      MAX_CONCURRENT_POS: "3"      # concentrate the book
      MIN_LIQ_USD_24H: "500000"    # still safe liquidity
      MOMENTUM_LOOKBACK_H: "24"

      # ---- Multi-timeframe filter ----
      TF_FAST: "15m"
      TF_SLOW: "1h"
      EMA_SHORT: "20"
      EMA_LONG: "50"
      RSI_LEN: "14"
      RSI_BUY: "58"
      RSI_SELL: "45"

      # ---- Volatility scaled sizing ----
      ATR_LEN: "14"
      RISK_PER_TRADE_PCT: "1.6"

      # ---- Portfolio / guardrails ----
      ADE_USD_CAP: "75"            # bump later if you want bigger swings
      MAX_TRADES_PER_RUN: "8"
      PORTFOLIO_MAX_EXPOSURE_PCT: "75"

      # ---- Exits ----
      ATR_MULTIPLIER_TP: "1.0"
      ATR_MULTIPLIER_TS: "1.4"
      ATR_MULTIPLIER_SL: "1.8"
      TRAIL_ACTIVATE_AT_PN_FPAG: "0.0"

      # ---- Dust sweeper trigger ----
      DUST_SWEEP_TRIGGER_USD: "1.00"

      # ====== <== IMPORTANT: exchange credentials are read from these envs ==>
      # They are injected from repository secrets below.
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

    steps:
      - name: Set up job
        run: echo "Starting run…"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install ccxt pandas numpy ta tenacity; fi

      # ---- Preflight: make sure API creds exist ----
      - name: Preflight: check API credentials
        run: |
          missing=0
          if [ -z "${KRAKEN_API_KEY}" ] || [ -z "${KRAKEN_API_SECRET}" ]; then
            echo "::error::Missing KRAKEN_API_KEY and/or KRAKEN_API_SECRET in repository Actions secrets."
            missing=1
          fi
          exit $missing

      # ---- OPTIONAL: Pre-run sweep (sells only) ----
      - name: Dust Sweep (pre-run, sells only)
        run: |
          python -u tools/dust_sweeper.py

      # ---- Trader (safe-buy wrapper that avoids tiny 'insufficient funds' misses) ----
      - name: Run trader (with safe-sell wrapper)
        run: |
          python -u tools/run_with_safe_sell.py

      # ---- OPTIONAL: Post-run sweep (catch new dust) ----
      - name: Dust Sweep (post-run, sells only)
        if: always()
        run: |
          python -u tools/dust_sweeper.py

      # ---- Tax export (artifact) ----
      - name: Tax export (FIFO 8949)
        run: |
          python -u tools/tax_export.py
        continue-on-error: true

      - name: Upload artifacts (equity + tax)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: equity + tax
          path: |
            data/equity_history.csv
            data/tax_summary.json

      - name: Post Set up Python
        run: echo "Done"
