name: Crypto Live (Every 15 min) — LIVE

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      # ===== Execution mode =====
      EXCHANGE: "kraken"
      DRY_RUN: "false"           # set "true" to paper trade

      # ===== Auto-Universe (top-N by 24h volume) =====
      AUTO_UNIVERSE: "true"
      UNIVERSE_TOP_N: "5"        # how many symbols to trade each run
      QUOTE: "USD"               # you hold USD on Kraken
      MIN_PRICE_USD: "0.00"      # e.g., "0.01" to skip sub-penny coins
      EXCLUDE_BASES: "USDT,USDC,DAI,USD,UST,EURT"
      INCLUDE_BASES: ""          # optional allow-list; leave blank

      # Fallback manual list (used only if AUTO_UNIVERSE=false)
      SYMBOLS: "BTC/USD,ETH/USD,DOGE/USD,ADA/USD,XRP/USD"

      # ===== Sizing & caps =====
      PER_TRADE_USD: "25"        # raised so BTC/ETH can pass minimums
      DAILY_CAP_USD: "125"
      MIN_NOTIONAL_USD: "5"
      BUY_GATE_PCT: "0.0"        # 0 = always allowed by minimal logic

      # ===== Trailing profit =====
      TRAIL_ACTIVATE_PCT: "3.0"  # start trailing after +3% unrealized
      TRAIL_OFFSET_PCT: "1.0"    # sell if -1% from anchor

      # ===== Secrets =====
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      # Optional one-run toggle if you ever need to clear local state
      RESET_STATE: "false"       # set to "true" for ONE run, then back to "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore .state cache
        uses: actions/cache/restore@v4
        with:
          path: .state
          key: state-${{ github.run_id }}
          restore-keys: |
            state-

      - name: Reset state (one-time)
        if: env.RESET_STATE == 'true'
        run: |
          rm -rf .state
          echo "Purged .state (positions/trails/daily spend)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Sanity — Keys present if live
        if: env.DRY_RUN == 'false'
        run: |
          test -n "${KRAKEN_API_KEY}" || (echo "Missing KRAKEN_API_KEY" && exit 1)
          test -n "${KRAKEN_API_SECRET}" || (echo "Missing KRAKEN_API_SECRET" && exit 1)
          echo "Secrets look present."

      - name: Run trader
        run: |
          echo "=== START TRADING OUTPUT ==="
          python main.py
          echo "=== END TRADING OUTPUT ==="

      - name: Save .state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .state
          key: state-${{ github.run_id }}
