name: Crypto Live â€” CONCENTRATED Momentum (15m, Pyramid + Sweep + Tax)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

# Manual runs win; scheduled runs queue behind them
concurrency:
  group: crypto-live-concentrated
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # ===== Core =====
      MODE: "live"
      DRY_RUN: "false"
      EXCHANGE: "kraken"
      BASE_CCY: "USD"

      # ===== Universe & Ranking (Concentrated) =====
      AUTO_UNIVERSE: "true"
      UNIVERSE_TOP_N: "12"          # broaden candidates
      MAX_CONCURRENT_POS: "3"       # concentrate the book
      MIN_LIQ_USD_24H: "500000"     # still safe liquidity
      MOMENTUM_LOOKBACK_H: "24"
      MIN_PRICE_USD: "0.01"
      MIN_NOTIONAL_USD: "5"

      # ===== Multi-timeframe trend filter =====
      TF_FAST: "15m"
      TF_SLOW: "1h"
      EMA_SHORT: "20"
      EMA_LONG: "50"
      RSI_LEN: "14"
      RSI_BUY: "57"                 # slightly looser to get entries
      RSI_SELL: "45"

      # ===== Volatility-scaled sizing =====
      ATR_LEN: "14"
      RISK_PER_TRADE_PCT: "1.6"
      PER_TRADE_USD_CAP: "85"       # larger tickets
      MAX_TRADES_PER_RUN: "10"
      PORTFOLIO_MAX_EXPOSURE_PCT: "85"   # bigger snowball ceiling

      # ===== Exits =====
      ATR_MULTIPLIER_TP: "1.0"
      ATR_MULTIPLIER_TS: "1.4"
      ATR_MULTIPLIER_SL: "1.6"      # quicker to free capital
      TRAIL_ACTIVATE_AT_TP_FRAC: "0.5"

      # ===== Stale logic =====
      STALE_MAX_HOURS: "24"
      STALE_RSI_MAX_BARS: "6"
      STALE_MIN_GAIN_PCT: "-3"

      # ===== Pyramiding =====
      PYRAMID_ENABLED: "true"
      PYRAMID_MAX_ADDS: "3"               # more adds
      PYRAMID_ADD_AT_GAIN_PCT: "1.8"      # add sooner
      PYRAMID_STEP_ATR: "0.75"

      # ===== Dust sweeper (SELLS ONLY) =====
      DUST_SWEEP_ENABLED: "true"
      DUST_SWEEP_USD_TRIGGER: "1"
      DUST_MAX_NOTIONAL_USD: "20"
      DUST_SKIP_ASSETS: "USD,USDT,USDC"

      # ===== Budget rails =====
      DAILY_CAP_USD: "300"
      MIN_FREE_CASH_USD: "15"
      SLIPPAGE_PCT: "0.10"

      # ===== Buy fee buffer =====
      FEE_BUY_BUFFER_PCT: "0.5"     # require +0.5% headroom for buys

      # ===== Circuit breaker =====
      DRAWDOWN_PCT_TRIP: "15"
      DRAWDOWN_COOLDOWN_RUNS: "8"

      # ===== Telemetry =====
      LOG_LEVEL: "INFO"
      WRITE_EQUITY_CSV: "true"
      PRINT_EQUITY_ONE_LINER: "true"
      DEBUG_SKIPS: "true"            # harmless if not implemented in code

      # ===== Secrets =====
      KRAKEN_API_KEY: "${{ secrets.KRAKEN_API_KEY }}"
      KRAKEN_API_SECRET: "${{ secrets.KRAKEN_API_SECRET }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install ccxt pandas numpy ta
          fi

      - name: Dust Sweep (pre-run, sells only)
        shell: bash
        run: |
          set -e
          if [[ -f tools/dust_sweeper.py ]]; then
            python -u tools/dust_sweeper.py
          else
            echo "[dust] tools/dust_sweeper.py missing - skipping pre-run sweep"
          fi

      - name: Run trader
        shell: bash
        run: |
          set -e
          python -u main.py

      - name: Dust Sweep (post-run, sells only)
        if: always()
        shell: bash
        run: |
          set -e
          if [[ -f tools/dust_sweeper.py ]]; then
            python -u tools/dust_sweeper.py
          else
            echo "[dust] tools/dust_sweeper.py missing - skipping post-run sweep"
          fi

      - name: Tax export (FIFO 8949)
        if: always()
        shell: bash
        run: |
          set -e
          if [[ -f tools/tax_export.py ]]; then
            python -u tools/tax_export.py
          else
            echo "[tax] tools/tax_export.py missing - skipping tax export"
          fi

      - name: Upload artifacts (equity + tax)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run_artifacts
          path: |
            data/equity_history.csv
            data/tax_8949.csv
            data/tax_summary.json
          if-no-files-found: ignore
