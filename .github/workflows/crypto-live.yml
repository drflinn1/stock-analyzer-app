name: Crypto Live â€” Kraken (every 15m)

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "ON = simulate (no orders). OFF = live orders."
        type: choice
        required: false
        default: "OFF"
        options: ["ON", "OFF"]
      RUN_SWITCH:
        description: "Master on/off switch for the bot"
        type: choice
        required: false
        default: "ON"
        options: ["ON", "OFF"]
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes

permissions:
  contents: read

concurrency:
  group: crypto-live-${{ github.ref }}
  cancel-in-progress: false

env:
  # ---- Core toggles (safe defaults can be overridden via workflow_dispatch inputs) ----
  DRY_RUN: ${{ inputs.DRY_RUN || 'OFF' }}
  RUN_SWITCH: ${{ inputs.RUN_SWITCH || 'ON' }}

  # ---- Exchange / universe / sizing ----
  EXCHANGE: "kraken"
  QUOTE: "USD"
  UNIVERSE: "BTC,ETH,SOL,DOGE,ADA,ZEC"
  MAX_POSITIONS: "6"
  USD_PER_TRADE: "20"             # adjust to taste
  RESERVE_CASH_PCT: "10"          # keep some cash back

  # ---- Rotation & dust ----
  ROTATE_WHEN_CASH_SHORT: "true"  # sell laggards to fund a better buy
  ROTATE_WHEN_FULL: "false"       # avoid over-churn in scalping mode
  DUST_MIN_USD: "2"

  # ---- Guards (take-profit / stop-loss / daily caps) ----
  TAKE_PROFIT_PCT: "3.0"
  STOP_LOSS_PCT: "2.0"
  TRAIL_STOP_PCT: "1.0"
  MAX_DAILY_LOSS_PCT: "5.0"
  MAX_DAILY_ENTRIES: "6"
  EMERGENCY_SL_PCT: "8.0"

  # ---- Files & artifacts ----
  STATE_DIR: ".state"
  POSITIONS_JSON: ".state/positions.json"
  KPI_CSV: ".state/kpi_history.csv"
  SPEC_GATE_REPORT: ".state/spec_gate_report.txt"

  # ---- Slack (set this secret in repo settings â†’ Secrets and variables â†’ Actions) ----
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  live:
    name: Run bot
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}-${{ env.DRY_RUN }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install minimal deps (fast)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir ccxt pandas numpy requests

      # ---------- Heartbeat (Slack) ----------
      - name: Heartbeat â€” Slack "bot starting"
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        run: |
          RUN_MODE="${{ env.DRY_RUN }}"
          NOW="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          MSG="ðŸ«€ *Crypto Live Heartbeat* â€” ${NOW}\nRepo: ${{ github.repository }}\nRef: ${{ github.ref_name }}\nRun: ${{ github.run_id }}\nMode: *${RUN_MODE}*\nSwitch: ${{ env.RUN_SWITCH }}"
          payload=$(jq -n --arg text "$MSG" '{text: $text}')
          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" >/dev/null
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}

      - name: Heartbeat â€” echo fallback
        if: ${{ env.SLACK_WEBHOOK_URL == '' }}
        run: |
          echo "Heartbeat OK â€” $(date -u) â€” DRY_RUN=${{ env.DRY_RUN }} RUN_SWITCH=${{ env.RUN_SWITCH }}"

      # ---------- Run bot ----------
      - name: Prepare state dir
        run: |
          mkdir -p "${STATE_DIR}"
          : > "${SPEC_GATE_REPORT}" || true

      - name: Print mode banner
        run: |
          if [ "${DRY_RUN}" = "ON" ]; then
            echo "ðŸš§ DRY RUN â€” NO REAL ORDERS SENT ðŸš§"
          else
            echo "âœ… LIVE MODE â€” REAL ORDERS ENABLED"
          fi

      - name: Run main.py
        env:
          # Pass through envs for your bot
          EXCHANGE: ${{ env.EXCHANGE }}
          QUOTE: ${{ env.QUOTE }}
          UNIVERSE: ${{ env.UNIVERSE }}
          MAX_POSITIONS: ${{ env.MAX_POSITIONS }}
          USD_PER_TRADE: ${{ env.USD_PER_TRADE }}
          RESERVE_CASH_PCT: ${{ env.RESERVE_CASH_PCT }}
          ROTATE_WHEN_CASH_SHORT: ${{ env.ROTATE_WHEN_CASH_SHORT }}
          ROTATE_WHEN_FULL: ${{ env.ROTATE_WHEN_FULL }}
          DUST_MIN_USD: ${{ env.DUST_MIN_USD }}
          TAKE_PROFIT_PCT: ${{ env.TAKE_PROFIT_PCT }}
          STOP_LOSS_PCT: ${{ env.STOP_LOSS_PCT }}
          TRAIL_STOP_PCT: ${{ env.TRAIL_STOP_PCT }}
          MAX_DAILY_LOSS_PCT: ${{ env.MAX_DAILY_LOSS_PCT }}
          MAX_DAILY_ENTRIES: ${{ env.MAX_DAILY_ENTRIES }}
          EMERGENCY_SL_PCT: ${{ env.EMERGENCY_SL_PCT }}
          RUN_SWITCH: ${{ env.RUN_SWITCH }}
          DRY_RUN: ${{ env.DRY_RUN }}
          STATE_DIR: ${{ env.STATE_DIR }}
          POSITIONS_JSON: ${{ env.POSITIONS_JSON }}
          KPI_CSV: ${{ env.KPI_CSV }}
          SPEC_GATE_REPORT: ${{ env.SPEC_GATE_REPORT }}
          # Exchange creds via secrets (set these in your repo)
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          set -e
          python -u main.py

      # ---------- Slack completion ping (optional but handy) ----------
      - name: Slack â€” run completed
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        run: |
          STATUS="${{ job.status }}"
          NOW="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          MSG="âœ… *Crypto Live completed* â€” ${NOW}\nStatus: *${STATUS}*\nMode: *${{ env.DRY_RUN }}*\nArtifacts: positions.json / kpi_history.csv / spec_gate_report.txt"
          payload=$(jq -n --arg text "$MSG" '{text: $text}')
          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" >/dev/null
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}

      # ---------- Artifacts ----------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-live-state-${{ github.run_id }}
          path: |
            .state/positions.json
            .state/kpi_history.csv
            .state/spec_gate_report.txt
          if-no-files-found: warn
