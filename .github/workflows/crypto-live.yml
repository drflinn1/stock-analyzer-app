name: Crypto Live (Every 15 min — LIVE)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes

concurrency:
  group: crypto-live
  cancel-in-progress: true

env:
  # --- Runtime ---
  PYTHON_VERSION: "3.11"
  DRY_RUN: "true"                       # flip to "false" only after logs look right

  # --- Picker (Balanced) ---
  DROP_PCT: "2.5"
  ENABLE_RSI: "true"
  RSI_LEN: "14"
  RSI_MAX: "35"
  CANDLES_TIMEFRAME: "15m"

  # --- Exits ---
  TAKE_PROFIT_PCT: "3.0"
  STOP_LOSS_PCT: "2.0"
  TRAIL_START_PCT: "3.0"
  TRAIL_OFFSET_PCT: "1.0"

  # --- Sizing & caps ---
  POSITION_SIZE_USD: "10"
  DAILY_SPEND_CAP_USD: "15"
  MAX_OPEN_TRADES: "3"
  MIN_BALANCE_USD: "5"

  # --- Universe ---
  SYMBOLS: "BTC/USD,ETH/USD,DOGE/USD"

jobs:
  run:
    name: Run trader (LIVE)
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Run trader
        env:
          # Kraken secrets (create in Settings → Secrets and variables → Actions)
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # Optional for DRY tests: simulate quote cash (e.g., USD)
          # SIM_BALANCE_QUOTE: "100"

          # pass-through of knobs (explicit)
          DRY_RUN: ${{ env.DRY_RUN }}
          DROP_PCT: ${{ env.DROP_PCT }}
          ENABLE_RSI: ${{ env.ENABLE_RSI }}
          RSI_LEN: ${{ env.RSI_LEN }}
          RSI_MAX: ${{ env.RSI_MAX }}
          CANDLES_TIMEFRAME: ${{ env.CANDLES_TIMEFRAME }}
          TAKE_PROFIT_PCT: ${{ env.TAKE_PROFIT_PCT }}
          STOP_LOSS_PCT: ${{ env.STOP_LOSS_PCT }}
          TRAIL_START_PCT: ${{ env.TRAIL_START_PCT }}
          TRAIL_OFFSET_PCT: ${{ env.TRAIL_OFFSET_PCT }}
          POSITION_SIZE_USD: ${{ env.POSITION_SIZE_USD }}
          DAILY_SPEND_CAP_USD: ${{ env.DAILY_SPEND_CAP_USD }}
          MAX_OPEN_TRADES: ${{ env.MAX_OPEN_TRADES }}
          MIN_BALANCE_USD: ${{ env.MIN_BALANCE_USD }}
          SYMBOLS: ${{ env.SYMBOLS }}
        run: |
          set -e
          python main.py
