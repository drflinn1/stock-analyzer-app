name: Crypto Live (Every 20 min — LIVE)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/20 * * * *"  # every 20 minutes (UTC)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      # TUNABLES
      PER_TRADE_USD: "10"
      DAILY_CAP_USD: "25"     # baseline cap; remaining is persisted across runs
      LOW_BALANCE_USD: "5"    # if free USD < this, pause buys for this run
      DROP_PCT: "2.0"
      EXCHANGE: "kraken"
      MODE: "live"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore .state cache
        uses: actions/cache/restore@v4
        with:
          path: .state
          key: state-main-${{ github.run_id }}
          restore-keys: |
            state-main-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure state folder exists
        run: mkdir -p .state

      # Load or initialize today's remaining daily cap (UTC day)
      - name: Load daily cap state
        run: |
          python - <<'PY'
          import json, os, pathlib, datetime
          p = pathlib.Path(".state/daily_cap.json")
          today = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          base_cap = float(os.environ.get("DAILY_CAP_USD", "25"))
          data = {"date": today, "remaining": base_cap}
          if p.exists():
            try:
              prior = json.loads(p.read_text())
              if prior.get("date") == today:
                data["remaining"] = float(prior.get("remaining", base_cap))
            except Exception:
              pass
          data["remaining"] = max(0.0, min(base_cap, data["remaining"]))
          p.write_text(json.dumps(data))
          print(f"Loaded remaining daily cap: {data['remaining']}")
          PY
          # expose to later steps
          REM=$(python -c "import json;print(json.load(open('.state/daily_cap.json'))['remaining'])")
          echo "DAILY_REMAINING=$REM" >> $GITHUB_ENV
          echo "::notice title=Daily Cap::Loaded remaining daily cap: $REM"

      # Low-balance soft guard WITHOUT heredocs (YAML-safe)
      - name: Apply low-balance guard (soft)
        shell: bash
        run: |
          # Read the last known FREE_USD from prior runs (if captured)
          LAST="$(grep -Eo 'FREE_USD:\s*\$?[0-9]+(\.[0-9]+)?' -h .state/last_free_usd.log 2>/dev/null | tail -1 | awk '{print $2}' | tr -d '$')"
          if [[ -n "$LAST" ]]; then
            echo "Last known FREE_USD: $LAST"
            # float compare in awk: exit 0 if LAST < LOW, else 1
            if awk -v a="$LAST" -v b="${LOW_BALANCE_USD:-5}" 'BEGIN{exit (a<b)?0:1}'; then
              echo "::warning title=Low Balance Guard::free USD < ${LOW_BALANCE_USD} — setting cap to 0 for this run (sell-only)."
              echo "DAILY_REMAINING=0" >> "$GITHUB_ENV"
            fi
          else
            echo "No prior FREE_USD reading; guard skipped this run."
          fi

      - name: MARK
        run: echo "::notice title=MARK::Crypto Live run started at $(date -u) on $GITHUB_SHA"

      - name: Run trader
        env:
          MODE: ${{ env.MODE }}
          EXCHANGE: ${{ env.EXCHANGE }}
          PER_TRADE_USD: ${{ env.PER_TRADE_USD }}
          DAILY_CAP_USD: ${{ env.DAILY_REMAINING }}   # use persisted remaining
          DROP_PCT: ${{ env.DROP_PCT }}
        run: |
          echo "=== START TRADING OUTPUT ==="
          python -V
          # Run and tee output for parsing
          python main.py 2>&1 | tee run.log
          echo "=== END TRADING OUTPUT ==="

      - name: Update daily cap state from log
        if: always()
        run: |
          # Persist the last FREE_USD seen this run (if your app prints it)
          grep -Eo 'FREE_USD:\s*\$?[0-9]+(\.[0-9]+)?' -h run.log | tail -1 >> .state/last_free_usd.log || true
          # Decrement today's remaining cap by total dollars bought this run
          python - <<'PY'
          import re, json, pathlib
          pcap = pathlib.Path(".state/daily_cap.json")
          try:
            d=json.loads(pcap.read_text())
          except Exception:
            raise SystemExit(0)
          remaining=float(d.get("remaining",0))
          spent=0.0
          with open("run.log","r",encoding="utf-8",errors="ignore") as f:
            txt=f.read()
          for m in re.finditer(r'^\s*BUY .*?~\$\s*([0-9]+(?:\.[0-9]+)?)', txt, re.M):
            spent += float(m.group(1))
          d["remaining"]= max(0.0, remaining - spent)
          pcap.write_text(json.dumps(d))
          print(f"Spent this run: ${spent:.2f} | New remaining today: ${d['remaining']:.2f}")
          PY

      - name: Save .state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .state
          key: state-main-${{ github.run_id }}
