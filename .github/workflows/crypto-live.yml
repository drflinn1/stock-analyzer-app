name: Crypto Live (Every 15 min — ROTATE + TP/SL/TRAIL)

on:
  schedule:
    - cron: '*/15 * * * *'   # every 15 minutes
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'true = simulate orders, false = place real orders'
        required: true
        default: 'true'
      USD_PER_TRADE:
        description: 'USD to spend per buy'
        required: false
        default: '15'
      RESERVE_USD:
        description: 'Keep at least this much cash unspent'
        required: false
        default: '80'
      MAX_POSITIONS:
        description: 'Max concurrent positions'
        required: false
        default: '6'

jobs:
  live:
    name: Run Crypto Bot
    runs-on: ubuntu-latest
    timeout-minutes: 12
    concurrency:
      group: crypto-live
      cancel-in-progress: false

    env:
      # -------- Exchange + creds --------
      EXCHANGE: kraken
      API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      # -------- Run mode --------
      # Manual runs can override DRY_RUN/position sizing via workflow_dispatch inputs
      DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true' }}

      # -------- Core sizing/limits --------
      USD_PER_TRADE: ${{ github.event.inputs.USD_PER_TRADE || '15' }}
      RESERVE_USD:   ${{ github.event.inputs.RESERVE_USD   || '80' }}
      MAX_POSITIONS: ${{ github.event.inputs.MAX_POSITIONS || '6' }}

      # -------- Rotation (cash-short upgrade) --------
      ROTATE_WHEN_CASH_SHORT: 'true'   # optional knob (defaults true in code, explicit here)
      ROTATE_MIN_EDGE_PCT: '2.0'       # rotate if (best - worst) momentum ≥ this %
      COOLDOWN_RUNS: '1'               # 1-run cooldown after rotating into a symbol

      # -------- Sell Guards (must include these tokens for your guard workflow) --------
      TAKE_PROFIT_PCT: '3.5'           # TAKE_PROFIT threshold (+%)
      STOP_LOSS_PCT:   '2.0'           # STOP_LOSS threshold (−%)
      TRAIL_ARM_PCT:   '1.0'           # Arm trailing after +1.0% gain
      TRAIL_PCT:       '1.5'           # TRAIL distance (%) from high watermark

      # -------- Universe --------
      SYMBOL_WHITELIST: 'BTC/USD,ETH/USD,SOL/USD,DOGE/USD,ZEC/USD,ENA/USD'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Echo config (non-secret)
        run: |
          echo "DRY_RUN=${DRY_RUN}"
          echo "USD_PER_TRADE=${USD_PER_TRADE}"
          echo "RESERVE_USD=${RESERVE_USD}"
          echo "MAX_POSITIONS=${MAX_POSITIONS}"
          echo "ROTATE_WHEN_CASH_SHORT=${ROTATE_WHEN_CASH_SHORT}"
          echo "ROTATE_MIN_EDGE_PCT=${ROTATE_MIN_EDGE_PCT}"
          echo "COOLDOWN_RUNS=${COOLDOWN_RUNS}"
          echo "TAKE_PROFIT_PCT=${TAKE_PROFIT_PCT}"
          echo "STOP_LOSS_PCT=${STOP_LOSS_PCT}"
          echo "TRAIL_ARM_PCT=${TRAIL_ARM_PCT}"
          echo "TRAIL_PCT=${TRAIL_PCT}"
          echo "SYMBOL_WHITELIST=${SYMBOL_WHITELIST}"

      - name: Run bot
        run: python main.py
