name: crypto live

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: read

jobs:
  crypto-live:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # --- Mode toggles ---
      BOT_MODE: TRADE
      DRY_RUN: "false"
      RUN_SWITCH: "on"

      # --- Broker keys (Kraken) ---
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      # --- Core trading knobs (your engine already reads these) ---
      TAKE_PROFIT: "3.5"
      STOP_LOSS: "2.0"
      TRAIL_PCT: "1.2"

      # ---------- UNIVERSE / FILTERS ----------
      # Allow both USD and USDT quotes so spec pairs aren‚Äôt dropped
      QUOTE_ALLOW: "USD,USDT"

      # Keep conservative core names but allow a SPEC tier explicitly
      CORE_WHITELIST: "BTC/USD,ETH/USD,SOL/USD,DOGE/USD"

      # Enable SPEC tier and list the three you asked for.
      # If your exchange only lists them in USDT, keep the /USDT versions.
      ALLOW_SPEC: "true"
      SPEC_SYMBOLS: "SPX/USDT,PENGU/USDT,PUMP/USDT"

      # Remove the broad blocklist that previously excluded these
      PAIR_BLOCKLIST: ""

      # Loosen spec gates just enough to allow entries, but still sane
      SPEC_MAX_SPREAD_PCT: "3.0"     # was 1.0
      SPEC_MIN_DOLLAR_VOL: "15000"   # was 25000
      SPEC_MAX_AGE_HRS: "168"        # allow up to 7 days old

      # Position sizing & caps (tune to taste)
      USD_PER_TRADE: "10"
      MAX_POSITIONS: "6"
      RESERVE_USD: "100"
      DAILY_MAX_TRADES: "6"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install ccxt pandas; fi

      - name: Confirm mode
        run: |
          echo "RUN_SWITCH=${RUN_SWITCH}"
          echo "DRY_RUN=${DRY_RUN}"
          echo "BOT_MODE=${BOT_MODE}"
          echo "QUOTE_ALLOW=${QUOTE_ALLOW}"
          echo "CORE_WHITELIST=${CORE_WHITELIST}"
          echo "SPEC_SYMBOLS=${SPEC_SYMBOLS}"
          if [ "${DRY_RUN}" = "true" ]; then
            echo "üöß DRY RUN ‚Äî NO REAL ORDERS SENT üöß"
          else
            echo "‚ö†Ô∏è LIVE MODE ‚Äî REAL ORDERS ENABLED"
          fi

      - name: Run Crypto Live
        run: |
          python -u main.py

      - name: Pack .state into zip
        run: |
          mkdir -p .state
          zip -r "state_${GITHUB_RUN_ID}.zip" .state || true

      - name: Upload state artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: state_${{ github.run_id }}
          path: "state_${{ github.run_id }}.zip"
          if-no-files-found: ignore
