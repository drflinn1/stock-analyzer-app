name: Crypto Live â€” Guarded Auto-Pick + Hot Movers Bias (LIVE)

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'true = simulate orders; false = send real orders'
        required: true
        default: 'false'
      RUN_SWITCH:
        description: 'ON to run, OFF to skip early'
        required: true
        default: 'ON'
  schedule:
    - cron: '*/15 * * * *'

jobs:
  crypto_live:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.RUN_SWITCH != 'OFF' }}
    env:
      # ---- Broker / CCXT ----
      EXCHANGE_ID: kraken
      CCXT_API_KEY: ${{ secrets.CCXT_API_KEY }}
      CCXT_API_SECRET: ${{ secrets.CCXT_API_SECRET }}
      CCXT_API_PASSWORD: ${{ secrets.CCXT_API_PASSWORD }}

      # ---- Master switches ----
      DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'false' }}   # default LIVE
      RUN_SWITCH: ${{ github.event.inputs.RUN_SWITCH || 'ON' }}

      # ---- Universe / filters ----
      WHITELIST_CSV: "BTC/USD,ETH/USD,SOL/USD,DOGE/USD,ZEC/USD"
      MAX_SPREAD_BPS: "40"           # skip if (ask-bid)/mid > 0.40%
      MAX_POSITIONS: "4"
      TOP_K: "3"                     # evaluate & consider top-K
      MIN_USD_BAL: "100"             # keep this much cash in reserve
      USD_PER_TRADE: "10"            # per-market notional
      MIN_ORDER_USD: "5"             # guard: do not place dust orders

      # ---- P&L guards ----
      MAX_DAILY_NEW_ENTRIES: "4"
      MAX_DAILY_LOSS_USD: "25"       # auto-pause if day P/L below this

      # ---- Exits / management ----
      TP_PCT: "0.035"                # 3.5% take-profit
      SL_PCT: "0.020"                # 2.0% stop-loss
      TRAIL_PCT: "0.025"             # 2.5% trailing stop

      # ---- Hot movers bias ----
      HOT_LIST: "ZEC/USD"            # add comma-separated symbols to bias
      HOT_BIAS_BPS: "50"             # +0.50% score bump for HOT_LIST names

      # ---- Files & outputs ----
      KPI_CSV: ".state/kpi_history.csv"
      STATE_DIR: ".state"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt==4.3.82

      - name: Prepare state directory and seed files
        run: |
          set -e
          mkdir -p .state
          # Seed anchors.json with non-empty JSON if file missing or empty
          if [ ! -s .state/anchors.json ]; then
            echo "{}" > .state/anchors.json
          fi
          # Seed KPI CSV with header if file missing or empty
          if [ ! -s .state/kpi_history.csv ]; then
            echo "ts,dry_run,picked,scores,hot_list,usd_free,actions" > .state/kpi_history.csv
          fi
          echo "Prepared .state contents:"
          ls -l .state

      - name: Confirm live/dry status
        run: |
          echo "RUN_SWITCH=${RUN_SWITCH}"
          echo "DRY_RUN=${DRY_RUN}"
          if [ "${RUN_SWITCH}" = "OFF" ]; then
            echo "RUN_SWITCH=OFF â†’ exiting early."; exit 0; fi
          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸš§ DRY RUN â€” NO REAL ORDERS WILL BE SENT ðŸš§"
          else
            echo "âœ… LIVE MODE â€” REAL ORDERS ENABLED"
          fi

      - name: Run Crypto Live
        env:
          PYTHONWARNINGS: "ignore"
        run: |
          python -u main.py

      - name: Upload state artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: |
            .state/**
            !.state/**/*.tmp
