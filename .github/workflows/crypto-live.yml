name: Crypto Live â€” Guarded Auto-Pick + Hot Movers Bias (LIVE + Spec ON)

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'true = simulate orders; false = send real orders'
        required: true
        default: 'false'   # default LIVE
      RUN_SWITCH:
        description: 'ON to run, OFF to skip early'
        required: true
        default: 'ON'
  schedule:
    - cron: '*/15 * * * *'

jobs:
  crypto_live:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.RUN_SWITCH != 'OFF' }}
    env:
      # ---- Broker / CCXT ----
      EXCHANGE_ID: kraken
      CCXT_API_KEY: ${{ secrets.CCXT_API_KEY }}
      CCXT_API_SECRET: ${{ secrets.CCXT_API_SECRET }}
      CCXT_API_PASSWORD: ${{ secrets.CCXT_API_PASSWORD }}

      # ---- Master switches ----
      DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'false' }}   # default LIVE
      RUN_SWITCH: ${{ github.event.inputs.RUN_SWITCH || 'ON' }}

      # ---- CORE universe / filters ----
      WHITELIST_CSV: "BTC/USD,ETH/USD,SOL/USD,DOGE/USD,ZEC/USD"
      MAX_SPREAD_BPS: "40"           # 0.40% max spread for core
      MAX_POSITIONS: "4"
      TOP_K: "3"
      MIN_USD_BAL: "100"
      USD_PER_TRADE: "10"
      MIN_ORDER_USD: "5"

      # ---- P&L guards ----
      MAX_DAILY_NEW_ENTRIES: "4"
      MAX_DAILY_LOSS_USD: "25"

      # ---- CORE exits / management ----
      TP_PCT: "0.035"                # 3.5% take-profit
      SL_PCT: "0.020"                # 2.0% stop-loss
      TRAIL_PCT: "0.025"             # 2.5% trailing stop

      # ---- Hot movers bias (core) ----
      HOT_LIST: "ZEC/USD"
      HOT_BIAS_BPS: "50"             # +0.50% score bump for HOT_LIST names

      # ---- SPECULATIVE sandbox (ON by default) ----
      SPEC_ENABLE: "ON"
      SPEC_LIST: "SPX/USD,PENGU/USD,PUMP/USD"
      SPEC_MAX_POSITIONS: "1"
      SPEC_MAX_DAILY_NEW_ENTRIES: "1"
      SPEC_USD_PER_TRADE: "5"        # smaller sizing for spec
      SPEC_MAX_SPREAD_BPS: "120"     # up to 1.20% spread allowed
      SPEC_MIN_VOL24H_USD: "3000000" # require â‰¥ $3M est. 24h USD volume
      SPEC_MIN_MOM24H_BPS: "1000"    # require â‰¥ +10% 24h momentum
      SPEC_REQUIRE_MOM15M_POS: "true" # 15m momentum must be positive
      SPEC_TP_PCT: "0.050"           # 5% TP
      SPEC_SL_PCT: "0.030"           # 3% SL
      SPEC_TRAIL_PCT: "0.030"        # 3% trailing
      SPEC_FAST_DROP_PCT: "0.040"    # kill if -4% within first 60 min
      SPEC_FAST_DROP_WINDOW_MIN: "60"

      # ---- Files & outputs ----
      KPI_CSV: ".state/kpi_history.csv"
      STATE_DIR: ".state"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt==4.3.82

      - name: Prepare state directory and seed files
        shell: bash
        run: |
          set -e
          mkdir -p .state
          [ -s .state/anchors.json ] || echo "{}" > .state/anchors.json
          [ -s .state/kpi_history.csv ] || echo "ts,dry_run,picked,scores,hot_list,usd_free,actions" > .state/kpi_history.csv
          [ -f .state/last_risk_signal.txt ] || echo "UNKNOWN" > .state/last_risk_signal.txt
          echo "Prepared .state contents:" && ls -la .state

      - name: Confirm live/dry status
        run: |
          echo "RUN_SWITCH=${RUN_SWITCH}"
          echo "DRY_RUN=${DRY_RUN}"
          if [ "${RUN_SWITCH}" = "OFF" ]; then
            echo "RUN_SWITCH=OFF â†’ exiting early."; exit 0; fi
          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸš§ DRY RUN â€” NO REAL ORDERS WILL BE SENT ðŸš§"
          else
            echo "âœ… LIVE MODE â€” REAL ORDERS ENABLED"
          fi

      - name: Run Crypto Live
        env:
          PYTHONWARNINGS: "ignore"
        run: |
          python -u main.py

      - name: Pack .state into zip
        if: always()
        run: |
          rm -f state_${{ github.run_id }}.zip
          zip -r state_${{ github.run_id }}.zip .state >/dev/null
          ls -l state_${{ github.run_id }}.zip

      - name: Upload state artifact (zip)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: state_${{ github.run_id }}.zip
          if-no-files-found: error
          retention-days: 7
