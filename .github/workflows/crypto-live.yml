# .github/workflows/crypto-live.yml
# Crypto Live â€” USD-only, TP/SL/Trailing with dry-run banner
# Balanced defaults: TP 3.5%, SL 2.0%, Trail 1.2%

name: Crypto Live (Every 15m â€” USD only + TP/SL/Trail)

on:
  schedule:
    # Every 15 minutes
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      RUN_SWITCH:
        description: "ON to allow run, OFF to skip"
        required: true
        default: "ON"
        type: choice
        options: ["ON", "OFF"]
      DRY_RUN:
        description: "true = paper (simulated), false = live orders"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      USD_PER_TRADE:
        description: "USD size per buy"
        default: "10"
        required: true
      MAX_POSITIONS:
        description: "Max concurrent positions"
        default: "3"
        required: true
      TP_PCT:
        description: "Take-profit percent (e.g., 3.5 for 3.5%)"
        default: "3.5"
        required: true
      SL_PCT:
        description: "Stop-loss percent (e.g., 2.0 for 2.0%)"
        default: "2.0"
        required: true
      TRAIL_PCT:
        description: "Trailing-stop distance percent (e.g., 1.2)"
        default: "1.2"
        required: true

permissions:
  contents: read

jobs:
  trade:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.RUN_SWITCH == 'ON' || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check RUN switch (scheduled)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: |
          if [ "${{ env.RUN_SWITCH_SCHEDULED }}" = "OFF" ]; then
            echo "RUN switch OFF for scheduled run â€” exiting cleanly." && exit 0
          fi
        env:
          RUN_SWITCH_SCHEDULED: ON  # change to OFF to pause schedule without disabling it

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install ccxt pandas numpy yfinance requests typing-extensions

      - name: Run trader
        env:
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true' }}
          RUN_SWITCH: ${{ github.event.inputs.RUN_SWITCH || 'ON' }}
          USD_PER_TRADE: ${{ github.event.inputs.USD_PER_TRADE || '10' }}
          MAX_POSITIONS: ${{ github.event.inputs.MAX_POSITIONS || '3' }}
          TP_PCT: ${{ github.event.inputs.TP_PCT || '3.5' }}
          SL_PCT: ${{ github.event.inputs.SL_PCT || '2.0' }}
          TRAIL_PCT: ${{ github.event.inputs.TRAIL_PCT || '1.2' }}
          # Exchange keys loaded from repo/org secrets when you flip DRY_RUN=false
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          mkdir -p .state
          echo "========================================================="
          echo "ðŸš§ DRY RUN â€” NO REAL ORDERS SENT ðŸš§"
          echo "========================================================="
          python main.py
