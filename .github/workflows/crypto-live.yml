name: Crypto Live â€” Every 15 min (Guarded)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "Override dry-run (ON/OFF). Leave blank to use default below."
        required: false
        default: ""
      RUN_SWITCH:
        description: "Master switch (ON/OFF). Leave blank to use default below."
        required: false
        default: ""

# Prevent overlapping 15-minute runs
concurrency:
  group: crypto-live-${{ github.ref }}
  cancel-in-progress: true

jobs:
  live:
    runs-on: ubuntu-latest

    env:
      # ===== Master switches =====
      RUN_SWITCH: ${{ inputs.RUN_SWITCH || 'ON' }}
      DRY_RUN:    ${{ inputs.DRY_RUN    || 'OFF' }}   # live by default for scheduled runs

      # ===== Night-mode sizing / risk knobs =====
      MAX_POSITIONS: "6"          # 4â€“6 is good; 6 keeps some breadth
      MAX_BUYS_PER_RUN: "1"       # keep churn low when choppy
      SL_PCT: "0.04"              # 4% hard stop
      TRAIL_PCT: "0.035"          # 3.5% trailing
      TP1_PCT: "0.05"             # take 5% profitâ€¦
      TP1_SIZE: "0.25"            # â€¦on 25% of the position
      RESERVE_CASH_PCT: "0.10"    # keep a small buffer
      DAILY_NOTIONAL_CAP_USD: "0" # 0 disables; set e.g. 500 to cap new buys for the day

      # ===== Universe / rotation (keep your existing defaults if you prefer) =====
      USD_ONLY: "true"
      WHITELIST: "BTC/USD,ETH/USD,SOL/USD,DOGE/USD"
      ROTATE_WHEN_CASH_SHORT: "true"
      ROTATE_WHEN_FULL: "false"   # optional: reduce churn during dip scalps
      DUST_MIN_USD: "2"

      # ===== Logging / misc =====
      BOT_NAME: "crypto-live"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install ccxt pandas requests yfinance
          fi

      # ---- Risk gate: read your current signal (produced by your notifier job or stored in repo state) ----
      # Looks at .state/risk_signal.txt if present; otherwise falls back to OFF.
      - name: Compute risk
        id: risk
        shell: bash
        run: |
          SIGNAL="OFF"
          if [ -f ".state/risk_signal.txt" ]; then
            RAW=$(cat .state/risk_signal.txt | tr -d '\r' | tr '[:lower:]' '[:upper:]')
            if [ "$RAW" = "ON" ] || [ "$RAW" = "OFF" ]; then
              SIGNAL="$RAW"
            fi
          fi
          echo "risk=$SIGNAL" >> "$GITHUB_OUTPUT"
          echo "Gate Summary â†’ Risk: $SIGNAL | RUN_SWITCH: ${RUN_SWITCH} | DRY_RUN: ${DRY_RUN}"

      # ---- Optional guard: skip buys if a simple daily notional cap is exceeded (bot should enforce as well) ----
      - name: Daily cap info (noop)
        if: ${{ always() }}
        run: |
          echo "DAILY_NOTIONAL_CAP_USD=${DAILY_NOTIONAL_CAP_USD} (0 means disabled; enforce inside main.py as well)"

      # ---- Run the bot (LIVE requires secrets AND DRY_RUN=OFF AND Risk=ON) ----
      - name: Run bot (main.py)
        if: ${{ env.RUN_SWITCH == 'ON' && steps.risk.outputs.risk == 'ON' }}
        env:
          # Pass Kraken API keys for live trading
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # Re-expose all envs to the process (some shells require explicit pass-through)
          RUN_SWITCH: ${{ env.RUN_SWITCH }}
          DRY_RUN: ${{ env.DRY_RUN }}
          MAX_POSITIONS: ${{ env.MAX_POSITIONS }}
          MAX_BUYS_PER_RUN: ${{ env.MAX_BUYS_PER_RUN }}
          SL_PCT: ${{ env.SL_PCT }}
          TRAIL_PCT: ${{ env.TRAIL_PCT }}
          TP1_PCT: ${{ env.TP1_PCT }}
          TP1_SIZE: ${{ env.TP1_SIZE }}
          RESERVE_CASH_PCT: ${{ env.RESERVE_CASH_PCT }}
          DAILY_NOTIONAL_CAP_USD: ${{ env.DAILY_NOTIONAL_CAP_USD }}
          USD_ONLY: ${{ env.USD_ONLY }}
          WHITELIST: ${{ env.WHITELIST }}
          ROTATE_WHEN_CASH_SHORT: ${{ env.ROTATE_WHEN_CASH_SHORT }}
          ROTATE_WHEN_FULL: ${{ env.ROTATE_WHEN_FULL }}
          DUST_MIN_USD: ${{ env.DUST_MIN_USD }}
          BOT_NAME: ${{ env.BOT_NAME }}
          PYTHONUNBUFFERED: ${{ env.PYTHONUNBUFFERED }}
        run: |
          echo "========== RUN CONFIG =========="
          echo "ðŸš§ DRY_RUN=${DRY_RUN} â€” RUN_SWITCH=${RUN_SWITCH}"
          echo "MAX_POSITIONS=${MAX_POSITIONS} â€” MAX_BUYS_PER_RUN=${MAX_BUYS_PER_RUN}"
          echo "SL=${SL_PCT} TRAIL=${TRAIL_PCT} TP1=${TP1_PCT} x ${TP1_SIZE}"
          echo "RESERVE_CASH_PCT=${RESERVE_CASH_PCT} â€” DUST_MIN_USD=${DUST_MIN_USD}"
          echo "WHITELIST=${WHITELIST} â€” USD_ONLY=${USD_ONLY}"
          echo "================================"
          python ./main.py

      # ---- If Risk is OFF (or RUN_SWITCH is OFF), we still print why we skipped ----
      - name: Skipped (risk OFF or switch OFF)
        if: ${{ !(env.RUN_SWITCH == 'ON' && steps.risk.outputs.risk == 'ON') }}
        run: |
          echo "Skipped bot run â†’ Reason:"
          echo "  RUN_SWITCH=${RUN_SWITCH}"
          echo "  Risk=${{ steps.risk.outputs.risk || 'UNKNOWN' }}"
          echo "  DRY_RUN=${DRY_RUN}"
          echo "This is expected when Risk=OFF. The moment Risk=ON, this job will execute."
