name: Crypto Live (Every 15 min — AGGRESSIVE)

on:
  workflow_dispatch:
  schedule:
    # Every 15 minutes
    - cron: "*/15 * * * *"

concurrency:
  group: crypto-live-aggressive
  cancel-in-progress: false

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # ===== Core run mode =====
      MODE: "live"
      DRY_RUN: "false"                  # real orders
      EXCHANGE: "kraken"
      BASE_CCY: "USD"

      # ===== Universe (auto + ranking) =====
      AUTO_UNIVERSE: "true"             # scan exchange for USD/USDT spot pairs
      UNIVERSE_TOP_N: "20"              # take strongest top-N after ranking
      MIN_LIQ_USD_24H: "200000"         # drop illiquid tickers
      MOMENTUM_LOOKBACK_H: "24"         # recent momentum window (hours)
      MIN_PRICE_USD: "0.01"             # skip dust
      MIN_NOTIONAL_USD: "5"             # exchange min order size guard

      # ===== Multi-timeframe confirmation (pro-style) =====
      # Trade only when 15m trend agrees with 1h trend (filters chop, keeps strong moves)
      TF_FAST: "15m"
      TF_SLOW: "1h"
      EMA_SHORT: "20"
      EMA_LONG: "50"
      RSI_LEN: "14"
      RSI_BUY: "55"                     # aggressive: require mild strength to buy
      RSI_SELL: "45"

      # ===== Volatility-scaled position sizing (ATR-based) =====
      ATR_LEN: "14"
      # Target risk per trade as % of equity. Position size computed as:
      # size_notional = min(PER_TRADE_USD_CAP, risk_pct * equity / ATR_units_of_risk)
      RISK_PER_TRADE_PCT: "1.0"         # 1% of equity risk per trade (aggressive)
      PER_TRADE_USD_CAP: "40"           # ceiling per trade (still caps outliers)
      MAX_TRADES_PER_RUN: "10"          # aggressive fan-out per scan
      MAX_CONCURRENT_POS: "16"          # allow many small, diversified positions
      PORTFOLIO_MAX_EXPOSURE_PCT: "80"  # cap total notional exposure vs equity

      # ===== Exits: ATR take-profit + trailing stop + fail-safe stop =====
      # Tighter multipliers -> faster profit taking and higher churn (snowball bias)
      ATR_MULTIPLIER_TP: "1.2"          # realize quicker gains to recycle capital
      ATR_MULTIPLIER_TS: "1.6"          # trail winners reasonably close
      ATR_MULTIPLIER_SL: "2.4"          # fail-safe hard stop (still protects downside)
      TRAIL_ACTIVATE_AT_TP_FRAC: "0.6"  # start trailing after 60% of TP is reached

      # ===== Budgeting / “don’t go broke” rails =====
      DAILY_CAP_USD: "200"              # allow more trading throughput per day
      MIN_FREE_CASH_USD: "25"           # don’t place new orders if under this
      SLIPPAGE_PCT: "0.10"              # 10 bps slippage budget per order

      # ===== Drawdown circuit breaker =====
      # If equity falls X% from its all-time-high, pause new entries for N runs
      DRAWDOWN_PCT_TRIP: "12"           # aggressive risk; still has a fuse
      DRAWDOWN_COOLDOWN_RUNS: "8"

      # ===== Logging / telemetry =====
      LOG_LEVEL: "INFO"
      WRITE_EQUITY_CSV: "true"          # appends data/equity_history.csv
      PRINT_EQUITY_ONE_LINER: "true"    # "[equity] now=$... Δrun=... HWM=... DD=..."

      # ===== Exchange credentials (from repo or org secrets) =====
      KRAKEN_API_KEY: "${{ secrets.KRAKEN_API_KEY }}"
      KRAKEN_API_SECRET: "${{ secrets.KRAKEN_API_SECRET }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install ccxt pandas numpy ta; fi

      - name: Run trader
        id: run_trader
        env:
          # pass-through in case your code expects these names exactly
          DRY_RUN: ${{ env.DRY_RUN }}
          EXCHANGE: ${{ env.EXCHANGE }}
          BASE_CCY: ${{ env.BASE_CCY }}

          AUTO_UNIVERSE: ${{ env.AUTO_UNIVERSE }}
          UNIVERSE_TOP_N: ${{ env.UNIVERSE_TOP_N }}
          MIN_LIQ_USD_24H: ${{ env.MIN_LIQ_USD_24H }}
          MOMENTUM_LOOKBACK_H: ${{ env.MOMENTUM_LOOKBACK_H }}
          MIN_PRICE_USD: ${{ env.MIN_PRICE_USD }}
          MIN_NOTIONAL_USD: ${{ env.MIN_NOTIONAL_USD }}

          TF_FAST: ${{ env.TF_FAST }}
          TF_SLOW: ${{ env.TF_SLOW }}
          EMA_SHORT: ${{ env.EMA_SHORT }}
          EMA_LONG: ${{ env.EMA_LONG }}
          RSI_LEN: ${{ env.RSI_LEN }}
          RSI_BUY: ${{ env.RSI_BUY }}
          RSI_SELL: ${{ env.RSI_SELL }}

          ATR_LEN: ${{ env.ATR_LEN }}
          RISK_PER_TRADE_PCT: ${{ env.RISK_PER_TRADE_PCT }}
          PER_TRADE_USD_CAP: ${{ env.PER_TRADE_USD_CAP }}
          MAX_TRADES_PER_RUN: ${{ env.MAX_TRADES_PER_RUN }}
          MAX_CONCURRENT_POS: ${{ env.MAX_CONCURRENT_POS }}
          PORTFOLIO_MAX_EXPOSURE_PCT: ${{ env.PORTFOLIO_MAX_EXPOSURE_PCT }}

          ATR_MULTIPLIER_TP: ${{ env.ATR_MULTIPLIER_TP }}
          ATR_MULTIPLIER_TS: ${{ env.ATR_MULTIPLIER_TS }}
          ATR_MULTIPLIER_SL: ${{ env.ATR_MULTIPLIER_SL }}
          TRAIL_ACTIVATE_AT_TP_FRAC: ${{ env.TRAIL_ACTIVATE_AT_TP_FRAC }}

          DAILY_CAP_USD: ${{ env.DAILY_CAP_USD }}
          MIN_FREE_CASH_USD: ${{ env.MIN_FREE_CASH_USD }}
          SLIPPAGE_PCT: ${{ env.SLIPPAGE_PCT }}

          DRAWDOWN_PCT_TRIP: ${{ env.DRAWDOWN_PCT_TRIP }}
          DRAWDOWN_COOLDOWN_RUNS: ${{ env.DRAWDOWN_COOLDOWN_RUNS }}

          LOG_LEVEL: ${{ env.LOG_LEVEL }}
          WRITE_EQUITY_CSV: ${{ env.WRITE_EQUITY_CSV }}
          PRINT_EQUITY_ONE_LINER: ${{ env.PRINT_EQUITY_ONE_LINER }}
        run: |
          python -u main.py

      - name: Upload equity history (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: equity_history
          path: data/equity_history.csv
          if-no-files-found: ignore
