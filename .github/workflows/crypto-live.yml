name: Crypto â€” Live (single-file, PYTHONPATH fix)

on:
  schedule:
    # Every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: crypto-live-main
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
      # Shallow checkout is fine; we don't need history
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure .state exists
        run: |
          mkdir -p .state

      - name: Install dependencies (requirements.txt or safe defaults)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            python -m pip install --upgrade pip
            # Core libs your scripts have used across runs
            pip install requests pandas numpy pyyaml matplotlib
          fi

      - name: Echo key runtime vars (safe)
        run: |
          echo "Branch: $GITHUB_REF_NAME"
          echo "Repo:   $GITHUB_REPOSITORY"
          echo "----- Variables (non-secret) -----"
          echo "DRY_RUN=${{ vars.DRY_RUN }}"
          echo "BUY_USD=${{ vars.BUY_USD }}"
          echo "MIN_BUY_USD=${{ vars.MIN_BUY_USD }}"
          echo "MAX_POSITIONS=${{ vars.MAX_POSITIONS }}"
          echo "UNIVERSE_PICK='${{ vars.UNIVERSE_PICK }}'"
          echo "TP_PCT=${{ vars.TP_PCT }}"
          echo "SL_PCT=${{ vars.SL_PCT }}"
          echo "TRAIL_PCT=${{ vars.TRAIL_PCT }}"
          echo "WINDOW_MIN=${{ vars.WINDOW_MIN }}"
          echo "----------------------------------"
          # Create a tiny run flag so we can see this job touched .state
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .state/last_job_start_utc.txt

      - name: Run main.py (module-safe: expose repo on PYTHONPATH)
        env:
          # Secrets (never echoed)
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # Vars (ok to be empty; script should default sanely)
          DRY_RUN: ${{ vars.DRY_RUN }}
          BUY_USD: ${{ vars.BUY_USD }}
          MIN_BUY_USD: ${{ vars.MIN_BUY_USD }}
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK }}
          TP_PCT: ${{ vars.TP_PCT }}
          SL_PCT: ${{ vars.SL_PCT }}
          TRAIL_PCT: ${{ vars.TRAIL_PCT }}
          WINDOW_MIN: ${{ vars.WINDOW_MIN }}
        run: |
          set -e
          echo "ðŸ”¹ Running Crypto Live main..."
          # Critical fix: make 'trader' package importable
          export PYTHONPATH="${{ github.workspace }}"
          # Sensible fallbacks if some vars are blank (keeps things moving)
          : "${DRY_RUN:=ON}"
          : "${TP_PCT:=8}"          # default 8% take-profit if not set
          : "${WINDOW_MIN:=30}"     # 30-min rotation window
          python3 trader/main.py

      - name: Show .state snapshot
        if: always()
        run: |
          echo "Files in .state:"
          ls -alh .state || true
          echo "positions.json (if present):"
          [ -f .state/positions.json ] && cat .state/positions.json || echo "no positions.json"
          echo "run_summary.json (if present):"
          [ -f .state/run_summary.json ] && cat .state/run_summary.json || echo "no run_summary.json"

      - name: Upload .state artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-live-state_${{ github.run_id }}
          path: .state
          if-no-files-found: warn

      - name: Final cleanup
        if: always()
        run: |
          echo "âœ… Job complete."
