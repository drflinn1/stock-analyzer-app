name: Crypto Live â€” every 15m

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt pandas

      - name: Run Crypto Engine
        env:
          EXCHANGE_ID: kraken
          CCXT_API_KEY: ${{ secrets.CCXT_API_KEY }}
          CCXT_API_SECRET: ${{ secrets.CCXT_API_SECRET }}
          CCXT_API_PASSWORD: ${{ secrets.CCXT_API_PASSWORD }}
          DRY_RUN: "true"
        run: |
          python - << 'PY'
          import importlib
          try:
            mod = importlib.import_module("trader.crypto_engine")
          except Exception as e:
            raise SystemExit(f"Failed to import trader.crypto_engine: {e}")
          if hasattr(mod, "main"):
            mod.main()
          PY

      # === KPI log helper that prints RISK SIGNAL ===
      - name: Risk Signal (log only)
        env:
          EXCHANGE_ID: kraken
        run: |
          python -m trader.risk_signal

      # === NEW: After-run snapshot (positions + recent trades) ===
      - name: After-Run Snapshot (positions + recent trades)
        env:
          EXCHANGE_ID: kraken
          CCXT_API_KEY: ${{ secrets.CCXT_API_KEY }}
          CCXT_API_SECRET: ${{ secrets.CCXT_API_SECRET }}
          CCXT_API_PASSWORD: ${{ secrets.CCXT_API_PASSWORD }}
        run: |
          python -m trader.afterrun_snapshot
