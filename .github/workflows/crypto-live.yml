name: Crypto Live â€” Mean Revert (every 5m)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "Dry run (no orders)"
        required: true
        default: "true"
        type: choice
        options: ["true","false"]
      TOP_K:
        description: "Scan top-K oversold"
        required: true
        default: "6"
        type: string
      USD_PER_TRADE:
        description: "USD budget per BUY"
        required: true
        default: "15"
        type: string
      MIN_COST_PER_ORDER:
        description: "Exchange min notional per order"
        required: true
        default: "5.0"
        type: string
      RESERVE_CASH_USD:
        description: "Keep at least this USD"
        required: true
        default: "25"
        type: string
      MAX_SPREAD_BPS:
        description: "Skip markets wider than this (bps)"
        required: true
        default: "150"
        type: string
      MIN_QUOTE_VOL_USD:
        description: "Filter out thin markets (24h quote vol)"
        required: true
        default: "10000"
        type: string
      WHY_NOT_LOGS:
        description: "Verbose reject reasons"
        required: true
        default: "true"
        type: choice
        options: ["true","false"]

permissions:
  contents: read

concurrency:
  group: crypto-live-meanrevert
  cancel-in-progress: false

jobs:
  run:
    name: Run Crypto Bot (mean-revert)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Check Kraken secrets
        shell: bash
        run: |
          if [[ -z "${{ secrets.KRAKEN_API_KEY }}" || -z "${{ secrets.KRAKEN_API_SECRET }}" ]]; then
            echo "::error title=Missing Kraken Secrets::Add KRAKEN_API_KEY and KRAKEN_API_SECRET in repo settings."
            exit 1
          fi
          echo "Kraken secrets detected."

      - name: Echo config (non-secret)
        run: |
          echo "DRY_RUN=${{ inputs.DRY_RUN || 'true' }}"
          echo "TOP_K=${{ inputs.TOP_K || '6' }}"
          echo "USD_PER_TRADE=${{ inputs.USD_PER_TRADE || '15' }}"
          echo "MIN_COST_PER_ORDER=${{ inputs.MIN_COST_PER_ORDER || '5.0' }}"
          echo "RESERVE_CASH_USD=${{ inputs.RESERVE_CASH_USD || '25' }}"
          echo "MAX_SPREAD_BPS=${{ inputs.MAX_SPREAD_BPS || '150' }}"
          echo "MIN_QUOTE_VOL_USD=${{ inputs.MIN_QUOTE_VOL_USD || '10000' }}"
          echo "WHY_NOT_LOGS=${{ inputs.WHY_NOT_LOGS || 'true' }}"
          echo "--- Fixed params ---"
          echo "TIMEFRAME=15m RSI_LEN=14 VWAP_BARS=20 OVERSOLD_RSI=35"
          echo "TP=0.02 SL=0.01 TRAIL=0.007"
          echo "ATOMIC_ROTATION=true ROTATE_WHEN_FULL=true"
          echo "SELL_EPS=0.995 BUY_EPS=0.995 DUST_IGNORE_BELOW_USD=1.00"
          echo "UNIVERSE='' IGNORE_TICKERS='USDT,USDC,USD,EUR,GBP'"

      - name: Run bot
        env:
          EXCHANGE: kraken
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # dispatch-controlled
          DRY_RUN: ${{ inputs.DRY_RUN || 'true' }}
          TOP_K: ${{ inputs.TOP_K || '6' }}
          USD_PER_TRADE: ${{ inputs.USD_PER_TRADE || '15' }}
          MIN_COST_PER_ORDER: ${{ inputs.MIN_COST_PER_ORDER || '5.0' }}
          RESERVE_CASH_USD: ${{ inputs.RESERVE_CASH_USD || '25' }}
          MAX_SPREAD_BPS: ${{ inputs.MAX_SPREAD_BPS || '150' }}
          MIN_QUOTE_VOL_USD: ${{ inputs.MIN_QUOTE_VOL_USD || '10000' }}
          WHY_NOT_LOGS: ${{ inputs.WHY_NOT_LOGS || 'true' }}

          # fixed defaults (tune here)
          TIMEFRAME: "15m"
          RSI_LEN: "14"
          VWAP_BARS: "20"
          OVERSOLD_RSI: "35"

          TAKE_PROFIT_PCT: "0.02"
          STOP_LOSS_PCT: "0.01"
          TRAILING_STOP_PCT: "0.007"

          ATOMIC_ROTATION: "true"
          ROTATE_WHEN_FULL: "true"

          SELL_EPS: "0.995"
          BUY_EPS: "0.995"
          DUST_IGNORE_BELOW_USD: "1.00"

          UNIVERSE: ""
          IGNORE_TICKERS: "USDT,USDC,USD,EUR,GBP"
        run: |
          python main.py
