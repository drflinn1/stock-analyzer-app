name: Crypto Live (Every 15 min — LIVE)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes

concurrency:
  group: crypto-live
  cancel-in-progress: true

env:
  # --- Runtime ---
  PYTHON_VERSION: "3.11"
  DRY_RUN: "true"                    # flip to "false" only after you confirm logs look right
  
  # --- Picker (Balanced) ---
  DROP_PCT: "2.5"
  ENABLE_RSI: "true"
  RSI_LEN: "14"
  RSI_MAX: "35"

  # --- Fixed Take-Profit / Stop-Loss (used by main.py) ---
  TAKE_PROFIT_PCT: "3.0"             # +3% take-profit
  STOP_LOSS_PCT: "2.0"               # -2% stop-loss

  # --- Trailing Profit add-on (used by main.py) ---
  TRAIL_START_PCT: "3.0"             # start trailing once PnL ≥ +3%
  TRAIL_OFFSET_PCT: "1.0"            # exit if drawdown from peak ≥ 1%

  # --- Buy controls (still honored even with buys disabled in code) ---
  POSITION_SIZE_USD: "10"
  DAILY_SPEND_CAP_USD: "15"
  MAX_OPEN_TRADES: "3"
  MIN_BALANCE_USD: "5"

  # --- Universe (if/when you re-enable buys) ---
  SYMBOLS: "BTC/USD,ETH/USD,DOGE/USD"

jobs:
  run:
    name: Run trader (LIVE)
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ccxt

      - name: Run trader
        env:
          # Needed for balances / live orders (prices work without keys).
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          # Pass through all env for clarity (optional, but explicit):
          DRY_RUN: ${{ env.DRY_RUN }}
          TAKE_PROFIT_PCT: ${{ env.TAKE_PROFIT_PCT }}
          STOP_LOSS_PCT: ${{ env.STOP_LOSS_PCT }}
          TRAIL_START_PCT: ${{ env.TRAIL_START_PCT }}
          TRAIL_OFFSET_PCT: ${{ env.TRAIL_OFFSET_PCT }}
          POSITION_SIZE_USD: ${{ env.POSITION_SIZE_USD }}
          DAILY_SPEND_CAP_USD: ${{ env.DAILY_SPEND_CAP_USD }}
          MAX_OPEN_TRADES: ${{ env.MAX_OPEN_TRADES }}
          MIN_BALANCE_USD: ${{ env.MIN_BALANCE_USD }}
          SYMBOLS: ${{ env.SYMBOLS }}
        run: |
          set -e
          python main.py
