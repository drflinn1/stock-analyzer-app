name: Crypto — Live Safe (single-file)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: crypto-live-safe
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure .state exists (seed a file so artifact is never empty)
        run: |
          mkdir -p .state
          echo "ok $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > .state/_keep.txt

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas numpy pyyaml matplotlib
          fi

      - name: Echo env (raw; defaults handled in script)
        run: |
          echo "DRY_RUN=${{ vars.DRY_RUN }}"
          echo "BUY_USD=${{ vars.BUY_USD }}"
          echo "MIN_BUY_USD=${{ vars.MIN_BUY_USD }}"
          echo "MAX_POSITIONS=${{ vars.MAX_POSITIONS }}"
          echo "UNIVERSE_PICK='${{ vars.UNIVERSE_PICK }}'"
          echo "TP_PCT=${{ vars.TP_PCT }}"
          echo "SL_PCT=${{ vars.SL_PCT }}"
          echo "TRAIL_PCT=${{ vars.TRAIL_PCT }}"
          echo "WINDOW_MIN=${{ vars.WINDOW_MIN }}"

      - name: Run bot (single-file)
        env:
          # Secrets
          KRAKEN_API_KEY:    ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          # Vars (may be empty; crypto_live_safe.py applies sane defaults)
          DRY_RUN:       ${{ vars.DRY_RUN }}
          BUY_USD:       ${{ vars.BUY_USD }}
          MIN_BUY_USD:   ${{ vars.MIN_BUY_USD }}
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK }}
          TP_PCT:        ${{ vars.TP_PCT }}
          SL_PCT:        ${{ vars.SL_PCT }}
          TRAIL_PCT:     ${{ vars.TRAIL_PCT }}
          WINDOW_MIN:    ${{ vars.WINDOW_MIN }}
        run: |
          set -e
          python -u crypto_live_safe.py
          # Ensure a summary exists for the artifact
          [ -f .state/run_summary.json ] || echo '{"result":"ok"}' > .state/run_summary.json

      - name: Show state
        if: always()
        run: |
          echo "----- .state listing -----"
          ls -alh .state || true
          echo "----- positions.json -----"
          [ -f .state/positions.json ] && cat .state/positions.json || echo "none"
          echo "----- run_summary.json ----"
          [ -f .state/run_summary.json ] && cat .state/run_summary.json || echo "none"

      - name: Upload state (no warning)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-live-state_${{ github.run_number }}
          path: .state
          if-no-files-found: ignore
          retention-days: 7

      - name: Done
        if: always()
        run: echo "✅ Completed $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
