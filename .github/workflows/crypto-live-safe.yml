name: Crypto â€” Live Safe (single-file)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DRY_RUN: "${{ vars.DRY_RUN || 'ON' }}"
      BUY_USD: "${{ vars.BUY_USD || '30' }}"
      TP_PCT: "${{ vars.TP_PCT || '8' }}"
      STOP_PCT: "${{ vars.STOP_PCT || '4' }}"
      ROTATE_WHEN_FULL: "${{ vars.ROTATE_WHEN_FULL || 'false' }}"
      UNIVERSE_PICK: "${{ vars.UNIVERSE_PICK || 'LSK' }}"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install deps
        run: pip install requests
      - name: Ensure .state
        run: mkdir -p .state
      - name: Echo env
        run: |
          echo "DRY_RUN=$DRY_RUN  BUY_USD=$BUY_USD  TP=$TP_PCT  STOP=$STOP_PCT  ROTATE=$ROTATE_WHEN_FULL  PICK='$UNIVERSE_PICK'"
      - name: Run bot (single-file)
        env:
          KRAKEN_KEY: ${{ secrets.KRAKEN_KEY }}
          KRAKEN_SECRET: ${{ secrets.KRAKEN_SECRET }}
        run: python -u crypto_live_safe.py
      - name: Show state
        if: always()
        run: |
          ls -alh .state || true
          [[ -f .state/run_summary.json ]] && cat .state/run_summary.json || true
      - name: Upload state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state_${{ github.run_id }}
          path: .state/**
