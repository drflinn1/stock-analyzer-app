name: üî¥ Crypto Live ‚Äî SAFE (manual $10 test)

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'ON = simulate, OFF = live'
        required: false
        default: 'OFF'

env:
  # ---- Force conservative test defaults ----
  RUN_SWITCH: "ON"
  DRY_RUN: ${{ inputs.DRY_RUN || 'OFF' }}

  # One tiny buy only
  MIN_BUY_USD: "10"
  MAX_BUYS_PER_RUN: "1"
  MAX_POSITIONS: "1"

  # Guards (will be overridden by baseline file if present)
  UNIVERSE_TOP_K: "25"
  RESERVE_CASH_PCT: "5"
  ROTATE_WHEN_FULL: "false"
  ROTATE_WHEN_CASH_SHORT: "true"
  MIN_SELL_USD: "10"
  DUST_MIN_USD: "2"
  DUST_SKIP_STABLES: "true"

  # Secrets
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
  KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

jobs:
  live_safe:
    name: ‚ñ∂Ô∏è Run SAFE manual test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      # <<< NEW: auto-load baseline guard-pack if .state/baseline_config.json exists >>>
      - name: üîΩ Load baseline guard-pack (if present)
        if: ${{ hashFiles('.state/baseline_config.json') != '' }}
        run: |
          echo "Loading guards from .state/baseline_config.json ..."
          python - <<'PY'
import json, os
p = '.state/baseline_config.json'
with open(p, 'r', encoding='utf-8') as f:
    data = json.load(f)
guards = (data.get('guards') or {})
env_path = os.environ['GITHUB_ENV']
with open(env_path, 'a', encoding='utf-8') as env:
    for k in [
        'UNIVERSE_TOP_K','MAX_POSITIONS','MAX_BUYS_PER_RUN',
        'ROTATE_WHEN_FULL','ROTATE_WHEN_CASH_SHORT','RESERVE_CASH_PCT',
        'MIN_SELL_USD','DUST_MIN_USD','DUST_SKIP_STABLES'
    ]:
        v = guards.get(k)
        if isinstance(v, bool):
            v = str(v).lower()
        env.write(f"{k}={v}\n")
print("Baseline guards loaded into env.")
PY

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ü§ñ Run Crypto Bot (SAFE)
        env:
          MODE: "CRYPTO"
        run: |
          echo "DRY_RUN=${DRY_RUN}  MIN_BUY_USD=${MIN_BUY_USD}  MAX_BUYS_PER_RUN=${MAX_BUYS_PER_RUN}  MAX_POSITIONS=${MAX_POSITIONS}"
          python main.py

      - name: üìä Make KPI chart (optional)
        run: |
          mkdir -p .state
          python tools/make_kpi_chart.py || true

      - name: üì§ Upload artifacts (.state)
        uses: actions/upload-artifact@v4
        with:
          name: crypto-live-safe-state
          path: .state

      - name: üì° Slack Notify (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          msg="SAFE run finished. DRY_RUN=${DRY_RUN} | MAX_BUYS_PER_RUN=${MAX_BUYS_PER_RUN} | MAX_POSITIONS=${MAX_POSITIONS}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$msg\"}" \
            $SLACK_WEBHOOK_URL
