name: Kraken — Key Sanity Check (on demand)

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Call Kraken /0/private/Balance
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          python - << 'PY'
          import os, time, base64, hashlib, hmac, urllib.parse, requests
          key = os.getenv("KRAKEN_API_KEY","").strip()
          sec = os.getenv("KRAKEN_API_SECRET","").strip()
          assert key and sec, "Missing KRAKEN secrets"

          url = "https://api.kraken.com/0/private/Balance"
          nonce = str(int(time.time()*1000))
          data = {"nonce": nonce}
          postdata = urllib.parse.urlencode(data)
          message = (nonce + postdata).encode()
          sha256 = hashlib.sha256(message).digest()
          mac = hmac.new(base64.b64decode(sec), b"/0/private/Balance"+sha256, hashlib.sha512)
          signature = base64.b64encode(mac.digest())
          headers = {"API-Key": key, "API-Sign": signature.decode()}
          r = requests.post(url, headers=headers, data=data, timeout=20)
          print("HTTP", r.status_code)
          print("RAW:", r.text)
          j = r.json()
          if j.get("error"):
            raise SystemExit("Kraken error: " + "; ".join(j["error"]))
          bal = j.get("result", {})
          print("✅ Balance OK. USD:", bal.get("ZUSD") or bal.get("USD") or bal)
          PY
