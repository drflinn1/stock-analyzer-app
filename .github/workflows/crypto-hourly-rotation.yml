name: Crypto â€” Hourly 1-Coin Rotation

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15m
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "ON = simulate, OFF = live"
        required: false
        default: "ON"
      UNIVERSE:
        description: "Comma symbols (BTC,ETH,SOL,...)"
        required: false
      MIN_BUY_USD:
        description: "Ticket size in USD"
        required: false
        default: "25"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      contents: read
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Hourly Rotation (DRY-RUN safe)
        env:
          DRY_RUN: ${{ inputs.DRY_RUN || vars.DRY_RUN || 'ON' }}
          UNIVERSE: ${{ inputs.UNIVERSE || vars.UNIVERSE || 'BTC,ETH,SOL' }}
          MIN_BUY_USD: ${{ inputs.MIN_BUY_USD || vars.MIN_BUY_USD || '25' }}
          FEE_BPS: ${{ vars.FEE_BPS || '10' }}
          RISK_ON: ${{ vars.RISK_ON || '1' }}
          RISK_THRESH_BTC_60M: ${{ vars.RISK_THRESH_BTC_60M || '-0.005' }}
          QUOTE: ${{ vars.QUOTE || 'USD' }}
          STATE_DIR: .state
        run: |
          python -V
          python main.py
          echo "---- run_summary.md ----"
          cat .state/run_summary.md || true

      - name: Upload artifacts (.state)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hourly-rotation-state
          path: .state/
          if-no-files-found: warn
