name: Crypto — 1-Coin Rotation (15m, TP 8%)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # ---- defaults (UI can override with Variables/Secrets) ----
      DRY_RUN: "${{ vars.DRY_RUN || 'OFF' }}"
      BUY_USD: "${{ vars.BUY_USD || '30' }}"
      TP_PCT:  "${{ vars.TP_PCT  || '8'  }}"
      STOP_PCT: "${{ vars.STOP_PCT || '4' }}"
      WINDOW_MIN: "${{ vars.WINDOW_MIN || '15' }}"
      ROTATE_WHEN_FULL: "${{ vars.ROTATE_WHEN_FULL || 'true' }}"
      UNIVERSE_PICK: "${{ vars.UNIVERSE_PICK || '' }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (lightweight fallback if no requirements.txt)
        run: |
          if [[ -f requirements.txt ]]; then
            python -m pip install -U pip
            pip install -r requirements.txt
          else
            pip install requests
          fi

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Echo critical env/vars
        run: |
          echo "DRY_RUN   = $DRY_RUN"
          echo "BUY_USD   = $BUY_USD"
          echo "TP_PCT    = $TP_PCT"
          echo "STOP_PCT  = $STOP_PCT"
          echo "WINDOW_MIN= $WINDOW_MIN"
          echo "ROTATE_WHEN_FULL = $ROTATE_WHEN_FULL"
          echo "UNIVERSE_PICK    = '${UNIVERSE_PICK}'"

      # NEW: soft backstop — if candidates are missing or empty, refresh them.
      - name: Ensure candidates (quick refresh if missing/empty)
        run: |
          need=0
          if [[ ! -s ".state/momentum_candidates.csv" ]]; then
            need=1
          else
            # make sure it has at least one non-header line
            lines=$(wc -l < .state/momentum_candidates.csv || echo 0)
            [[ "$lines" -lt 2 ]] && need=1 || true
          fi

          if [[ "$need" -eq 1 ]]; then
            echo "[INFO] candidates missing/empty → refreshing via trader/momentum_scan.py"
            python -u trader/momentum_scan.py || echo "[WARN] refresh failed; proceeding anyway (bot will HOLD on quote miss)."
          else
            echo "[INFO] candidates present."
          fi

      # OLD step used to bail – replaced by a soft log-only check.
      - name: Soft check (log-only)
        run: |
          if [[ ! -s ".state/momentum_candidates.csv" ]]; then
            echo "[WARN] No candidates available. main.py will decide to HOLD."
          fi

      - name: Show state pre-run (glob)
        run: |
          echo "---- .state contents ----"
          ls -alh .state || true

      - name: Run bot
        env:
          # pass through secrets if your main.py uses them
          KRAKEN_KEY: ${{ secrets.KRAKEN_KEY }}
          KRAKEN_SECRET: ${{ secrets.KRAKEN_SECRET }}
        run: |
          set -e
          python -u main.py

      - name: Show state after run (glob)
        if: always()
        run: |
          echo "---- .state contents ----"
          ls -alh .state || true

      - name: Upload .state manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation_state_${{ github.run_id }}
          path: |
            .state/**/*
            !.state/*.lock

      - name: Post Set up Python
        if: always()
        run: echo " "

      - name: Post Checkout
        if: always()
        run: echo " "

