name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"   # run hourly (UTC)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      # --- Run your bot (uses repo Variables/Secrets as your code already does) ---
      - name: Run crypto bot
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python main.py

      # --- Always write a summary, even if the bot step failed ---
      - name: Write run summary
        if: always()
        run: |
          python - << 'PY'
          from pathlib import Path
          import json, datetime as dt

          STATE = Path(".state")
          STATE.mkdir(parents=True, exist_ok=True)

          pos_file = STATE / "position.json"
          summary_json = STATE / "run_summary.json"
          summary_md   = STATE / "run_summary.md"

          now = dt.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          summary = {
              "when": now,
              "status": "FLAT",
              "note": "No open position",
              "position": None,
          }

          if pos_file.exists():
              try:
                  pos = json.loads(pos_file.read_text() or "{}")
                  summary["status"] = "HOLD"
                  summary["note"] = "Tracking current position"
                  summary["position"] = {
                      "symbol": pos.get("symbol"),
                      "qty": pos.get("qty"),
                      "entry_price": pos.get("entry_price"),
                      "since": pos.get("since"),
                      "last_price": pos.get("last_price"),
                      "change_pct": pos.get("change_pct"),
                  }
              except Exception as e:
                  summary["status"] = "UNKNOWN"
                  summary["note"] = f"position.json parse error: {e}"

          summary_json.write_text(json.dumps(summary, indent=2))

          lines = [
              f"**When:** {summary['when']}",
              f"**Status:** {summary['status']}",
              f"**Note:** {summary['note']}",
          ]
          if summary["position"]:
              p = summary["position"]
              lines += [
                  "",
                  "### Position",
                  f"- **Symbol:** {p.get('symbol')}",
                  f"- **Qty:** {p.get('qty')}",
                  f"- **Entry:** {p.get('entry_price')}",
                  f"- **Last Price:** {p.get('last_price')}",
                  f"- **Change %:** {p.get('change_pct')}",
                  f"- **Since:** {p.get('since')}",
              ]
          summary_md.write_text("\n".join(lines))
          print(f"Wrote {summary_json} and {summary_md}")
          PY

      # --- Upload .state AFTER the summary is written ---
      - name: Upload .state as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: ./.state/**          # picks up run_summary.* and any position files
          if-no-files-found: warn
          retention-days: 7
