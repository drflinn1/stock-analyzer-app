name: Crypto - 1-Coin Rotation (LIVE-ready, ultra-defensive, 15m)

on:
  schedule:
    - cron: "*/15 * * * *"     # keep 15-minute cadence
  workflow_dispatch:

# Avoid overlapping runs of this job
concurrency:
  group: crypto-1coin-rotation
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Preflight — echo vars & ensure .state
        run: |
          set -e
          mkdir -p .state
          echo "=== Runtime Vars ==="
          echo "DRY_RUN=${{ github.event.inputs.DRY_RUN || env.DRY_RUN || 'ON' }}"
          echo "TP_PCT=${TP_PCT:=5}"
          echo "STOP_PCT=${STOP_PCT:=1}"
          echo "SLOW_MIN_PCT=${SLOW_MIN_PCT:=3}"
          echo "WINDOW_MIN=${WINDOW_MIN:=30}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK}"
          echo "=== ls -la .state (before) ==="
          ls -la .state || true

      - name: Run main.py (bot)
        run: |
          set -e
          python main.py

      # Safety net so artifacts always exist even on HOLD/ERROR runs
      - name: Always write summary + placeholder position if missing
        run: |
          set -e
          mkdir -p .state
          if [ ! -f ".state/run_summary.md" ]; then
            {
              echo "**When:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo "**DRY_RUN:** ${DRY_RUN:-ON}"
              echo "**TP_PCT:** ${TP_PCT:-5} | **STOP_PCT:** ${STOP_PCT:-1} | **SLOW_MIN_PCT:** ${SLOW_MIN_PCT:-3} | **WINDOW_MIN:** ${WINDOW_MIN:-30}"
              echo "**Note:** Auto-generated summary because the bot didn’t emit one this run."
            } > .state/run_summary.md
          fi
          if [ ! -f ".state/position.json" ]; then
            printf '{"symbol":null,"qty":0,"avg_price":0,"in_position_since":null}\n' > .state/position.json
          fi
          echo "=== ls -la .state (after) ==="
          ls -la .state

      - name: Upload .state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: .state/**
          if-no-files-found: warn
