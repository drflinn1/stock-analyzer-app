name: Crypto — Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"   # every hour UTC
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pyyaml matplotlib || true

      # ---------------------------------------------------------
      # Preflight check: enforce 1-coin rotation + auto-universe,
      # and guarantee a .state summary for artifact upload.
      # ---------------------------------------------------------
      - name: Preflight (enforce rotation + write summary)
        id: preflight
        shell: bash
        run: |
          set -e
          mkdir -p .state

          WHEN="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "## Crypto — Hourly 1-Coin Rotation" > .state/run_summary.md
          echo "" >> .state/run_summary.md
          echo "**When:** ${WHEN}" >> .state/run_summary.md

          cat > .state/run_summary.json <<'JSON'
          {"status":"preflight","blocked":false}
          JSON

          MAX_POS="${{ vars.MAX_POSITIONS }}"
          PICK="${{ vars.UNIVERSE_PICK }}"
          DRY="${{ vars.DRY_RUN }}"
          RUN_SWITCH="${{ vars.RUN_SWITCH }}"
          MAX_POS="${MAX_POS:-1}"
          DRY="${DRY:-ON}"
          RUN_SWITCH="${RUN_SWITCH:-ON}"

          if [[ -z "$PICK" ]]; then
            echo "Universe mode: AUTO (UNIVERSE_PICK not set)"
            echo "**Universe:** AUTO (UNIVERSE_PICK not set)" >> .state/run_summary.md
          else
            echo "Universe mode: FIXED (UNIVERSE_PICK=${PICK})"
            echo "**Universe:** FIXED (${PICK})" >> .state/run_summary.md
          fi

          echo "" >> .state/run_summary.md
          echo "**DRY_RUN:** ${DRY}" >> .state/run_summary.md
          echo "**RUN_SWITCH:** ${RUN_SWITCH}" >> .state/run_summary.md
          echo "**MAX_POSITIONS:** ${MAX_POS}" >> .state/run_summary.md

          if [[ "${MAX_POS}" == "1" && -n "${PICK}" ]]; then
            echo "::error title=Configuration blocked::MAX_POSITIONS==1 (rotation mode) but UNIVERSE_PICK='${PICK}'. Clear UNIVERSE_PICK for auto-universe rotation."
            jq '.status="blocked" | .blocked=true | .reason="MAX_POSITIONS==1 but UNIVERSE_PICK set"' .state/run_summary.json > .state/tmp.json 2>/dev/null || true
            mv .state/tmp.json .state/run_summary.json 2>/dev/null || true
            exit 22
          fi

      - name: Debug .state contents
        if: always()
        run: |
          echo "Listing .state:"
          ls -la .state || true
          echo ""
          echo "Preview run_summary.md:"
          cat .state/run_summary.md || true

      # -------------------
      # Main trading logic
      # -------------------
      - name: Run main.py
        if: ${{ success() }}
        env:
          RUN_SWITCH: ${{ vars.RUN_SWITCH }}
          DRY_RUN: ${{ vars.DRY_RUN }}
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK }}
          UNIVERSE_TOP_K: ${{ vars.UNIVERSE_TOP_K }}
          BUY_USD: ${{ vars.BUY_USD }}
          RESERVE_CASH_PCT: ${{ vars.RESERVE_CASH_PCT }}
          SELL_STOP_PCT: ${{ vars.SELL_STOP_PCT }}
          SELL_TAKE_PROFIT_PCT: ${{ vars.SELL_TAKE_PROFIT_PCT }}
          SELL_1H_MIN_GAIN_PCT: ${{ vars.SELL_1H_MIN_GAIN_PCT }}
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -e
          echo "Running main.py at $(date -u)"
          python main.py

      # Guarantee minimal artifact payload
      - name: Finalize .state (safety)
        if: always()
        run: |
          mkdir -p .state
          [[ -s .state/run_summary.md ]] || echo "Placeholder summary" > .state/run_summary.md
          [[ -s .state/run_summary.json ]] || echo '{"status":"placeholder"}' > .state/run_summary.json

      # --- FIX: explicit include of dot-folders ---
      - name: Upload .state artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-rotation-state
          path: |
            .state/**
            ./.state/**
          include-hidden-files: true
          if-no-files-found: warn
          retention-days: 14

      - name: Cleanup
        if: always()
        run: git config --global --unset-all safe.directory || true
