name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"   # Every hour at :00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      # ---------- Optional tiny safety net (best-effort) ----------
      - name: Seed candidates if missing (best-effort)
        run: |
          mkdir -p .state
          if [ ! -f .state/momentum_candidates.csv ]; then
            echo "pair,rank,quote" > .state/momentum_candidates.csv
            echo "EAT/USD,100,0.01" >> .state/momentum_candidates.csv
          fi

      - name: Echo critical env/vars
        run: |
          echo "DRY_RUN=${DRY_RUN}"
          echo "BUY_USD=${BUY_USD}"
          echo "TP_PCT=${TP_PCT}"
          echo "SL_PCT=${SL_PCT}"
          echo "SLOW_GAIN_PCT=${SLOW_GAIN_PCT}"
          echo "SLOW_WINDOW_MIN=${SLOW_WINDOW_MIN}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK}"
        shell: bash

      - name: Run rotation
        env:
          # Secrets
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # Vars
          DRY_RUN: ${{ vars.DRY_RUN }}
          BUY_USD: ${{ vars.BUY_USD }}
          TP_PCT: ${{ vars.TP_PCT }}
          SL_PCT: ${{ vars.SL_PCT }}
          SLOW_GAIN_PCT: ${{ vars.SLOW_GAIN_PCT }}
          SLOW_WINDOW_MIN: ${{ vars.SLOW_WINDOW_MIN }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK }}
        run: |
          python -u main.py

      # Help debug and prove files exist
      - name: List .state contents
        if: always()
        run: |
          echo "----- .state -----"
          ls -la .state || true
          echo "------------------"

      # Upload artifacts so you can download run_summary, positions, etc.
      - name: Upload .state artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_number }}
          path: |
            .state/**
          if-no-files-found: warn
          retention-days: 7
