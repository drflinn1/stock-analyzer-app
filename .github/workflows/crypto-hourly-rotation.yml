name: Crypto — Hourly 1-Coin Rotation (LIVE-ready)

on:
  schedule:
    - cron: "0 * * * *"   # hourly (UTC)
  workflow_dispatch:

# Needed so the job can push .state files back to the repo
permissions:
  contents: write

concurrency:
  group: crypto-hourly-rotation
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # allow commits/pushes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi

      - name: Run strategy (DRY-RUN is OFF when repo Variable DRY_RUN=OFF)
        env:
          # --- Secrets (must exist under: Settings → Secrets and variables → Actions → Secrets) ---
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # --- Repo Variables (Settings → Secrets and variables → Actions → Variables) ---
          # Core toggles
          DRY_RUN: ${{ vars.DRY_RUN || 'OFF' }}            # OFF = LIVE
          RUN_SWITCH: ${{ vars.RUN_SWITCH || 'ON' }}

          # Position & sizing
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS || '1' }}
          MAX_BUYS_PER_RUN: ${{ vars.MAX_BUYS_PER_RUN || '1' }}
          BUY_USD: ${{ vars.BUY_USD || '25' }}

          # Exits / rotation
          TP_PCT: ${{ vars.TP_PCT || '5' }}
          SL_PCT: ${{ vars.SL_PCT || '1' }}
          ROTATE_MINUTES: ${{ vars.ROTATE_MINUTES || '60' }}
          ROTATE_MIN_GAIN_PCT: ${{ vars.ROTATE_MIN_GAIN_PCT || '3' }}

          # Discovery / ranking (optional; keep your existing values)
          UNIVERSE_TOP_K: ${{ vars.UNIVERSE_TOP_K || '25' }}
          # Temporary manual pick fallback (optional)
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}

        run: |
          echo "[Mode] DRY_RUN=${DRY_RUN}"
          python -u main.py

      # Always create/push .state artifacts (run summaries every run; position.json only when holding)
      - name: Commit & push .state to repo
        if: always()
        run: |
          if [ -d ".state" ]; then
            # ensure we at least ship summaries each run
            if [ ! -f ".state/run_summary.json" ]; then
              echo '{}' > .state/run_summary.json
            fi
            if [ ! -f ".state/run_summary.md" ]; then
              echo "**No summary generated by script.**" > .state/run_summary.md
            fi

            git config user.name  "github-actions"
            git config user.email "github-actions@users.noreply.github.com"

            # Stage only .state changes (json/md/csv)
            git add .state/*.json .state/*.md .state/*.csv 2>/dev/null || true

            if ! git diff --cached --quiet; then
              git commit -m "state: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              git push
              echo "Pushed .state artifacts."
            else
              echo "No .state updates to commit."
            fi
          else
            echo "No .state directory; nothing to commit."
          fi

      - name: Upload .state as artifact (convenience)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: .state
          if-no-files-found: warn
