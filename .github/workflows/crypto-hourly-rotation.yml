name: Crypto — 1-Coin Rotation (15m, TP 8%)

on:
  schedule:
    # Every 15 minutes (more frequent so you don't wait long)
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

# Prevent overlapping runs if a previous job is still working
concurrency:
  group: crypto-rotation
  cancel-in-progress: false

# Defaults (override in Repo → Settings → Variables)
env:
  DRY_RUN: ${{ vars.DRY_RUN || 'ON' }}           # Set DRY_RUN=OFF for live
  TP_PCT: ${{ vars.TP_PCT || '8' }}              # Take-profit %
  WINDOW_MIN: ${{ vars.WINDOW_MIN || '30' }}     # Rotation window minutes
  BUY_USD: ${{ vars.BUY_USD || '30' }}           # Per-buy notional
  MAX_POSITIONS: ${{ vars.MAX_POSITIONS || '1' }}
  UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}
  QUOTE_CCY: ${{ vars.QUOTE_CCY || 'USD' }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -e
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            python -m pip install --upgrade pip
            pip install requests pandas pyyaml matplotlib
          fi

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Echo critical env/vars
        run: |
          echo "DRY_RUN       = ${DRY_RUN}"
          echo "TP_PCT        = ${TP_PCT}"
          echo "WINDOW_MIN    = ${WINDOW_MIN}"
          echo "BUY_USD       = ${BUY_USD}"
          echo "MAX_POSITIONS = ${MAX_POSITIONS}"
          echo "UNIVERSE_PICK = '${UNIVERSE_PICK}'"
          echo "QUOTE_CCY     = ${QUOTE_CCY}"

      - name: Echo times (UTC vs local)
        run: |
          echo "Now (UTC):   $(date -u)"
          echo "Now (local): $(date)"

      - name: Run rotation bot
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          python -u main.py

      - name: Show .state after run
        run: |
          echo "=== .state contents ==="
          ls -la .state || true

      - name: Echo upload manifest
        shell: bash
        run: |
          shopt -s globstar nullglob dotglob
          echo "Files that will be uploaded as artifacts:"
          found=0
          for f in .state/**; do
            if [ -f "$f" ]; then
              echo " - $f"
              found=1
            fi
          done
          if [ $found -eq 0 ]; then
            echo " (none found; proceeding without warning)"
          fi

      - name: Upload .state artifacts
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: .state/**
          include-hidden-files: true
          if-no-files-found: ignore
          compression-level: 6
          retention-days: 7
