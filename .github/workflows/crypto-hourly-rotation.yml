name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt || true
          pip install requests pandas pyyaml matplotlib || true

      # === Run scanners locally (no artifacts needed) ===
      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Run momentum scanner (local)
        run: python tools/momentum_scan.py

      - name: Run spike scanner (local)
        run: python tools/momentum_spike.py

      - name: Normalize CSV schemas
        run: |
          python tools/csv_schema_fix.py .state/momentum_candidates.csv || true
          python tools/csv_schema_fix.py .state/spike_candidates.csv || true

      # === NEW: Prefer spike if fresh & decent, else fall back to momentum ===
      - name: Select freshest candidates (spike-first)
        run: |
          python - <<'PY'
          import os, time, shutil, pandas as pd

          MOM_FIXED = ".state/momentum_candidates_fixed.csv"
          SPIKE_FIXED = ".state/spike_candidates_fixed.csv"
          SELECTED   = ".state/candidates_selected.csv"  # for logging/inspection

          def fresh_enough(path, max_age_min=20):
              if not os.path.exists(path): return False
              age_s = time.time() - os.path.getmtime(path)
              return age_s <= max_age_min * 60

          def good_spike(path):
              try:
                  df = pd.read_csv(path)
                  if len(df) < 5:
                      print(f"Spike not used: only {len(df)} rows (<5).")
                      return False
                  # Liquidity check if usd_vol present (not mandatory)
                  if "usd_vol" in df.columns:
                      # require at least one candidate with >= $100k in last window
                      ok = (df["usd_vol"].fillna(0) >= 100000).any()
                      if not ok:
                          print("Spike not used: liquidity check failed (usd_vol < 100k on all rows).")
                          return False
                  return True
              except Exception as e:
                  print("Spike not used: error reading spike file:", e)
                  return False

          use_spike = fresh_enough(SPIKE_FIXED, 20) and good_spike(SPIKE_FIXED)

          if use_spike:
              src = SPIKE_FIXED
              print("âœ” Using SPIKE candidates (fresh & valid).")
          else:
              src = MOM_FIXED
              print("â„¹ Using MOMENTUM candidates (spike missing/stale/weak).")

          # Save a copy for visibility, and also overwrite the momentum_fixed
          # so main.py keeps reading the same path it already expects.
          shutil.copyfile(src, SELECTED)
          shutil.copyfile(src, MOM_FIXED)
          print(f"Selected â†’ {SELECTED} (and mirrored to {MOM_FIXED})")

          # Show quick preview
          try:
              df = pd.read_csv(SELECTED)
              print("\n=== Selected top 5 ===")
              print(df.head(5).to_string(index=False))
          except Exception as e:
              print("Preview error:", e)
          PY

      # ðŸš€ Run your rotation bot (reads .state/momentum_candidates_fixed.csv as usual)
      - name: Run bot
        env:
          PYTHONUNBUFFERED: "1"
          # Keep your existing repo variables/secrets (BUY_USD, DRY_RUN, MAX_POSITIONS, TP_PCT, SL_PCT, etc.)
        run: |
          python main.py
