name: Crypto — Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt || true
          pip install requests pandas pyyaml matplotlib || true

      # Run scanners "inline" (no artifacts)
      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Run momentum scanner (local)
        run: python tools/momentum_scan.py

      - name: Run spike scanner (local)
        run: python tools/momentum_spike.py

      - name: Normalize CSV schemas
        run: |
          python tools/csv_schema_fix.py .state/momentum_candidates.csv || true
          python tools/csv_schema_fix.py .state/spike_candidates.csv || true

      # Prefer SPIKE if fresh/valid, then normalize symbols to what main.py expects
      - name: Select candidates (spike-first) + normalize symbols (USD, no slash)
        run: |
          python - <<'PY'
          import os, time, shutil, pandas as pd, re
          MOM_FIXED = ".state/momentum_candidates_fixed.csv"
          SPIKE_FIXED = ".state/spike_candidates_fixed.csv"
          def fresh_enough(p, m=20): return os.path.exists(p) and (time.time()-os.path.getmtime(p) <= m*60)
          def good_spike(p):
              try:
                  df = pd.read_csv(p)
                  if len(df) < 5: return False
                  if "usd_vol" in df.columns and not (df["usd_vol"].fillna(0) >= 100000).any(): return False
                  return True
              except Exception: return False
          src = SPIKE_FIXED if (fresh_enough(SPIKE_FIXED,20) and good_spike(SPIKE_FIXED)) else MOM_FIXED
          print("Using", "SPIKE" if src==SPIKE_FIXED else "MOMENTUM", "→", src)
          df = pd.read_csv(src)
          if "symbol" not in df.columns:
              if "pair" in df.columns: df["symbol"] = df["pair"]
              else: raise SystemExit("No 'symbol' or 'pair' column found.")
          def norm_sym(s):
              s = str(s).upper().strip().replace("/","")
              return re.sub(r"[^A-Z0-9]","",s)
          df["symbol_norm"] = df["symbol"].map(norm_sym)
          usd_mask = df["symbol_norm"].str.endswith("USD", na=False) & ~df["symbol_norm"].str.endswith("USDT", na=False)
          if usd_mask.any(): df = df.loc[usd_mask].copy()
          out = pd.DataFrame({
              "symbol": df["symbol_norm"],
              "quote":  df["quote"] if "quote" in df.columns else None,
              "rank":   df["rank"]  if "rank"  in df.columns else range(1, len(df)+1)
          })
          out.to_csv(".state/candidates_selected_norm.csv", index=False)
          out.to_csv(MOM_FIXED, index=False)  # path main.py reads
          print("\n=== Selected (normalized) top 10 ===")
          print(out.head(10).to_string(index=False))
          PY

      - name: Echo latest picks (top 5)
        run: |
          python - <<'PY'
          import os, pandas as pd
          fp = ".state/momentum_candidates_fixed.csv"
          if os.path.exists(fp):
              df = pd.read_csv(fp)
              print("\\n=== Final candidates fed to bot (top 5) ===")
              print(df.head(5).to_string(index=False))
          else:
              print("No momentum_candidates_fixed.csv found")
          PY

      # RUN BOT with repo Variables AND Kraken Secrets injected
      - name: Run bot
        env:
          PYTHONUNBUFFERED: "1"

          # Force crypto broker for this workflow
          BROKER: kraken

          # ---- Repo Variables (Settings → Secrets and variables → Actions → Variables) ----
          DRY_RUN:           ${{ vars.DRY_RUN }}
          BUY_USD:           ${{ vars.BUY_USD }}
          TP_PCT:            ${{ vars.TP_PCT }}
          SL_PCT:            ${{ vars.SL_PCT }}
          SLOW_GAIN_PCT:     ${{ vars.SLOW_GAIN_PCT }}
          SLOW_WINDOW_MIN:   ${{ vars.SLOW_WINDOW_MIN }}
          MAX_POSITIONS:     ${{ vars.MAX_POSITIONS }}
          RESERVE_CASH_PCT:  ${{ vars.RESERVE_CASH_PCT }}
          UNIVERSE_PICK:     ${{ vars.UNIVERSE_PICK }}

          # ---- Kraken API Secrets (Settings → Secrets and variables → Actions → Secrets) ----
          # Make sure these names match exactly how you saved them.
          KRAKEN_API_KEY:     ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET:  ${{ secrets.KRAKEN_API_SECRET }}
          # If you also store any of these, they will pass through harmlessly:
          KRAKEN_API_KEY2:        ${{ secrets.KRAKEN_API_KEY2 }}
          KRAKEN_API_SECRET2:     ${{ secrets.KRAKEN_API_SECRET2 }}
          KRAKEN_PASSPHRASE:      ${{ secrets.KRAKEN_PASSPHRASE }}
          KRAKEN_PRIVATE_KEY:     ${{ secrets.KRAKEN_PRIVATE_KEY }}
        run: |
          echo "=== ENV ==="
          echo "DRY_RUN = ${DRY_RUN}"
          echo "BUY_USD = ${BUY_USD}"
          echo "BROKER  = ${BROKER}"
          python main.py
