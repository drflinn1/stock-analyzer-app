name: Crypto - 1-Coin Rotation (LIVE-ready, ultra-defensive, 15m)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: crypto-hourly-rotation
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
      DRY_RUN: ${{ vars.DRY_RUN }}
      BUY_USD: ${{ vars.BUY_USD }}

    steps:
      - name: Set up git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz

      - name: preflight - persist .state and write summary
        run: |
          set -e
          mkdir -p .state
          ls -la .state || true
          date +"%F %T %Z" > .state/_note.txt
          echo "mode=${DRY_RUN:-}; universe=AUTO (UNIVERSE_PICK not set)" >> .state/_note.txt

      - name: Sanity check Kraken keys (same env as trade)
        run: |
          python - <<'PY'
          import os, time, hmac, hashlib, base64, requests
          key = os.getenv("KRAKEN_API_KEY","")
          sec = os.getenv("KRAKEN_API_SECRET","")
          assert key and sec, "Missing KRAKEN_API_KEY or KRAKEN_API_SECRET env"
          url = "https://api.kraken.com/0/private/Balance"
          nonce = str(int(time.time()*1000))
          data = {"nonce": nonce}
          postdata = "&".join([f"{k}={v}" for k,v in data.items()])
          message = ("/0/private/Balance").encode() + hashlib.sha256((nonce+postdata).encode()).digest()
          secret = base64.b64decode(sec)
          signature = base64.b64encode(hmac.new(secret, message, hashlib.sha512).digest()).decode()
          headers = {"API-Key": key, "API-Sign": signature}
          r = requests.post(url, headers=headers, data=data, timeout=20)
          j = r.json()
          if j.get("error"):
            raise SystemExit(f"Sanity FAILED: {j['error']}")
          print("Sanity OK. Balance keys present.")
          PY

      - name: Run main.py
        run: |
          set -e
          python main.py || true

      - name: Bundle state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: crypto-rotation-state
          path: .state/**
          if-no-files-found: warn
          retention-days: 7
