name: Crypto - 1-Coin Rotation (LIVE-ready, ultra-defensive, 15m)

on:
  schedule:
    - cron: "*/15 * * * *"          # keep 15-minute cadence
  workflow_dispatch:

concurrency:
  group: crypto-1coin-rotation
  cancel-in-progress: true

permissions:
  contents: read

env:
  # Guard behavior (safe defaults)
  AUTO_SELL_ON_MULTI: "OFF"         # OFF = refuse to buy if >1 coin; ON = auto-sell extras to keep 1
  USD_CODES: "USD,ZUSD"             # Kraken may use ZUSD in Balance

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests || true

      - name: Preflight — echo vars & ensure .state
        run: |
          set -e
          mkdir -p .state
          echo "=== Runtime Vars ==="
          echo "DRY_RUN=${{ github.event.inputs.DRY_RUN || env.DRY_RUN || 'ON' }}"
          echo "TP_PCT=${TP_PCT:=5}"
          echo "STOP_PCT=${STOP_PCT:=1}"
          echo "SLOW_MIN_PCT=${SLOW_MIN_PCT:=3}"
          echo "WINDOW_MIN=${WINDOW_MIN:=30}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK}"
          echo "AUTO_SELL_ON_MULTI=${AUTO_SELL_ON_MULTI}"
          echo "=== ls -la .state (before) ==="
          ls -la .state || true

      # ---------- Single-position Guard (Kraken) ----------
      - name: Single-position guard (Kraken)
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          python - <<'PY'
          import os, time, urllib.parse, hashlib, hmac, base64, json, sys
          import requests

          def kraken_private(path, data):
            key = os.getenv("KRAKEN_API_KEY","")
            sec = os.getenv("KRAKEN_API_SECRET","")
            if not key or not sec:
              return {"error":["EAPI:MissingKeySecret"], "result":{}}
            url = "https://api.kraken.com" + path
            data["nonce"] = str(int(time.time()*1000))
            postdata = urllib.parse.urlencode(data)
            # Kraken signature
            encoded = (str(data["nonce"]) + postdata).encode()
            sha256 = hashlib.sha256(encoded).digest()
            message = path.encode() + sha256
            mac = hmac.new(base64.b64decode(sec), message, hashlib.sha512)
            sig = base64.b64encode(mac.digest())
            headers = {"API-Key": key, "API-Sign": sig.decode()}
            r = requests.post(url, headers=headers, data=data, timeout=20)
            return r.json()

          # Fetch balances
          bal = kraken_private("/0/private/Balance", {})
          usd_codes = set(os.getenv("USD_CODES","USD,ZUSD").split(","))
          # If no keys or error, skip guard safely
          if "error" in bal and bal["error"]:
            print("[GUARD] Balance error or missing keys; skipping guard:", bal["error"])
            sys.exit(0)

          balances = bal.get("result", {}) or {}
          nonusd = {a:float(v) for a,v in balances.items() if a not in usd_codes and float(v) > 0.0000001}

          # Count non-USD assets that are > ~dust
          n = len(nonusd)
          print("[GUARD] Non-USD holdings:", json.dumps(nonusd))
          if n <= 1:
            sys.exit(0)

          # More than one coin → enforce single-position policy
          os.makedirs(".state", exist_ok=True)
          with open(".state/run_summary.md", "w") as f:
            f.write(f"**When:** {time.strftime('%Y-%m-%d %H:%M:%S UTC', time.gmtime())}\n")
            f.write("**Policy:** Single-position enforced\n")
            f.write(f"**Detected non-USD assets:** {json.dumps(nonusd)}\n")
            f.write("**Action:** ")

            if os.getenv("AUTO_SELL_ON_MULTI","OFF").upper() != "ON":
              f.write("Refused to buy (AUTO_SELL_ON_MULTI=OFF). Fix manually or run Force Sell.\n")
              print("[GUARD] >1 coins detected; refusing to buy (safe mode).")
              # exit 0 so job is green but rotation is skipped
              sys.exit(0)
            else:
              f.write("Auto-sell is ON, attempting to reduce to 1 asset.\n")

          # Optional auto-sell path (kept off by default to avoid surprises)
          # NOTE: We DO NOT implement sells here to avoid pair-symbol ambiguity.
          # Leave a clear message and exit; you can turn ON and we’ll wire exact pairs later.
          print("[GUARD] Auto-sell not executed in safe build. Set AUTO_SELL_ON_MULTI=ON and ask for pair mapping if you want this enabled.")
          sys.exit(0)
          PY

      - name: Run main.py (bot)
        run: |
          set -e
          python main.py

      # Safety net so artifacts always exist even on HOLD/ERROR runs
      - name: Always write summary + placeholder position if missing
        run: |
          set -e
          mkdir -p .state
          if [ ! -f ".state/run_summary.md" ]; then
            {
              echo "**When:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo "**DRY_RUN:** ${DRY_RUN:-ON}"
              echo "**TP_PCT:** ${TP_PCT:-5} | **STOP_PCT:** ${STOP_PCT:-1} | **SLOW_MIN_PCT:** ${SLOW_MIN_PCT:-3} | **WINDOW_MIN:** ${WINDOW_MIN:-30}"
              echo "**Note:** Auto-generated summary because the bot didn’t emit one this run."
            } > .state/run_summary.md
          fi
          if [ ! -f ".state/position.json" ]; then
            printf '{"symbol":null,"qty":0,"avg_price":0,"in_position_since":null}\n' > .state/position.json
          fi
          echo "=== ls -la .state (after) ==="
          ls -la .state

      - name: Upload .state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: .state            # upload the directory (stops the warning)
          if-no-files-found: warn
