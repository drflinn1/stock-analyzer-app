name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"   # hourly UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: crypto-hourly-rotation
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi

      # --- PRE-FLIGHT: guarantee .state + heartbeat so artifacts/commit always have something ---
      - name: Preflight heartbeat (.state)
        shell: bash
        run: |
          set -e
          mkdir -p .state
          date -u +"%Y-%m-%dT%H:%M:%SZ" | tee .state/keep.txt >/dev/null
          echo '{"status":"preflight","note":"before main.py"}' > .state/run_summary.json
          echo "**Preflight:** created before main.py" > .state/run_summary.md
          echo "HEARTBEAT-WRITE OK"
          echo "TREE (preflight):"
          ls -la .state || true

      - name: Run strategy (DRY-RUN is OFF when repo Variable DRY_RUN=OFF)
        shell: bash
        env:
          # --- Secrets ---
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # --- Variables ---
          DRY_RUN: ${{ vars.DRY_RUN || 'OFF' }}                  # OFF = LIVE
          RUN_SWITCH: ${{ vars.RUN_SWITCH || 'ON' }}
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS || '1' }}
          MAX_BUYS_PER_RUN: ${{ vars.MAX_BUYS_PER_RUN || '1' }}
          BUY_USD: ${{ vars.BUY_USD || '25' }}
          TP_PCT: ${{ vars.TP_PCT || '5' }}
          SL_PCT: ${{ vars.SL_PCT || '1' }}
          ROTATE_MINUTES: ${{ vars.ROTATE_MINUTES || '60' }}
          ROTATE_MIN_GAIN_PCT: ${{ vars.ROTATE_MIN_GAIN_PCT || '3' }}
          UNIVERSE_TOP_K: ${{ vars.UNIVERSE_TOP_K || '25' }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "[Env] DRY_RUN=${DRY_RUN} RUN_SWITCH=${RUN_SWITCH} MAX_POSITIONS=${MAX_POSITIONS}"
          python -u main.py || echo "[WARN] main.py exited non-zero"

      # --- POST-FLIGHT: append a line so we KNOW files exist even if script didn't write any ---
      - name: Postflight touch (.state)
        shell: bash
        if: always()
        run: |
          mkdir -p .state
          echo "**Postflight:** job finished $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> .state/run_summary.md
          if [ ! -f .state/run_summary.json ]; then
            echo '{"status":"postflight-only"}' > .state/run_summary.json
          fi
          echo "TREE (postflight):"
          ls -la .state || true

      - name: Commit & push .state to repo (verbose)
        if: always()
        shell: bash
        run: |
          echo "TREE (pre-commit):"
          ls -la .state || true
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .state/*.json .state/*.md .state/*.csv .state/keep.txt 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "state: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
            echo "Pushed .state artifacts."
          else
            echo "No .state updates to commit."
          fi

      - name: Upload .state as artifact (always has keep.txt)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: .state
          if-no-files-found: warn
