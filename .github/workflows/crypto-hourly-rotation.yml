name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

# Needed so this job can download artifacts produced by other workflows
permissions:
  contents: read
  actions: read

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt || true
          pip install requests pandas pyyaml matplotlib || true

      # Pull the latest Momentum/Spike scan artifacts into .state/
      - name: Pull latest momentum/spike artifacts â†’ .state/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x tools/fetch_latest_scan_artifacts.sh
          bash tools/fetch_latest_scan_artifacts.sh

      # Optional: print a quick preview in the logs
      - name: Echo latest picks (top 5)
        run: |
          python - <<'PY'
          import os, pandas as pd
          def show(fp, label):
              if os.path.exists(fp):
                  try:
                      df = pd.read_csv(fp)
                      print(f"\n=== {label} (top 5) ===")
                      print(df.head(5).to_string(index=False))
                  except Exception as e:
                      print(f"{label}: unable to read {fp}: {e}")
              else:
                  print(f"{label}: {fp} not found")
          show(".state/momentum_candidates_fixed.csv", "Momentum candidates")
          show(".state/spike_candidates_fixed.csv", "Spike candidates")
          PY

      # ðŸš€ Run your rotation bot
      - name: Run bot
        env:
          PYTHONUNBUFFERED: "1"
          # (Keep your existing env/vars in repo settings: BUY_USD, DRY_RUN, TP_PCT, SL_PCT, etc.)
          # Kraken secrets remain in Secrets (KRAKEN_API_KEY / KRAKEN_API_SECRET / etc.)
        run: |
          python main.py
