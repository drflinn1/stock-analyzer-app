name: Crypto — Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"   # hourly at minute 0 UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      # Flip in Settings → Secrets and variables → Actions → Variables
      DRY_RUN: ${{ vars.DRY_RUN || 'ON' }}          # ON = paper, OFF = live
      BUY_USD: ${{ vars.BUY_USD || '25' }}
      TP_PCT: ${{ vars.TP_PCT || '5' }}
      STOP_PCT: ${{ vars.STOP_PCT || '1' }}

      # New guard & rotation knobs (safe defaults)
      COOLDOWN_MIN: ${{ vars.COOLDOWN_MIN || '30' }}         # skip immediate rebuy after a sell
      NO_REBUY_MIN: ${{ vars.NO_REBUY_MIN || vars.COOLDOWN_MIN || '30' }}
      TRAIL_START_PCT: ${{ vars.TRAIL_START_PCT || '3.0' }}
      TRAIL_BACKOFF_PCT: ${{ vars.TRAIL_BACKOFF_PCT || '0.8' }}
      BE_TRIGGER_PCT: ${{ vars.BE_TRIGGER_PCT || '2.0' }}
      SWITCH_IF_GAP: ${{ vars.SWITCH_IF_GAP || '0' }}        # 0 disables early rotation
      SWITCH_MIN_HOLD_MIN: ${{ vars.SWITCH_MIN_HOLD_MIN || '10' }}

      # Optional cosmetics in summary
      WINDOW_MIN: ${{ vars.WINDOW_MIN || '60' }}
      SLOW_GAIN_REQ: ${{ vars.SLOW_GAIN_REQ || '3' }}
      UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}

      # Keys (canonical or legacy)
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY || secrets.KRAKEN_KEY || '' }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET || secrets.KRAKEN_SECRET || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (force-install core deps incl. requests)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi
          pip install --upgrade requests pandas python-dateutil pyyaml

      - name: Echo critical env (no secrets)
        run: |
          echo "DRY_RUN=${DRY_RUN}"
          echo "BUY_USD=${BUY_USD}"
          echo "TP_PCT=${TP_PCT}"
          echo "STOP_PCT=${STOP_PCT}"
          echo "COOLDOWN_MIN=${COOLDOWN_MIN}"
          echo "NO_REBUY_MIN=${NO_REBUY_MIN}"
          echo "TRAIL_START_PCT=${TRAIL_START_PCT}"
          echo "TRAIL_BACKOFF_PCT=${TRAIL_BACKOFF_PCT}"
          echo "BE_TRIGGER_PCT=${BE_TRIGGER_PCT}"
          echo "SWITCH_IF_GAP=${SWITCH_IF_GAP}"
          echo "SWITCH_MIN_HOLD_MIN=${SWITCH_MIN_HOLD_MIN}"
          echo "WINDOW_MIN=${WINDOW_MIN}"
          echo "SLOW_GAIN_REQ=${SLOW_GAIN_REQ}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK:-<empty>}"

      - name: Key sanity check (no secret values shown)
        run: |
          missing=0
          if [ -z "${KRAKEN_API_KEY}" ]; then echo "::error::Missing KRAKEN_API_KEY (or KRAKEN_KEY)"; missing=1; fi
          if [ -z "${KRAKEN_API_SECRET}" ]; then echo "::error::Missing KRAKEN_API_SECRET (or KRAKEN_SECRET)"; missing=1; fi
          if [ "${DRY_RUN}" = "OFF" ] && [ $missing -ne 0 ]; then
            echo "::error::LIVE mode requires API keys in repo Secrets."; exit 1
          fi
          echo "Keys present check: OK."

      # Always have something to upload
      - name: Prepare .state placeholder
        run: |
          mkdir -p .state
          echo "Placeholder (pre-run) $(date -u)" > .state/run_summary.md

      - name: Run rotation
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src:${{ github.workspace }}/trader
        run: |
          python -m trader.crypto_engine || true
          echo "Contents of .state after run:"
          ls -la .state || true
          tar -czf state_bundle.tgz .state || true
          echo "Created state_bundle.tgz size:" $(du -h state_bundle.tgz | cut -f1)

      - name: Upload .state artifacts (folder + tarball)
        uses: actions/upload-artifact@v4
        with:
          name: crypto-hourly-rotation-${{ github.run_id }}
          path: |
            .state
            state_bundle.tgz
          if-no-files-found: warn
