name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      DRY_RUN: ${{ vars.DRY_RUN || 'ON' }}             # ON=paper / OFF=live
      BUY_USD: ${{ vars.BUY_USD || '25' }}
      TP_PCT: ${{ vars.TP_PCT || '5' }}
      STOP_PCT: ${{ vars.STOP_PCT || '1' }}
      WINDOW_MIN: ${{ vars.WINDOW_MIN || '60' }}
      SLOW_GAIN_REQ: ${{ vars.SLOW_GAIN_REQ || '3' }}
      UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}

      # Keys (either canonical or legacy names in Secrets)
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY || secrets.KRAKEN_KEY || '' }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET || secrets.KRAKEN_SECRET || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (force-install core deps incl. requests)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi
          pip install --upgrade --no-input requests pandas python-dateutil pyyaml

      - name: Echo critical env (no secrets)
        run: |
          echo "DRY_RUN=${DRY_RUN}"
          echo "BUY_USD=${BUY_USD}"
          echo "TP_PCT=${TP_PCT}"
          echo "STOP_PCT=${STOP_PCT}"
          echo "WINDOW_MIN=${WINDOW_MIN}"
          echo "SLOW_GAIN_REQ=${SLOW_GAIN_REQ}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK:-<empty>}"

      - name: Key sanity check (no secret values shown)
        run: |
          missing=0
          if [ -z "${KRAKEN_API_KEY}" ]; then echo "::error::Missing KRAKEN_API_KEY (or KRAKEN_KEY)"; missing=1; fi
          if [ -z "${KRAKEN_API_SECRET}" ]; then echo "::error::Missing KRAKEN_API_SECRET (or KRAKEN_SECRET)"; missing=1; fi
          if [ "${DRY_RUN}" = "OFF" ] && [ $missing -ne 0 ]; then
            echo "::error::LIVE mode requires API keys in repo Secrets."; exit 1
          fi
          echo "Keys present check: OK."

      # Guarantee artifact presence even if Python exits early
      - name: Prepare .state placeholder
        run: |
          mkdir -p .state
          echo "Placeholder (pre-run) $(date -u)" > .state/run_summary.md

      - name: Run rotation
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src:${{ github.workspace }}/trader
        run: |
          python -u main.py || true
          ls -la .state

      - name: Upload .state artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crypto-hourly-rotation-${{ github.run_id }}
          path: .state/**
          if-no-files-found: warn
