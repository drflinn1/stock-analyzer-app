name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt || true
          pip install requests pandas pyyaml matplotlib || true

      # === Run scanners locally (no artifacts needed) ===
      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Run momentum scanner (local)
        run: python tools/momentum_scan.py

      - name: Run spike scanner (local)
        run: python tools/momentum_spike.py

      - name: Normalize CSV schemas
        run: |
          python tools/csv_schema_fix.py .state/momentum_candidates.csv || true
          python tools/csv_schema_fix.py .state/spike_candidates.csv || true

      # Prefer spike if fresh & valid, then normalize symbols for main.py (USD, no slash)
      - name: Select candidates (spike-first) + normalize symbols (USD, no slash)
        run: |
          python - <<'PY'
          import os, time, shutil, pandas as pd, re

          MOM_FIXED = ".state/momentum_candidates_fixed.csv"
          SPIKE_FIXED = ".state/spike_candidates_fixed.csv"
          SELECTED_RAW   = ".state/candidates_selected_raw.csv"
          SELECTED_NORM  = ".state/candidates_selected_norm.csv"

          def fresh_enough(path, max_age_min=20):
              return os.path.exists(path) and (time.time() - os.path.getmtime(path) <= max_age_min*60)

          def good_spike(path):
              try:
                  df = pd.read_csv(path)
                  if len(df) < 5:
                      print(f"Spike not used: only {len(df)} rows (<5).")
                      return False
                  if "usd_vol" in df.columns and (df["usd_vol"].fillna(0) >= 100000).any() is False:
                      print("Spike not used: liquidity check failed (usd_vol < 100k on all rows).")
                      return False
                  return True
              except Exception as e:
                  print("Spike not used: error reading spike file:", e)
                  return False

          use_spike = fresh_enough(SPIKE_FIXED, 20) and good_spike(SPIKE_FIXED)
          src = SPIKE_FIXED if use_spike else MOM_FIXED
          print("âœ” Using", "SPIKE" if use_spike else "MOMENTUM", "candidates â†’", src)

          df = pd.read_csv(src)
          if "symbol" not in df.columns:
              if "pair" in df.columns:
                  df["symbol"] = df["pair"]
              else:
                  raise SystemExit("No 'symbol' (or 'pair') column found in source CSV")

          def norm_sym(s: str) -> str:
              s = str(s).upper().strip()
              s = s.replace("/", "")          # MELANIA/USD -> MELANIAUSD
              s = re.sub(r"[^A-Z0-9]", "", s) # keep alnum
              return s

          df["symbol_norm"] = df["symbol"].map(norm_sym)

          usd_mask = df["symbol_norm"].str.endswith("USD", na=False) & ~df["symbol_norm"].str.endswith("USDT", na=False)
          if usd_mask.any():
              df = df.loc[usd_mask].copy()

          out = pd.DataFrame({
              "symbol": df["symbol_norm"],
              "quote":  df["quote"] if "quote" in df.columns else None,
              "rank":   df["rank"]  if "rank"  in df.columns else range(1, len(df)+1)
          })

          out.to_csv(SELECTED_NORM, index=False)
          out.to_csv(MOM_FIXED, index=False)  # mirror to the path main.py expects

          try:
              df.to_csv(SELECTED_RAW, index=False)
          except Exception:
              pass

          print("\n=== Selected (normalized) top 10 ===")
          print(out.head(10).to_string(index=False))
          PY

      - name: Echo latest picks (top 5)
        run: |
          python - <<'PY'
          import os, pandas as pd
          fp = ".state/momentum_candidates_fixed.csv"
          if os.path.exists(fp):
              df = pd.read_csv(fp)
              print("\\n=== Final candidates fed to bot (top 5) ===")
              print(df.head(5).to_string(index=False))
          else:
              print("No momentum_candidates_fixed.csv found")
          PY

      # ðŸš€ Run your rotation bot with env vars taken from repo Variables
      - name: Run bot
        env:
          PYTHONUNBUFFERED: "1"

          # Force the correct broker for this workflow (override any repo Variable)
          BROKER: kraken

          # Pull values from Repository Variables (Settings â†’ Variables â†’ Actions)
          # If any are unset, main.py will use its own defaults.
          DRY_RUN: ${{ vars.DRY_RUN }}
          BUY_USD: ${{ vars.BUY_USD }}
          TP_PCT: ${{ vars.TP_PCT }}
          SL_PCT: ${{ vars.SL_PCT }}
          SLOW_GAIN_PCT: ${{ vars.SLOW_GAIN_PCT }}
          SLOW_WINDOW_MIN: ${{ vars.SLOW_WINDOW_MIN }}
          MAX_POSITIONS: ${{ vars.MAX_POSITIONS }}
          RESERVE_CASH_PCT: ${{ vars.RESERVE_CASH_PCT }}
          UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK }}
        run: |
          python main.py
