name: Crypto â€” Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt || true
          pip install requests pandas pyyaml matplotlib || true

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Run momentum scanner (local)
        run: python tools/momentum_scan.py

      - name: Run spike scanner (local)
        run: python tools/momentum_spike.py

      - name: Normalize CSV schemas
        run: |
          python tools/csv_schema_fix.py .state/momentum_candidates.csv || true
          python tools/csv_schema_fix.py .state/spike_candidates.csv || true

      - name: Select candidates (spike-first) + normalize symbols (USD, no slash)
        run: |
          python - <<'PY'
          import os, time, pandas as pd, re
          MOM_FIXED=".state/momentum_candidates_fixed.csv"
          SPIKE_FIXED=".state/spike_candidates_fixed.csv"
          def fresh(p,m=20): return os.path.exists(p) and (time.time()-os.path.getmtime(p)<=m*60)
          def good(p):
              try:
                  df=pd.read_csv(p)
                  if len(df)<5: return False
                  return not("usd_vol" in df.columns and not (df["usd_vol"].fillna(0)>=100000).any())
              except: return False
          src = SPIKE_FIXED if (fresh(SPIKE_FIXED,20) and good(SPIKE_FIXED)) else MOM_FIXED
          df=pd.read_csv(src)
          if "symbol" not in df.columns:
              if "pair" in df.columns: df["symbol"]=df["pair"]
              else: raise SystemExit("No symbol/pair col")
          def norm(s):
              s=str(s).upper().strip().replace("/","")
              return re.sub(r"[^A-Z0-9]","",s)
          df["symbol"]=df["symbol"].map(norm)
          usd=df["symbol"].str.endswith("USD") & ~df["symbol"].str.endswith("USDT")
          if usd.any(): df=df.loc[usd].copy()
          out=pd.DataFrame({"symbol":df["symbol"],
                            "quote": df["quote"] if "quote" in df.columns else None,
                            "rank":  df["rank"]  if "rank"  in df.columns else range(1,len(df)+1)})
          out.to_csv(MOM_FIXED,index=False)
          print("\n=== Selected (normalized) top 10 ===")
          print(out.head(10).to_string(index=False))
          PY

      - name: Echo latest picks (top 5)
        run: |
          python - <<'PY'
          import pandas as pd, os
          fp=".state/momentum_candidates_fixed.csv"
          if os.path.exists(fp):
              df=pd.read_csv(fp)
              print("\n=== Final candidates (top 5) ===")
              print(df.head(5).to_string(index=False))
          else:
              print("No candidates file")
          PY

      # ---- Preflight: gather Kraken secrets from multiple possible names and export ----
      - name: Preflight secrets (Kraken)
        id: ksec
        shell: bash
        env:
          # Try multiple common names; first non-empty wins
          K1: ${{ secrets.KRAKEN_API_KEY }}
          K2: ${{ secrets.KRAKEN_KEY }}
          K3: ${{ secrets.API_KEY }}
          K4: ${{ secrets.KRAKEN_PUBLIC_KEY }}
          S1: ${{ secrets.KRAKEN_API_SECRET }}
          S2: ${{ secrets.KRAKEN_SECRET }}
          S3: ${{ secrets.API_SECRET }}
          S4: ${{ secrets.KRAKEN_PRIVATE_KEY }}
        run: |
          KEY="${K1:-${K2:-${K3:-${K4:-}}}}"
          SEC="${S1:-${S2:-${S3:-${S4:-}}}}"
          if [ -z "$KEY" ] || [ -z "$SEC" ]; then
            echo "::warning::Kraken secrets appear empty. Check repo Settings â†’ Secrets (names like KRAKEN_API_KEY / KRAKEN_API_SECRET)."
            echo "found_key_len=0"  >> $GITHUB_OUTPUT
            echo "found_sec_len=0"  >> $GITHUB_OUTPUT
          else
            echo "found_key_len=${#KEY}" >> $GITHUB_OUTPUT
            echo "found_sec_len=${#SEC}" >> $GITHUB_OUTPUT
            # export for next step
            echo "KRAKEN_API_KEY=$KEY"     >> $GITHUB_ENV
            echo "KRAKEN_API_SECRET=$SEC"  >> $GITHUB_ENV
          fi
          echo "Masked preview: key_len=${#KEY}, sec_len=${#SEC}"

      # ðŸš€ Run bot
      - name: Run bot
        env:
          PYTHONUNBUFFERED: "1"
          BROKER: kraken

          # Repo Variables
          DRY_RUN:           ${{ vars.DRY_RUN }}
          BUY_USD:           ${{ vars.BUY_USD }}
          TP_PCT:            ${{ vars.TP_PCT }}
          SL_PCT:            ${{ vars.SL_PCT }}
          SLOW_GAIN_PCT:     ${{ vars.SLOW_GAIN_PCT }}
          SLOW_WINDOW_MIN:   ${{ vars.SLOW_WINDOW_MIN }}
          MAX_POSITIONS:     ${{ vars.MAX_POSITIONS }}
          RESERVE_CASH_PCT:  ${{ vars.RESERVE_CASH_PCT }}
          UNIVERSE_PICK:     ${{ vars.UNIVERSE_PICK }}

          # Kraken secrets populated by preflight step into GITHUB_ENV:
          KRAKEN_API_KEY:    ${{ env.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ env.KRAKEN_API_SECRET }}
        run: |
          echo "=== ENV ==="
          echo "DRY_RUN = ${DRY_RUN}"
          echo "BUY_USD = ${BUY_USD}"
          echo "BROKER  = ${BROKER}"
          echo "Kraken key length  : ${{ steps.ksec.outputs.found_key_len }}"
          echo "Kraken secret length: ${{ steps.ksec.outputs.found_sec_len }}"
          python main.py
