name: Crypto — 1-Coin Rotation (30m, TP 8%)

on:
  schedule:
    # Every 30 minutes
    - cron: "0,30 * * * *"
  workflow_dispatch:

# Only what’s needed for this job
permissions:
  contents: read

# Default env (repo Variables override these if set)
env:
  # Live/Dry toggle (repo Variables > these defaults)
  DRY_RUN: ${{ vars.DRY_RUN || 'ON' }}          # Set repo Variable DRY_RUN=OFF for live trading
  TP_PCT: ${{ vars.TP_PCT || '8' }}             # Take-profit percent
  WINDOW_MIN: ${{ vars.WINDOW_MIN || '30' }}    # Rotation window minutes
  BUY_USD: ${{ vars.BUY_USD || '30' }}          # Per-buy notional
  MAX_POSITIONS: ${{ vars.MAX_POSITIONS || '1' }}

  # Optional filters (leave blank or set in repo Variables)
  UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}
  QUOTE_CCY: ${{ vars.QUOTE_CCY || 'USD' }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (requirements.txt if present; otherwise safe defaults)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            python -m pip install --upgrade pip
            # keep in sync with your baseline
            pip install requests pandas pyyaml matplotlib
          fi

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Echo critical env/vars
        run: |
          echo "DRY_RUN    = ${DRY_RUN}"
          echo "TP_PCT     = ${TP_PCT}"
          echo "WINDOW_MIN = ${WINDOW_MIN}"
          echo "BUY_USD    = ${BUY_USD}"
          echo "MAX_POSITIONS = ${MAX_POSITIONS}"
          echo "UNIVERSE_PICK = '${UNIVERSE_PICK}'"
          echo "QUOTE_CCY  = ${QUOTE_CCY}"

      - name: Run rotation bot
        env:
          # Kraken credentials from repo Secrets
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          python -u main.py

      - name: Show .state after run
        run: |
          echo "=== .state contents ==="
          ls -la .state || true

      - name: Echo upload manifest
        shell: bash
        run: |
          shopt -s globstar nullglob dotglob
          echo "Files that will be uploaded as artifacts:"
          found=0
          for f in .state/**; do
            if [ -f "$f" ]; then
              echo " - $f"
              found=1
            fi
          done
          if [ $found -eq 0 ]; then
            echo " (none found; proceeding without warning)"
          fi

      - name: Upload .state artifacts
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: .state/**
          include-hidden-files: true
          if-no-files-found: ignore   # <- prevents the yellow warning
          compression-level: 6
          retention-days: 7
