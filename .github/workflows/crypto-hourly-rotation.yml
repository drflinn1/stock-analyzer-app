name: Crypto — Hourly 1-Coin Rotation (LIVE-ready, ultra-defensive)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes UTC
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "ON = simulate, OFF = live trading"
        required: true
        default: "ON"
      TP_PCT:
        description: "Take profit percent (e.g., 5 for 5%)"
        required: false
        default: ""
      SL_PCT:
        description: "Stop loss percent (e.g., 1 for 1%)"
        required: false
        default: ""
      SLOW_WINDOW_MIN:
        description: "Rotation window minutes (e.g., 60)"
        required: false
        default: ""
      BUY_USD:
        description: "Per-trade buy size in USD"
        required: false
        default: ""
      UNIVERSE_PICK:
        description: "Optional single pair to force (e.g., SOLUSD). Leave blank for scanner."
        required: false
        default: ""

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      contents: write

    env:
      VARS_SNAPSHOT: ${{ toJSON(vars) }}
      RAW_INPUTS: ${{ toJSON(github.event.inputs) }}

      # legacy repo vars if present
      _TP_VAR:          ${{ vars.TAKE_PROFIT_PCT }}
      _SL_VAR:          ${{ vars.STOP_LOSS_PCT }}
      _SLOW_MIN_PCT:    ${{ vars.SLOW_MIN_PCT }}
      _RUN_SWITCH:      ${{ vars.RUN_SWITCH }}
      _BUY_VAR:         ${{ vars.BUY_USD }}
      _PICK_VAR:        ${{ vars.UNIVERSE_PICK }}
      _DRY_VAR:         ${{ vars.DRY_RUN }}
      _WIN_VAR:         ${{ vars.SLOW_WINDOW_MIN }}

      # UI inputs
      _DRY_IN:  ${{ github.event.inputs.DRY_RUN }}
      _TP_IN:   ${{ github.event.inputs.TP_PCT }}
      _SL_IN:   ${{ github.event.inputs.SL_PCT }}
      _WIN_IN:  ${{ github.event.inputs.SLOW_WINDOW_MIN }}
      _BUY_IN:  ${{ github.event.inputs.BUY_USD }}
      _PICK_IN: ${{ github.event.inputs.UNIVERSE_PICK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          pip install pyyaml matplotlib || true

      - name: Resolve and echo configuration (inputs win)
        id: resolve
        shell: bash
        run: |
          echo "---- RAW INPUTS ----"
          echo '${{ env.RAW_INPUTS }}'
          echo "---- VARS SNAPSHOT ----"
          echo '${{ env.VARS_SNAPSHOT }}'

          DRY_IN="${_DRY_IN^^}"; DRY_VAR="${_DRY_VAR^^}"
          DRY_RUN="${DRY_IN:-$DRY_VAR}"; DRY_RUN="${DRY_RUN:-ON}"
          TP_PCT="${_TP_IN:-${_TP_VAR:-5}}"
          SL_PCT="${_SL_IN:-${_SL_VAR:-1}}"
          SLOW_WINDOW_MIN="${_WIN_IN:-${_WIN_VAR:-60}}"
          BUY_USD="${_BUY_IN:-${_BUY_VAR:-25}}"
          UNIVERSE_PICK="${_PICK_IN:-${_PICK_VAR:-}}"
          SLOW_MIN_PCT="${_SLOW_MIN_PCT:-3}"
          RUN_SWITCH="${_RUN_SWITCH:-ON}"

          echo "---- RESOLVED ----"
          echo "RUN_SWITCH=${RUN_SWITCH}"
          echo "DRY_RUN=${DRY_RUN}"
          echo "TP_PCT=${TP_PCT}  SL_PCT=${SL_PCT}"
          echo "SLOW_WINDOW_MIN=${SLOW_WINDOW_MIN}  SLOW_MIN_PCT=${SLOW_MIN_PCT}"
          echo "BUY_USD=${BUY_USD}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK:-<blank>}"

          {
            echo "RUN_SWITCH=${RUN_SWITCH}"
            echo "DRY_RUN=${DRY_RUN}"
            echo "TP_PCT=${TP_PCT}";         echo "TAKE_PROFIT_PCT=${TP_PCT}"
            echo "SL_PCT=${SL_PCT}";         echo "STOP_LOSS_PCT=${SL_PCT}"
            echo "SLOW_WINDOW_MIN=${SLOW_WINDOW_MIN}"
            echo "SLOW_MIN_PCT=${SLOW_MIN_PCT}"
            echo "BUY_USD=${BUY_USD}"
            echo "UNIVERSE_PICK=${UNIVERSE_PICK}"
          } >> $GITHUB_ENV

      - name: Ensure .state exists and show any candidates
        shell: bash
        run: |
          mkdir -p .state
          if [ -f .state/momentum_candidates.csv ]; then
            echo "Top of existing .state/momentum_candidates.csv:"
            head -n 10 .state/momentum_candidates.csv || true
          else
            echo "No local .state/momentum_candidates.csv found."
          fi

      - name: Fallback to internal scanner if no candidates
        if: env.UNIVERSE_PICK == ''
        shell: bash
        run: |
          # If the file is missing or only has header, switch to AUTO so main.py scans internally.
          if [ ! -s .state/momentum_candidates.csv ] || [ "$(wc -l < .state/momentum_candidates.csv)" -le 1 ]; then
            echo "No usable candidates CSV → setting UNIVERSE_PICK=AUTO (internal scanner)."
            echo "UNIVERSE_PICK=AUTO" >> $GITHUB_ENV
          fi
          echo "Final UNIVERSE_PICK=${UNIVERSE_PICK:-<blank>}"

      - name: Seed minimal summaries
        run: |
          [ -f .state/run_summary.md ] || {
            echo "# Run Summary" > .state/run_summary.md
            echo "*When:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> .state/run_summary.md
            echo "*Note:* Seeded to avoid empty artifact warnings." >> .state/run_summary.md
          }
          [ -f .state/run_summary.json ] || echo '{"seeded": true, "when": "'$(date -u +%FT%TZ)'"}' > .state/run_summary.json

      - name: Run bot main.py
        id: runbot
        shell: bash
        run: |
          set -e
          echo "DRY_RUN=${DRY_RUN}"
          echo "TP_PCT=${TP_PCT}  SL_PCT=${SL_PCT}"
          echo "SLOW_WINDOW_MIN=${SLOW_WINDOW_MIN}  SLOW_MIN_PCT=${SLOW_MIN_PCT}"
          echo "BUY_USD=${BUY_USD}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK:-<blank>}"
          python main.py
          mkdir -p .state

      - name: Upload .state artifact (no-warning even if empty)
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: ./.state/**
          if-no-files-found: ignore
