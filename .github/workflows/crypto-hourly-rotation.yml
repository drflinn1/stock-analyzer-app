name: Crypto â€” Hourly 1-Coin Rotation

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "ON = simulate, OFF = live"
        required: false
        default: "ON"
      UNIVERSE:
        description: "Comma symbols (BTC,ETH,SOL,...)"
        required: false
      MIN_BUY_USD:
        description: "Ticket size (USD)"
        required: false
        default: "25"

jobs:
  verify-rotation-logic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure hourly-rotation exits present in main.py
        run: |
          set -e
          python - <<'PY'
import sys, re, pathlib
code = pathlib.Path("main.py").read_text(encoding="utf-8", errors="ignore")
patterns = [
  r"STOP_-1%",        # hard stop
  r"TP_\+5%",         # take profit
  r"FAIL_<\+3%@60m",  # 60m underperformance exit
]
missing = [p for p in patterns if re.search(p, code) is None]
if missing:
    print("Missing rotation patterns:", missing)
    sys.exit(1)
print("Rotation sell logic patterns detected OK.")
PY

  run:
    runs-on: ubuntu-latest
    needs: verify-rotation-logic
    timeout-minutes: 12
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Hourly Rotation (DRY-RUN safe)
        env:
          DRY_RUN: ${{ inputs.DRY_RUN || vars.DRY_RUN || 'ON' }}
          UNIVERSE: ${{ inputs.UNIVERSE || vars.UNIVERSE || 'BTC,ETH,SOL' }}
          MIN_BUY_USD: ${{ inputs.MIN_BUY_USD || vars.MIN_BUY_USD || '25' }}
          FEE_BPS: ${{ vars.FEE_BPS || '10' }}
          RISK_ON: ${{ vars.RISK_ON || '1' }}
          RISK_THRESH_BTC_60M: ${{ vars.RISK_THRESH_BTC_60M || '-0.005' }}
          QUOTE: ${{ vars.QUOTE || 'USD' }}
          STATE_DIR: .state
        run: |
          python -V
          python main.py
          echo "---- .state/run_summary.md ----"
          cat .state/run_summary.md || true

      - name: Upload artifacts (.state)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hourly-rotation-state
          path: .state/
          if-no-files-found: warn
