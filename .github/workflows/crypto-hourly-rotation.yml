name: Crypto - 1-Coin Rotation (LIVE-ready, ultra-defensive, 15m)

on:
  schedule:
    - cron: "*/15 * * * *"          # keep 15-minute cadence
  workflow_dispatch:

concurrency:
  group: crypto-1coin-rotation
  cancel-in-progress: true

permissions:
  contents: write   # needed only if COMMIT_STATE=ON

env:
  # Guard & housekeeping
  AUTO_SELL_ON_MULTI: "OFF"         # OFF=refuse to buy if >1 coin; ON=auto-sell extras (wire later)
  USD_CODES: "USD,ZUSD"
  COMMIT_STATE: "OFF"               # OFF=default; set to ON if you want .state committed to repo

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests || true

      - name: Preflight — echo vars & ensure .state
        run: |
          set -e
          mkdir -p .state
          echo "=== Runtime Vars ==="
          echo "DRY_RUN=${{ github.event.inputs.DRY_RUN || env.DRY_RUN || 'ON' }}"
          echo "TP_PCT=${TP_PCT:=5}"
          echo "STOP_PCT=${STOP_PCT:=1}"
          echo "SLOW_MIN_PCT=${SLOW_MIN_PCT:=3}"
          echo "WINDOW_MIN=${WINDOW_MIN:=30}"
          echo "UNIVERSE_PICK=${UNIVERSE_PICK}"
          echo "AUTO_SELL_ON_MULTI=${AUTO_SELL_ON_MULTI}"
          echo "COMMIT_STATE=${COMMIT_STATE}"
          echo "=== ls -la .state (before) ==="
          ls -la .state || true

      # ---------- Single-position Guard (Kraken) ----------
      - name: Single-position guard (Kraken)
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          python - <<'PY'
          import os, time, urllib.parse, hashlib, hmac, base64, json, sys
          import requests

          def kraken_private(path, data):
            key = os.getenv("KRAKEN_API_KEY","")
            sec = os.getenv("KRAKEN_API_SECRET","")
            if not key or not sec:
              print("[GUARD] Missing keys; skipping guard.")
              sys.exit(0)
            url = "https://api.kraken.com" + path
            data["nonce"] = str(int(time.time()*1000))
            postdata = urllib.parse.urlencode(data)
            # sign
            msg = (str(data["nonce"]) + postdata).encode()
            sha256 = hashlib.sha256(msg).digest()
            mac = hmac.new(base64.b64decode(sec), path.encode()+sha256, hashlib.sha512)
            sig = base64.b64encode(mac.digest()).decode()
            r = requests.post(url, headers={"API-Key": key, "API-Sign": sig}, data=data, timeout=20)
            return r.json()

          bal = kraken_private("/0/private/Balance", {})
          if bal.get("error"):
            print("[GUARD] Balance error; skipping:", bal["error"])
            sys.exit(0)

          usd_codes = set(os.getenv("USD_CODES","USD,ZUSD").split(","))
          balances = {a:float(v) for a,v in (bal.get("result") or {}).items() if float(v) > 0.0000001}
          nonusd = {a:v for a,v in balances.items() if a not in usd_codes}
          print("[GUARD] Non-USD holdings:", nonusd)

          if len(nonusd) <= 1:
            sys.exit(0)

          os.makedirs(".state", exist_ok=True)
          with open(".state/run_summary.md","w") as f:
            f.write(f"**When:** {time.strftime('%Y-%m-%d %H:%M:%S UTC', time.gmtime())}\n")
            f.write("**Policy:** Single-position enforced\n")
            f.write(f"**Detected non-USD assets:** {json.dumps(nonusd)}\n")
            if os.getenv("AUTO_SELL_ON_MULTI","OFF").upper() != "ON":
              f.write("**Action:** Refused to buy (AUTO_SELL_ON_MULTI=OFF). Use Force Sell to clear extras.\n")
              print("[GUARD] >1 coins → refusing to buy (safe mode).")
              sys.exit(0)
            else:
              f.write("**Action:** Auto-sell requested (not wired in this safe build).\n")
              print("[GUARD] Auto-sell requested; not enabled in safe build.")
              sys.exit(0)
          PY

      - name: Run main.py (bot)
        run: |
          set -e
          python main.py

      # Safety net so artifacts always exist even on HOLD/ERROR runs
      - name: Always write summary + placeholder position if missing
        run: |
          set -e
          mkdir -p .state
          if [ ! -f ".state/run_summary.md" ]; then
            {
              echo "**When:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo "**DRY_RUN:** ${DRY_RUN:-ON}"
              echo "**TP_PCT:** ${TP_PCT:-5} | **STOP_PCT:** ${STOP_PCT:-1} | **SLOW_MIN_PCT:** ${SLOW_MIN_PCT:-3} | **WINDOW_MIN:** ${WINDOW_MIN:-30}"
              echo "**Note:** Auto-generated summary because the bot didn’t emit one this run."
            } > .state/run_summary.md
          fi
          if [ ! -f ".state/position.json" ]; then
            printf '{"symbol":null,"qty":0,"avg_price":0,"in_position_since":null}\n' > .state/position.json
          fi
          echo "=== ls -la .state (after write) ==="
          ls -la .state
          echo "=== stat files ==="
          stat .state/run_summary.md || true
          stat .state/position.json || true
          sync
          sleep 2

      - name: Upload .state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: .state           # upload the directory
          if-no-files-found: warn
          retention-days: 7

      - name: (Optional) Commit .state back to repo
        if: env.COMMIT_STATE == 'ON'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .state/* || true
          git commit -m "chore(.state): update rotation artifacts [skip ci]" || echo "No changes to commit"
          git push || echo "No push (detached HEAD on PR?)"
