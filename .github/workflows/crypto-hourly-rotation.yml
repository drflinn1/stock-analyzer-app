name: Crypto â€” 1-Coin Rotation (LIVE-ready, ultra-defensive, 15m)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    # >>> The critical line: export Kraken secrets for ALL steps <<<
    env:
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      # keep your existing knobs here (examples)
      DRY_RUN: "OFF"             # UI can still override if you use inputs
      BUY_USD: ${{ vars.BUY_USD || '25' }}
      UNIVERSE_PICK: ${{ vars.UNIVERSE_PICK || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz

      - name: [preflight] persist .state + write summary
        run: |
          mkdir -p .state
          printf "listing .state:\n"
          ls -la .state || true
          echo "mode: $DRY_RUN (UNIVERSE_PICK not set)" > .state/_note.txt

      # ---------- NEW: sanity ping using the SAME secrets this job will use ----------
      - name: Sanity check Kraken keys (same env as trade)
        run: |
          python - << 'PY'
          import os, time, base64, hashlib, hmac, urllib.parse, requests
          key = os.getenv("KRAKEN_API_KEY", "")
          sec = os.getenv("KRAKEN_API_SECRET", "")
          if not key or not sec:
              print("SANITY: Missing env keys"); raise SystemExit(2)
          url = "https://api.kraken.com/0/private/Balance"
          nonce = str(int(time.time()*1000))
          post = {"nonce": nonce}
          postdata = urllib.parse.urlencode(post)
          msg = ("/0/private/Balance").encode() + hashlib.sha256((nonce+postdata).encode()).digest()
          mac = hmac.new(base64.b64decode(sec), msg, hashlib.sha512)
          headers = {"API-Key": key, "API-Sign": base64.b64encode(mac.digest()).decode()}
          r = requests.post(url, headers=headers, data=post, timeout=20)
          try:
              j = r.json()
          except Exception:
              print("SANITY: Non-JSON response", r.status_code, r.text[:200]); raise SystemExit(3)
          if j.get("error"):
              print("SANITY: Kraken error ->", j["error"]); raise SystemExit(4)
          # success
          print("SANITY: OK (balance keys valid).")
          PY

      - name: Run main.py
        run: |
          python main.py || true

      - name: Bundle state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: crypto-rotation-state
          path: ./.state/**
          if-no-files-found: warn

      - name: Post job cleanup
        run: |
          echo "Cleanup complete."
