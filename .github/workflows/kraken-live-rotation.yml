# =====================================================================================
#  ⚠⚠⚠  WARNING — LIVE KRAKEN TRADING WORKFLOW  ⚠⚠⚠
# =====================================================================================

name: Kraken — 1-Coin Rotation (LIVE)

on:
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD to buy when flat"
        required: true
        default: "5"
      TP_PCT:
        description: "Take-profit %"
        required: true
        default: "8"
      SL_PCT:
        description: "Stop-loss %"
        required: true
        default: "2"

permissions:
  contents: read

concurrency:
  group: kraken-live-rotation
  cancel-in-progress: false

jobs:
  live-rotation:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests python-dotenv pandas ta matplotlib
          fi

      - name: Restore previous LIVE state
        uses: actions/download-artifact@v4
        with:
          name: kraken-live-rotation-state
          path: .state
        continue-on-error: true

      - name: Run LIVE bot (DRY_RUN=OFF)
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          BUY_USD: ${{ inputs.BUY_USD }}
          TP_PCT: ${{ inputs.TP_PCT }}
          SL_PCT: ${{ inputs.SL_PCT }}
          DRY_RUN: "OFF"
        run: |
          set -e
          echo "Repo root is $GITHUB_WORKSPACE"
          export PYTHONPATH="$GITHUB_WORKSPACE:$PYTHONPATH"
          echo "PYTHONPATH=$PYTHONPATH"
          python -m trader.kraken_live_main

      - name: Save state snapshot
        if: always()
        run: |
          mkdir -p .state
          echo "Last LIVE run $(date -u)" > .state/last_live_run.txt

      - name: Upload LIVE rotation state
        uses: actions/upload-artifact@v4
        with:
          name: kraken-live-rotation-state
          path: .state/**
          if-no-files-found: warn
          retention-days: 7
