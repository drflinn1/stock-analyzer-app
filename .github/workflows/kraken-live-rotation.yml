# =====================================================================================
#  ⚠⚠⚠  WARNING — LIVE KRAKEN TRADING WORKFLOW (Rotation v3)  ⚠⚠⚠
#
#  - This workflow sends REAL ORDERS to Kraken when it runs.
#  - DRY_RUN is HARD-CODED to "OFF" in this file.
#  - Default BUY_USD is SMALL ($5), but it is still REAL MONEY.
#
#  SAFETY TIPS:
#    * Only enable this schedule if you really want it trading 24/7.
#    * DOUBLE-CHECK: BUY_USD, TP/SL, and your Kraken balances first.
#    * If you just want to SIMULATE trades, use the Monday Baseline DRY bot.
# =====================================================================================

name: Kraken — 1-Coin Rotation (LIVE v3)

on:
  # Run automatically every 30 minutes (you can change this cron if needed)
  schedule:
    - cron: "*/30 * * * *"

  # Allow manual runs with custom inputs
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD notional to buy when flat (LIVE money)"
        required: true
        default: "5"
      TP_PCT:
        description: "Take-profit % (e.g., 8 = 8%)"
        required: true
        default: "8"
      SL_PCT:
        description: "Stop-loss % (e.g., 1 = 1%)"
        required: true
        default: "1"

concurrency:
  group: kraken-live-rotation
  cancel-in-progress: false

jobs:
  rotation:
    runs-on: ubuntu-latest

    env:
      # LIVE secret keys
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      # Defaults for scheduled runs (no UI inputs)
      BUY_USD: "5"
      TP_PCT: "8"
      SL_PCT: "1"

      # LIVE ONLY — no simulation in this workflow
      DRY_RUN: "OFF"

    steps:
      - name: Set up job
        run: echo "Starting Kraken LIVE rotation v3 job..."

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      # ----------------------------------------------------------------------
      # 1) Build momentum candidates (Kraken 24h gainers)
      #    This mirrors your Monday Baseline momentum scan step.
      # ----------------------------------------------------------------------
      - name: Build momentum candidates (Kraken 24h gainers)
        run: |
          echo "Running momentum scan to refresh momentum_candidates.csv..."
          mkdir -p .state
          # This should match your existing scan script.
          python tools/kraken_momentum_scan.py
          echo "==== Top of .state/momentum_candidates.csv ===="
          if [ -f ".state/momentum_candidates.csv" ]; then
            head -n 20 .state/momentum_candidates.csv
          elif [ -f "momentum_candidates.csv" ]; then
            head -n 20 momentum_candidates.csv
          else
            echo "No momentum_candidates CSV generated."
          fi

      # ----------------------------------------------------------------------
      # 2) Run LIVE rotation bot (kraken_live_main.py)
      #    For manual runs, we override BUY_USD / TP / SL from inputs.
      # ----------------------------------------------------------------------
      - name: Run LIVE rotation bot
        env:
          KRAKEN_API_KEY: ${{ env.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ env.KRAKEN_API_SECRET }}

          # For manual workflow_dispatch runs, prefer the UI values.
          BUY_USD: ${{ github.event.inputs.BUY_USD || env.BUY_USD }}
          TP_PCT: ${{ github.event.inputs.TP_PCT || env.TP_PCT }}
          SL_PCT: ${{ github.event.inputs.SL_PCT || env.SL_PCT }}

          # Always LIVE for this workflow
          DRY_RUN: "OFF"
        run: |
          echo "============================================================"
          echo " LIVE MODE: DRY_RUN=${DRY_RUN}"
          echo " BUY_USD : ${BUY_USD}"
          echo " TP_PCT  : ${TP_PCT}"
          echo " SL_PCT  : ${SL_PCT}"
          echo "============================================================"
          python kraken_live_main.py

      - name: Complete job
        run: echo "Kraken LIVE rotation v3 run completed."
