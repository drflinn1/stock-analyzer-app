# .github/workflows/kraken-live-rotation.yml
#
#  ‚ö†‚ö†‚ö†  WARNING ‚Äî LIVE KRAKEN TRADING WORKFLOW  ‚ö†‚ö†‚ö†
#
#  - This workflow sends REAL MARKET ORDERS to Kraken.
#  - It reuses the Monday Baseline v3 "Rotation with Guards" logic
#    (dust filter + keep strong winners + min-trade guards).
#
#  Behavior:
#    * Every 15 minutes, it will:
#        - Run the momentum scan to refresh .state/momentum_candidates.csv
#        - Run kraken_live_main.py with DRY_RUN=OFF (REAL trades)
#    * You can also run it manually with custom BUY_USD / TP_PCT / SL_PCT.
#
#  A1 Tuning Defaults:
#    BUY_USD          = 10.0  ‚Äì modest position size
#    TP_PCT           = 10.0  ‚Äì decent winners
#    SL_PCT           = 1.0   ‚Äì small loss
#    MIN_ROTATION_USD = 2.0   ‚Äì ignore tiny dust positions
#    MIN_PNL_TO_KEEP  = 10.0  ‚Äì keep only strong winners
#
#  If you want DRY runs, use the Monday Baseline DRY workflow instead.

name: Kraken ‚Äî 1-Coin Rotation (LIVE v3)

on:
  # üîÅ LIVE schedule ‚Äì runs every 15 minutes
  schedule:
    - cron: "*/15 * * * *"

  # ‚ñ∂ Manual runs with overrides
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD notional to buy when flat (default 10)"
        required: false
        default: "10"
      TP_PCT:
        description: "Take-profit % (e.g., 10 = 10%)"
        required: false
        default: "10"
      SL_PCT:
        description: "Stop-loss % (e.g., 1 = 1%)"
        required: false
        default: "1"
      MIN_ROTATION_USD:
        description: "Min USD value to rotate a coin (dust filter)"
        required: false
        default: "2.0"
      MIN_PNL_TO_KEEP:
        description: "Keep winners above this % gain"
        required: false
        default: "10.0"

jobs:
  live-rotation:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # Same scan as Monday Baseline ‚Äì writes .state/momentum_candidates.csv
      - name: Build momentum candidates (Kraken 24h gainers)
        run: |
          echo "Running momentum scan to refresh momentum_candidates.csv..."
          python tools/kraken_momentum_scan.py
        env:
          # Public-only scan, but keep keys available if script ever uses them
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      - name: Run LIVE rotation bot
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # For scheduled runs, github.event.inputs.* is empty ‚Üí fall back to defaults.
          BUY_USD:          ${{ github.event.inputs.BUY_USD          || '10'   }}
          TP_PCT:           ${{ github.event.inputs.TP_PCT           || '10'   }}
          SL_PCT:           ${{ github.event.inputs.SL_PCT           || '1'    }}
          MIN_ROTATION_USD: ${{ github.event.inputs.MIN_ROTATION_USD || '2.0'  }}
          MIN_PNL_TO_KEEP:  ${{ github.event.inputs.MIN_PNL_TO_KEEP  || '10.0' }}

          # LIVE MODE ONLY for this workflow
          DRY_RUN: "OFF"

        run: |
          echo "============================================================"
          echo "  Kraken ‚Äî 1-Coin Rotation (LIVE v3 ‚Äî Rotation with Guards, A1 tuning)"
          echo "------------------------------------------------------------"
          echo "  BUY_USD=${BUY_USD}"
          echo "  TP_PCT=${TP_PCT}"
          echo "  SL_PCT=${SL_PCT}"
          echo "  MIN_ROTATION_USD=${MIN_ROTATION_USD}"
          echo "  MIN_PNL_TO_KEEP=${MIN_PNL_TO_KEEP}"
          echo "  DRY_RUN=${DRY_RUN}"
          echo "============================================================"

          python kraken_live_main.py
