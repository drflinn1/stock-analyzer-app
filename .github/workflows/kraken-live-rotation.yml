# =====================================================================================
#  ⚠⚠⚠  WARNING — LIVE KRAKEN TRADING WORKFLOW  ⚠⚠⚠
#
#  - This workflow sends REAL ORDERS to Kraken when run.
#  - DRY_RUN is HARD-CODED to "OFF" in this file.
#  - Default BUY_USD is SMALL ($5), but it is still REAL MONEY.
#
#  SAFETY TIPS:
#    * Only run this manually from the "Actions" tab.
#    * DOUBLE-CHECK: BUY_USD, TP_PCT, SL_PCT, and your Kraken balances first.
#    * NEVER add a schedule: block here unless you are 100% sure.
#
#  If you just want to SIMULATE trades, use:
#    → "Kraken — 1-Coin Rotation (Monday Baseline)" (DRY-RUN)
# =====================================================================================

name: Kraken — 1-Coin Rotation (LIVE)

on:
  # Manual only for now – no schedule until you're ready.
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD notional to buy when flat"
        required: true
        default: "5"
      TP_PCT:
        description: "Take-profit %"
        required: true
        default: "8"
      SL_PCT:
        description: "Stop-loss %"
        required: true
        default: "2"

permissions:
  contents: read

concurrency:
  group: kraken-live-rotation
  cancel-in-progress: false

jobs:
  live-rotation:
    name: Run Kraken LIVE 1-Coin Rotation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # -------------------------------
      # 1) Get repo
      # -------------------------------
      - name: Get repo
        uses: actions/checkout@v4

      # -------------------------------
      # 2) Set up Python
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------
      # 3) Install dependencies
      # -------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback (should normally not be needed)
            pip install requests python-dotenv pandas ta matplotlib
          fi

      # -------------------------------
      # 4) Restore previous LIVE state (optional)
      # -------------------------------
      - name: Restore previous LIVE state (if exists)
        uses: actions/download-artifact@v4
        with:
          name: kraken-live-rotation-state
          path: .state
        continue-on-error: true

      # -------------------------------
      # 5) Optional: sync with live Kraken balances
      # -------------------------------
      - name: Sync position with live Kraken balances (optional)
        run: |
          if [ -f trader/kraken_live_positions.py ]; then
            echo "Found trader/kraken_live_positions.py – syncing live balances..."
            export PYTHONPATH="$GITHUB_WORKSPACE:$PYTHONPATH"
            python trader/kraken_live_positions.py
          else
            echo "No trader/kraken_live_positions.py found — skipping sync step."
          fi

      # -------------------------------
      # 6) RUN LIVE BOT  (DRY_RUN = OFF)
      # -------------------------------
      - name: Run live bot (LIVE, DRY_RUN=OFF)
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          BUY_USD: ${{ inputs.BUY_USD }}
          TP_PCT: ${{ inputs.TP_PCT }}
          SL_PCT: ${{ inputs.SL_PCT }}
          DRY_RUN: "OFF"
        run: |
          set -e
          echo "Repo root is: $GITHUB_WORKSPACE"
          echo "PYTHONPATH before: $PYTHONPATH"
          export PYTHONPATH="$GITHUB_WORKSPACE:$PYTHONPATH"
          echo "PYTHONPATH after:  $PYTHONPATH"
          python kraken_live_main.py

      # -------------------------------
      # 7) Ensure .state exists / update snapshot
      # -------------------------------
      - name: Save updated state snapshot
        if: always()
        run: |
          mkdir -p .state
          echo "Last LIVE run finished at $(date -u)" > .state/last_live_run.txt

      # -------------------------------
      # 8) Upload LIVE state artifact
      # -------------------------------
      - name: Upload LIVE rotation state
        uses: actions/upload-artifact@v4
        with:
          name: kraken-live-rotation-state
          path: .state/**
          if-no-files-found: warn
          retention-days: 7
