# =====================================================================================
#  ⚠⚠⚠  WARNING — LIVE KRAKEN TRADING WORKFLOW  ⚠⚠⚠
#
#  - This workflow sends REAL ORDERS to Kraken when run.
#  - DRY_RUN is HARD-CODED to "OFF" in this file.
#  - Default BUY_USD is SMALL ($7), but it is still REAL MONEY.
#
# =====================================================================================

name: Kraken — 1-Coin Rotation (LIVE)

on:
  workflow_dispatch:   # manual runs only (no schedule)

jobs:
  rotation_live:
    runs-on: ubuntu-latest

    steps:

    # ---------------------------------------------------------
    # Checkout code
    # ---------------------------------------------------------
    - name: Get repo
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # Setup Python
    # ---------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # ---------------------------------------------------------
    # Install dependencies
    # ---------------------------------------------------------
    - name: Install dependencies
      run: |
        pip install requests python-dotenv matplotlib pyyaml

    # ---------------------------------------------------------
    # Print LIVE warning
    # ---------------------------------------------------------
    - name: PRINT LIVE TRADING WARNING
      run: |
        echo "*******************************************************"
        echo "*** You are NOW running the LIVE KRAKEN ROTATION BOT ***"
        echo "*******************************************************"
        echo "BUY_USD = ${{ github.event.inputs.BUY_USD }}"
        echo "TP_PCT  = ${{ github.event.inputs.TP_PCT }}%"
        echo "SL_PCT  = ${{ github.event.inputs.SL_PCT }}%"
        echo "SOFT_SL_PCT = ${{ github.event.inputs.SOFT_SL_PCT }}%"
        echo "MODE = LIVE"
        echo "*******************************************************"

    # ---------------------------------------------------------
    # Sync live Kraken balances --> write real entry if needed
    # ---------------------------------------------------------
    - name: Sync position with live Kraken balances (real-trade)
      run: python trader/kraken_live_positions.py

    # ---------------------------------------------------------
    # RUN BOT (LIVE)
    # ---------------------------------------------------------
    - name: Run live bot (LIVE, DRY_RUN=OFF)
      env:
        KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
        KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        BUY_USD: ${{ github.event.inputs.BUY_USD }}
        TP_PCT: ${{ github.event.inputs.TP_PCT }}
        SL_PCT: ${{ github.event.inputs.SL_PCT }}
        SOFT_SL_PCT: ${{ github.event.inputs.SOFT_SL_PCT }}
        RUN_LIVE: "ON"         # <--- REAL MONEY
        DRY_RUN: "OFF"
      run: python main.py

    # ---------------------------------------------------------
    # Upload state artifacts
    # ---------------------------------------------------------
    - name: Upload state artifact
      uses: actions/upload-artifact@v4
      with:
        name: kraken-live-rotation-state
        path: |
          .state/*
