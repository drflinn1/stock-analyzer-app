name: Momentum â€” Scan (USD-only, commits .state)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install requests

      - name: Run USD-only momentum scan
        env:
          TOP_N: ${{ vars.TOP_N || 40 }}
          MIN_USD_VOL: ${{ vars.MIN_USD_VOL || 25000 }}   # ignore illiquid
          EXCLUDE: ${{ vars.EXCLUDE || 'USDT,USDC,DAI,FDUSD,PYUSD,TUSD,USD' }}  # bases to ignore
          OHLC_INTERVAL: ${{ vars.OHLC_INTERVAL || 5 }}   # minutes
        run: |
          python -u scripts/momentum_scan.py

      - name: Upload scan outputs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: momentum_scan_outputs
          path: |
            .state/momentum_candidates.csv

      - name: Commit .state to repo (so trader can read next run)
        run: |
          set -e
          git config --global user.email "bot@users.noreply.github.com"
          git config --global user.name "MomentumScanBot"
          mkdir -p .state
          git add .state/momentum_candidates.csv || true
          git commit -m "scan: update .state/momentum_candidates.csv (USD-only)" || true
          git push || true
