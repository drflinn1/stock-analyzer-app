name: Momentum — Scan

on:
  schedule:
    # Runs every hour at :05 (adjust as you like)
    - cron: "5 * * * *"
  workflow_dispatch:

# Only what we need
permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (lightweight fallback if no requirements.txt)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install --upgrade pip
            pip install requests pandas
          fi

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Echo env (debug)
        run: |
          echo "Branch: $GITHUB_REF_NAME"
          echo "Repo : $GITHUB_REPOSITORY"
          echo "Runner: $RUNNER_OS"

      - name: Run momentum scan (local)
        # Keep this command identical to your repo’s scan script if different
        run: |
          python -u trader/momentum_scan.py

      - name: Show state after run (glob)
        run: |
          echo "=== .state contents ==="
          ls -la .state || true
          echo "=== root CSVs (if any) ==="
          ls -la *.csv 2>/dev/null || true

      - name: Echo upload manifest
        shell: bash
        run: |
          shopt -s globstar nullglob dotglob
          echo "Files that will be uploaded as artifacts:"
          found=0
          for f in .state/**; do
            if [ -f "$f" ]; then
              echo " - $f"
              found=1
            fi
          done
          if [ $found -eq 0 ]; then
            echo " (none found; proceeding without warning)"
          fi

      - name: Upload .state artifacts
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}
          path: |
            .state/**
          if-no-files-found: ignore     # <- removes the yellow warning
          include-hidden-files: true
          compression-level: 6
          retention-days: 7
