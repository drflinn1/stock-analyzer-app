name: Momentum Scan (writes .state/momentum_candidates.csv)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: state-writers-main
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Checkout (full history so we can rebase)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Generate momentum_candidates.csv
        run: |
          python - << 'PY'
          import csv, pathlib
          state = pathlib.Path(".state")
          state.mkdir(exist_ok=True, parents=True)
          rows = [
              ("SOLUSD", "sol-usd", 1),
              ("BTCUSD", "btc-usd", 2),
              ("ETHUSD", "eth-usd", 3),
          ]
          with open(state / "momentum_candidates.csv", "w", newline="") as f:
              w = csv.writer(f)
              w.writerow(["symbol","quote","rank"])
              for r in rows:
                  w.writerow(r)
          print("Wrote .state/momentum_candidates.csv")
          PY

      # Your helper is at /scripts, so chmod that path:
      - name: Make push script executable
        run: chmod +x scripts/push_state.sh

      - name: Commit & push .state safely (rebase + retry)
        run: ./scripts/push_state.sh 'Momentum Scan: update .state/momentum_candidates.csv'
