name: Crypto Live - Overnight (15m)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

env:
  # --- Global toggles (Variables can override) ---
  DRY_RUN: ${{ vars.DRY_RUN || 'ON' }}            # ON for simulation, OFF for live
  RUN_SWITCH: ${{ vars.RUN_SWITCH || 'ON' }}      # ON to run logic, OFF to skip
  # --- Broker (Kraken) ---
  KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
  KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
  # --- Risk / sizing knobs ---
  MIN_BUY_USD: ${{ vars.MIN_BUY_USD || '10' }}
  MAX_POSITIONS: ${{ vars.MAX_POSITIONS || '3' }}
  MAX_BUYS_PER_RUN: ${{ vars.MAX_BUYS_PER_RUN || '2' }}
  UNIVERSE_TOP_K: ${{ vars.UNIVERSE_TOP_K || '25' }}
  RESERVE_CASH_PCT: ${{ vars.RESERVE_CASH_PCT || '5' }}
  ROTATE_WHEN_FULL: ${{ vars.ROTATE_WHEN_FULL || 'true' }}
  ROTATE_WHEN_CASH_SHORT: ${{ vars.ROTATE_WHEN_CASH_SHORT || 'true' }}
  MIN_SELL_USD: ${{ vars.MIN_SELL_USD || '10' }}
  DUST_MIN_USD: ${{ vars.DUST_MIN_USD || '2' }}
  DUST_SKIP_STABLES: ${{ vars.DUST_SKIP_STABLES || 'true' }}
  # --- Optional JSON knobs ---
  ADVANCED_JSON: ${{ vars.ADVANCED_JSON || '' }}
  PROTECT_JSON: ${{ vars.PROTECT_JSON || '' }}
  # --- Notifications (optional) ---
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
  # Entry script for your engine
  ENTRYPOINT: ${{ vars.ENTRYPOINT || 'trader/crypto_engine.py' }}

permissions:
  contents: read

concurrency:
  group: crypto-live-overnight-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install ccxt pandas numpy pyyaml requests matplotlib
          fi

      - name: Ensure .state exists
        run: mkdir -p .state

      - name: Warm snapshots (not used)
        run: echo "Skipping warm-up step"

      - name: Run trading loop
        id: trade
        env:
          GIT_REF_NAME: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          set -e
          echo "== BOT START =="
          echo "DRY_RUN=${DRY_RUN} RUN_SWITCH=${RUN_SWITCH}"
          echo "ENTRYPOINT=${ENTRYPOINT}"
          echo "STAMP=linux-${{ runner.os }}-${{ runner.arch }}-${GIT_REF_NAME}-${RUN_ID}-${RUN_ATTEMPT}" > .state/stamp.txt
          python -u main.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            .state/**
            kpi_history.csv
            positions.json
            sell_guard_summary.json
          if-no-files-found: warn

      - name: Job summary
        if: always()
        run: |
          {
            echo "### Crypto Live - Overnight (15m)";
            echo "";
            echo "- DRY_RUN: ${DRY_RUN}";
            echo "- RUN_SWITCH: ${RUN_SWITCH}";
            echo "- ENTRYPOINT: ${ENTRYPOINT}";
            if [ -f ".state/run_summary.md" ]; then
              echo "";
              cat .state/run_summary.md;
            fi
          } >> "$GITHUB_STEP_SUMMARY"
