name: Alpaca — Crypto Paper (single-file)

on:
  workflow_dispatch:
    inputs:
      SYMBOL:
        description: "Trading pair (e.g., BTC/USD, SOL/USD)"
        required: true
        default: "BTC/USD"
      BUY_USD:
        description: "USD notional to buy when flat"
        required: true
        default: "25"
      TP_PCT:
        description: "Take-profit %"
        required: true
        default: "5"
      SL_PCT:
        description: "Stop-loss %"
        required: true
        default: "2"
      EARLY_DROP_PCT:
        description: "Early-drop extra stop % while position is new"
        required: true
        default: "1"
      EARLY_WINDOW_MIN:
        description: "How long early-drop applies (minutes)"
        required: true
        default: "60"
      DRY_RUN:
        description: "ON to simulate orders; OFF to place real PAPER orders"
        required: true
        default: "ON"
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: read

jobs:
  paper_crypto:
    runs-on: ubuntu-latest
    env:
      # your secret names (Paper keys)
      APCA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY }}
      APCA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET }}
      APCA_API_BASE: ${{ secrets.ALPACA_BASE_URL }}
      APCA_DATA_BASE: https://data.alpaca.markets
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests matplotlib

      - name: Normalize base URL (fallback to paper if empty)
        run: |
          if [ -z "${APCA_API_BASE}" ]; then
            echo "APCA_API_BASE=https://paper-api.alpaca.markets" >> $GITHUB_ENV
          else
            echo "APCA_API_BASE=${APCA_API_BASE}" >> $GITHUB_ENV
          fi

      - name: Preflight — verify Alpaca auth
        id: preflight
        env:
          APCA_API_KEY_ID: ${{ env.APCA_API_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ env.APCA_API_SECRET_KEY }}
          APCA_API_BASE: ${{ env.APCA_API_BASE }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import os, json, requests, sys
          base = os.environ["APCA_API_BASE"].rstrip("/")
          key  = os.environ.get("APCA_API_KEY_ID","")
          sec  = os.environ.get("APCA_API_SECRET_KEY","")
          out = {"ok": False, "why": "", "status": None, "account": None}
          try:
            r = requests.get(f"{base}/v2/account",
                             headers={"APCA-API-KEY-ID": key, "APCA-API-SECRET-KEY": sec},
                             timeout=15)
            out["status"] = r.status_code
            if r.status_code == 200:
              acct = r.json()
              out["ok"] = True
              out["account"] = {
                "id": acct.get("id"),
                "status": acct.get("status"),
                "paper": acct.get("paper"),
                "crypto_status": acct.get("crypto_status"),
                "currency": acct.get("currency"),
              }
            else:
              out["why"] = r.text[:500]
          except Exception as e:
            out["why"] = str(e)
          open("preflight_auth.json","w").write(json.dumps(out, indent=2))
          print(json.dumps(out, indent=2))
          if not out["ok"]:
            sys.exit(17)
          PY
        continue-on-error: true

      - name: Run bot and capture state (with order audit)
        id: runbot
        if: always()
        env:
          SYMBOL: ${{ github.event.inputs.SYMBOL || 'BTC/USD' }}
          BUY_USD: ${{ github.event.inputs.BUY_USD || '25' }}
          TP_PCT: ${{ github.event.inputs.TP_PCT || '5' }}
          SL_PCT: ${{ github.event.inputs.SL_PCT || '2' }}
          EARLY_DROP_PCT: ${{ github.event.inputs.EARLY_DROP_PCT || '1' }}
          EARLY_WINDOW_MIN: ${{ github.event.inputs.EARLY_WINDOW_MIN || '60' }}
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'ON' }}
          APCA_API_KEY_ID: ${{ env.APCA_API_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ env.APCA_API_SECRET_KEY }}
          APCA_API_BASE: ${{ env.APCA_API_BASE }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, time, datetime as dt
          import requests
          import matplotlib.pyplot as plt

          def write_json(p, obj):
            open(p,"w").write(json.dumps(obj, indent=2))

          # Stop early if auth failed
          try:
            pf = json.load(open("preflight_auth.json"))
          except Exception:
            pf = {"ok": True}
          if not pf.get("ok", True):
            write_json("run_summary.json", {
              "action": "ERROR",
              "dry_run": True,
              "note": "Alpaca auth failed. Ensure repo secrets ALPACA_API_KEY / ALPACA_API_SECRET are PAPER keys.",
              "preflight": pf
            })
            raise SystemExit(1)

          S = os.environ["SYMBOL"]
          BUY_USD = float(os.environ["BUY_USD"])
          TP_PCT = float(os.environ["TP_PCT"])
          SL_PCT = float(os.environ["SL_PCT"])
          E_DROP = float(os.environ["EARLY_DROP_PCT"])
          E_MIN  = int(os.environ["EARLY_WINDOW_MIN"])
          DRY = (os.environ["DRY_RUN"].strip().upper() == "ON")

          API = os.environ["APCA_API_BASE"].rstrip("/")
          KEY = os.environ["APCA_API_KEY_ID"]
          SEC = os.environ["APCA_API_SECRET_KEY"]
          H = {"APCA-API-KEY-ID": KEY, "APCA-API-SECRET-KEY": SEC}

          def get(url, **params):
            r = requests.get(url, headers=H, params=params, timeout=20)
            r.raise_for_status(); return r.json()
          def post(url, payload):
            r = requests.post(url, headers={**H, "Content-Type":"application/json"},
                              data=json.dumps(payload), timeout=20)
            r.raise_for_status(); return r.json()

          def list_positions(): return get(f"{API}/v2/positions")
          def latest_position(symbol):
            for p in list_positions():
              if p.get("symbol")==symbol: return p
            return None
          def last_filled_buy(symbol):
            orders = get(f"{API}/v2/orders", status="all", direction="desc", limit=50)
            for o in orders:
              if o.get("symbol")==symbol and o.get("side")=="buy" and o.get("status")=="filled":
                return o
            return None
          def place_buy_notional(symbol, usd):
            return post(f"{API}/v2/orders", {"symbol":symbol,"side":"buy","type":"market","time_in_force":"gtc","notional":str(round(usd,2))})
          def place_sell_all(symbol, qty):
            return post(f"{API}/v2/orders", {"symbol":symbol,"side":"sell","type":"market","time_in_force":"gtc","qty":str(qty)})

          # helper to audit any order id
          def audit_order(order_id):
            try:
              od = get(f"{API}/v2/orders/{order_id}")
              write_json("last_order_detail.json", od)
              return od
            except Exception as e:
              write_json("last_order_detail.json", {"error": str(e)})
              return None

          # dump last 20 orders (all statuses)
          try:
            dump = get(f"{API}/v2/orders", status="all", direction="desc", limit=20)
            write_json("orders_dump.json", dump)
          except Exception as e:
            write_json("orders_dump.json", {"error": str(e)})

          pos = latest_position(S)
          action, order_id, note, mid = None, None, "", None

          if pos is None:
            action = "BUY"
            if DRY:
              note = f"(DRY) Would buy {S} with ${BUY_USD:.2f} notional."
            else:
              try:
                od = place_buy_notional(S, BUY_USD)
                order_id = od.get("id")
                # brief wait then audit the created order
                time.sleep(2)
                audit_order(order_id)
                note = f"Entered {S} with ${BUY_USD:.2f} notional."
              except Exception as e:
                note = f"BUY failed: {e}"
          else:
            qty = float(pos["qty"])
            avg = float(pos["avg_entry_price"])
            cur = float(pos.get("current_price", avg))
            upnl_pct = float(pos.get("unrealized_plpc", (cur-avg)/avg))*100.0

            # entry age
            age_min = None
            lf = last_filled_buy(S)
            if lf and lf.get("filled_at"):
              try:
                t = dt.datetime.fromisoformat(lf["filled_at"].replace("Z","+00:00"))
                age_min = (dt.datetime.utcnow() - t).total_seconds()/60.0
              except Exception: pass

            sell_reason=None
            if upnl_pct >= TP_PCT: sell_reason=f"TP hit (≥ {TP_PCT:.2f}%)"
            elif upnl_pct <= -SL_PCT: sell_reason=f"SL hit (≤ -{SL_PCT:.2f}%)"
            elif age_min is not None and age_min <= E_MIN and upnl_pct <= -E_DROP:
              sell_reason=f"Early-drop guard (≤ -{E_DROP:.2f}% within {E_MIN}m)"

            if sell_reason:
              action="SELL"
              if DRY:
                note=f"(DRY) Would SELL {qty} {S} — {sell_reason}."
              else:
                try:
                  od = place_sell_all(S, qty)
                  order_id = od.get("id")
                  time.sleep(2)
                  audit_order(order_id)
                  note=f"Sold {qty} {S} — {sell_reason}."
                except Exception as e:
                  note=f"SELL failed: {e}"
            else:
              action="HOLD"; note=f"Holding {S}. PnL {upnl_pct:.2f}%."
            mid = cur

          # basic KPI artifacts
          kpi = {"tp_pct":TP_PCT,"sl_pct":SL_PCT,"early_drop_pct":E_DROP,"early_window_min":E_MIN}
          if pos:
            kpi.update({
              "qty": float(pos["qty"]),
              "avg_entry": float(pos["avg_entry_price"]),
              "current_price": float(pos.get("current_price", pos["avg_entry_price"])),
              "unrealized_pl": float(pos.get("unrealized_pl", 0.0)),
              "unrealized_plpc_pct": float(pos.get("unrealized_plpc", 0.0))*100.0,
            })
          try:
            import matplotlib.pyplot as plt
            plt.figure(figsize=(4,3), dpi=200)
            plt.bar(["PnL %"], [kpi.get("unrealized_plpc_pct",0.0)])
            plt.axhline(0, linewidth=1); plt.title(f"{S} P&L% (now)"); plt.ylabel("%"); plt.tight_layout()
            plt.savefig("kpi_chart.png")
          except Exception: pass

          write_json("position_snapshot.json", pos or {})
          write_json("kpi_snapshot.json", kpi)
          run_summary = {
            "ts": int(time.time()), "symbol": S, "action": action, "dry_run": DRY,
            "buy_usd": BUY_USD, "tp_pct": TP_PCT, "sl_pct": SL_PCT,
            "order_id": order_id, "position_present": pos is not None, "mid_price": mid, "note": note
          }
          write_json("run_summary.json", run_summary)
          PY

      - name: Upload state summary (artifacts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alpaca-paper-state
          path: |
            preflight_auth.json
            run_summary.json
            position_snapshot.json
            kpi_snapshot.json
            kpi_chart.png
            orders_dump.json
            last_order_detail.json
          if-no-files-found: warn
