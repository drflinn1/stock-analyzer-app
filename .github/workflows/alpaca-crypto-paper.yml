name: Alpaca — Crypto Paper (single-file)

on:
  workflow_dispatch:
    inputs:
      SYMBOL:
        description: "Trading pair (e.g., BTC/USD, SOL/USD)"
        required: true
        default: "BTC/USD"
      BUY_USD:
        description: "USD notional to buy when flat"
        required: true
        default: "25"
      TP_PCT:
        description: "Take-profit %"
        required: true
        default: "5"
      SL_PCT:
        description: "Stop-loss %"
        required: true
        default: "2"
      EARLY_DROP_PCT:
        description: "Early-drop extra stop % while position is new"
        required: true
        default: "1"
      EARLY_WINDOW_MIN:
        description: "How long early-drop applies (minutes)"
        required: true
        default: "60"
      DRY_RUN:
        description: "ON to simulate orders; OFF to place real PAPER orders"
        required: true
        default: "ON"   # safer default
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes by default

permissions:
  contents: read

jobs:
  paper_crypto:
    runs-on: ubuntu-latest
    env:
      APCA_API_KEY_ID: ${{ secrets.APCA_API_KEY_ID }}
      APCA_API_SECRET_KEY: ${{ secrets.APCA_API_SECRET_KEY }}
      APCA_API_BASE: https://paper-api.alpaca.markets
      APCA_DATA_BASE: https://data.alpaca.markets
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests matplotlib

      - name: Run bot and capture state
        id: runbot
        env:
          SYMBOL: ${{ github.event.inputs.SYMBOL || 'BTC/USD' }}
          BUY_USD: ${{ github.event.inputs.BUY_USD || '25' }}
          TP_PCT: ${{ github.event.inputs.TP_PCT || '5' }}
          SL_PCT: ${{ github.event.inputs.SL_PCT || '2' }}
          EARLY_DROP_PCT: ${{ github.event.inputs.EARLY_DROP_PCT || '1' }}
          EARLY_WINDOW_MIN: ${{ github.event.inputs.EARLY_WINDOW_MIN || '60' }}
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'ON' }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, time, math, datetime as dt
          from urllib.parse import quote
          import requests
          import matplotlib.pyplot as plt

          S = os.environ["SYMBOL"]            # e.g. BTC/USD
          BUY_USD = float(os.environ["BUY_USD"])
          TP_PCT = float(os.environ["TP_PCT"])
          SL_PCT = float(os.environ["SL_PCT"])
          E_DROP = float(os.environ["EARLY_DROP_PCT"])
          E_MIN  = int(os.environ["EARLY_WINDOW_MIN"])
          DRY = (os.environ["DRY_RUN"].strip().upper() == "ON")

          API = os.environ["APCA_API_BASE"].rstrip("/")
          KEY = os.environ["APCA_API_KEY_ID"]
          SEC = os.environ["APCA_API_SECRET_KEY"]
          H = {"APCA-API-KEY-ID": KEY, "APCA-API-SECRET-KEY": SEC}

          def get(url, **params):
            r = requests.get(url, headers=H, params=params, timeout=20)
            r.raise_for_status(); return r.json()
          def post(url, payload):
            r = requests.post(url, headers={**H, "Content-Type":"application/json"},
                              data=json.dumps(payload), timeout=20)
            r.raise_for_status(); return r.json()
          def delete(url):
            r = requests.delete(url, headers=H, timeout=20)
            if r.status_code not in (200,204): r.raise_for_status()
            return True

          now = dt.datetime.utcnow()
          # --- helpers -------------------------------------------------------
          def list_positions():
            return get(f"{API}/v2/positions")

          def latest_position(symbol):
            # Alpaca returns symbols like 'BTC/USD'
            for p in list_positions():
              if p.get("symbol") == symbol:
                return p
            return None

          def last_filled_buy(symbol):
            # recent orders, newest first
            orders = get(f"{API}/v2/orders", status="all", direction="desc", limit=50)
            for o in orders:
              if o.get("symbol")==symbol and o.get("side")=="buy" and o.get("status")=="filled":
                return o
            return None

          def place_buy_notional(symbol, usd):
            payload = {
              "symbol": symbol,
              "side": "buy",
              "type": "market",
              "time_in_force": "gtc",
              "notional": str(round(usd,2)),
            }
            return post(f"{API}/v2/orders", payload)

          def place_sell_all(symbol, qty):
            payload = {
              "symbol": symbol,
              "side": "sell",
              "type": "market",
              "time_in_force": "gtc",
              "qty": str(qty)
            }
            return post(f"{API}/v2/orders", payload)

          # --- state probe ---------------------------------------------------
          pos = latest_position(S)
          action = None
          order_id = None
          note = ""
          mid = None

          # Use position fields for P&L evaluation if present
          def pct(x): return float(x)*100.0

          if pos is None:
            # flat → BUY decision
            action = "BUY"
            if DRY:
              note = f"(DRY) Would buy {S} with ${BUY_USD:.2f} notional."
            else:
              try:
                od = place_buy_notional(S, BUY_USD)
                order_id = od.get("id")
                note = f"Entered {S} with ${BUY_USD:.2f} notional."
              except Exception as e:
                note = f"BUY failed: {e}"
          else:
            # have a position → evaluate exits
            qty = float(pos["qty"])
            avg = float(pos["avg_entry_price"])
            cur = float(pos.get("current_price", avg))
            upnl_pct = float(pos.get("unrealized_plpc", (cur-avg)/avg))
            upnl_pct *= 100.0

            # entry age via last filled buy
            age_min = None
            lf = last_filled_buy(S)
            if lf and lf.get("filled_at"):
              try:
                t = dt.datetime.fromisoformat(lf["filled_at"].replace("Z","+00:00"))
                age_min = (now - t).total_seconds()/60.0
              except Exception:
                age_min = None

            # decide
            sell_reason = None
            if upnl_pct >= TP_PCT:
              sell_reason = f"TP hit (≥ {TP_PCT:.2f}%)"
            elif upnl_pct <= -SL_PCT:
              sell_reason = f"SL hit (≤ -{SL_PCT:.2f}%)"
            elif age_min is not None and age_min <= E_MIN and upnl_pct <= -E_DROP:
              sell_reason = f"Early-drop guard (≤ -{E_DROP:.2f}% within {E_MIN}m)"

            if sell_reason:
              action = "SELL"
              if DRY:
                note = f"(DRY) Would SELL {qty} {S} — {sell_reason}."
              else:
                try:
                  od = place_sell_all(S, qty)
                  order_id = od.get("id")
                  note = f"Sold {qty} {S} — {sell_reason}."
                except Exception as e:
                  note = f"SELL failed: {e}"
            else:
              action = "HOLD"
              note = f"Holding {S}. PnL {upnl_pct:.2f}%."

            # for summary
            mid = cur

          # --- KPI + artifacts ----------------------------------------------
          # Position snapshot (if any)
          position_present = pos is not None
          pos_snap = pos or {}

          kpi = {
            "tp_pct": TP_PCT, "sl_pct": SL_PCT,
            "early_drop_pct": E_DROP, "early_window_min": E_MIN,
          }
          if pos is not None:
            kpi.update({
              "qty": float(pos["qty"]),
              "avg_entry": float(pos["avg_entry_price"]),
              "current_price": float(pos.get("current_price", pos["avg_entry_price"])),
              "unrealized_pl": float(pos.get("unrealized_pl", 0.0)),
              "unrealized_plpc_pct": float(pos.get("unrealized_plpc", 0.0))*100.0,
            })

          # simple KPI chart (current P&L%)
          try:
            plt.figure(figsize=(4,3), dpi=200)
            val = kpi.get("unrealized_plpc_pct", 0.0)
            plt.bar(["PnL %"], [val])
            plt.axhline(0, linewidth=1)
            plt.title(f"{S} P&L% (now)")
            plt.ylabel("%")
            plt.tight_layout()
            plt.savefig("kpi_chart.png")
          except Exception as e:
            pass

          run_summary = {
            "ts": int(time.time()),
            "symbol": S,
            "action": action,
            "dry_run": DRY,
            "buy_usd": BUY_USD,
            "tp_pct": TP_PCT,
            "sl_pct": SL_PCT,
            "order_id": order_id,
            "position_present": position_present,
            "mid_price": mid,
            "note": note
          }

          with open("run_summary.json","w") as f: json.dump(run_summary, f, indent=2)
          with open("position_snapshot.json","w") as f: json.dump(pos_snap, f, indent=2)
          with open("kpi_snapshot.json","w") as f: json.dump(kpi, f, indent=2)

          print(json.dumps(run_summary, indent=2))
          PY

      - name: Upload state summary (artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: alpaca-paper-state
          path: |
            run_summary.json
            position_snapshot.json
            kpi_snapshot.json
            kpi_chart.png
          if-no-files-found: warn
