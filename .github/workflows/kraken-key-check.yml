name: Kraken â€” Key Sanity Check (on demand)

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      KRAKEN_API_KEY:    ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (requests)
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Call private /Balance (clear PASS/FAIL)
        shell: python
        env:
          API_BASE: "https://api.kraken.com"
        run: |
          import base64, hashlib, hmac, os, time, requests, urllib.parse, sys, json

          key = os.environ.get("KRAKEN_API_KEY", "")
          sec = os.environ.get("KRAKEN_API_SECRET", "")
          if not key or not sec:
              print("FAIL: Missing KRAKEN_API_KEY / KRAKEN_API_SECRET in repo Secrets.")
              sys.exit(1)

          def nonce():
              return str(int(time.time() * 1000))

          def sign(path, data, secret_b64):
              postdata = urllib.parse.urlencode(data)
              # sha256(nonce + postdata)
              sha = hashlib.sha256((data["nonce"] + postdata).encode()).digest()
              msg = path.encode() + sha
              secret = base64.b64decode(secret_b64)
              sig = hmac.new(secret, msg, hashlib.sha512).digest()
              return base64.b64encode(sig).decode()

          path = "/0/private/Balance"
          payload = {"nonce": nonce()}
          headers = {
              "API-Key": key,
              "API-Sign": sign(path, payload, sec),
              "User-Agent": "stock-analyzer-app/key-sanity"
          }

          url = os.environ["API_BASE"] + path
          try:
              r = requests.post(url, data=payload, headers=headers, timeout=20)
              print(f"HTTP {r.status_code}")
              try:
                  js = r.json()
              except Exception:
                  print("FAIL: Non-JSON response from Kraken.")
                  print(r.text[:500])
                  sys.exit(1)

              # Show a tiny redacted snippet
              print("Response:", json.dumps(
                  {"error": js.get("error"), "has_result": bool(js.get("result"))},
                  indent=2))

              if r.status_code != 200:
                  print("FAIL: HTTP not 200.")
                  sys.exit(1)

              if js.get("error"):
                  print("FAIL: Kraken error field is non-empty.")
                  sys.exit(1)

              if not js.get("result"):
                  print("FAIL: Empty result object.")
                  sys.exit(1)

              # If we got here, keys & signature worked
              print("PASS: Keys valid; private /Balance returned data.")
              sys.exit(0)

          except requests.RequestException as e:
              print(f"FAIL: Request exception: {e}")
              sys.exit(1)
