name: Kraken â€” Key Sanity Check (on demand)

on:
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      KRAKEN_API_KEY:    ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Call private /Balance
        run: |
          python - <<'PY'
          import os, time, hmac, hashlib, base64, urllib.parse, requests, json
          key=os.getenv("KRAKEN_API_KEY"); sec=os.getenv("KRAKEN_API_SECRET")
          if not key or not sec:
              raise SystemExit("Missing KRAKEN_API_KEY/SECRET")
          uri="https://api.kraken.com/0/private/Balance"
          path="/0/private/Balance"
          nonce=str(int(time.time()*1000))
          data={"nonce": nonce}
          postdata=urllib.parse.urlencode(data)
          message=(nonce + postdata).encode()
          sha256=hashlib.sha256(message).digest()
          mac=hmac.new(base64.b64decode(sec), (path.encode()+sha256), hashlib.sha512)
          sig=base64.b64encode(mac.digest()).decode()
          headers={"API-Key": key, "API-Sign": sig}
          r=requests.post(uri, data=data, headers=headers, timeout=20)
          print("HTTP", r.status_code)
          print(r.text)
          payload = r.json()
          if payload.get("error")==[]:
              print("OK: Auth works.")
          else:
              print("Auth failed:", payload.get("error"))
              raise SystemExit(1)
          PY
