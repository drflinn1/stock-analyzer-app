name: Rebalance

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Do not make external changes (safe test mode)"
        required: false
        default: "true"
      ignore_market_hours:
        description: "Run even if outside US market hours (for testing)"
        required: false
        default: "false"
  schedule:
    # 3:55 PM New York time on business days (two rules to handle EST/EDT)
    - cron: '55 19 * * 1-5'   # 3:55 PM during EDT (UTC-4)
    - cron: '55 20 * * 1-5'   # 3:55 PM during EST (UTC-5)

concurrency:
  group: rebalance
  cancel-in-progress: false

jobs:
  rebalance:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # (Optional) give a quick line in the job summary about how we're running
      - name: Decide dry-run
        id: decide
        run: |
          echo "DRY_RUN=${{ github.event.inputs.dry_run || 'true' }}" >> "$GITHUB_ENV"
          echo "ignore_market_hours=${{ github.event.inputs.ignore_market_hours || 'false' }}" >> "$GITHUB_ENV"
          echo "### Rebalance run" >> "$GITHUB_STEP_SUMMARY"
          echo "- **dry_run**: ${{ github.event.inputs.dry_run || 'true' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ignore_market_hours**: ${{ github.event.inputs.ignore_market_hours || 'false' }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Run rebalance script
        run: |
          echo "Running rebalance..."
          python rebalance.py \
            --dry-run "${{ env.DRY_RUN }}" \
            --ignore-market-hours "${{ env.ignore_market_hours }}"

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signals
          if-no-files-found: warn
          path: |
            signals.json
            rebalance.log
