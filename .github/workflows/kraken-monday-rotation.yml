# .github/workflows/kraken-monday-rotation.yml
# =============================================================================
#  Kraken — 1-Coin Rotation (Monday Baseline v2, DRY-RUN default)
#
#  - Runs every 30 minutes (cron) AND can be run manually.
#  - Calls the Kraken momentum scan to refresh momentum_candidates.csv.
#  - kraken_monday_main.py reads that CSV and decides:
#       * If flat  -> BUY ~BUY_USD worth of the top coin.
#       * If long  -> TP/SL check, SELL when hit.
#
#  SAFETY:
#    * DRY_RUN defaults to "ON" so scheduled runs are SIMULATION ONLY.
#    * To place real orders, you must manually run the workflow and
#      set DRY_RUN = "OFF" in the dispatch form.
# =============================================================================

name: Kraken — 1-Coin Rotation (Monday Baseline v2)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD notional to buy when flat"
        required: true
        default: "20"
      TP_PCT:
        description: "Take-profit % (e.g., 8 = 8%)"
        required: true
        default: "8"
      SL_PCT:
        description: "Stop-loss % (e.g., 1 = 1%)"
        required: true
        default: "1"
      DRY_RUN:
        description: "ON = simulate (recommended), OFF = real orders"
        required: true
        default: "ON"

jobs:
  rotation:
    runs-on: ubuntu-latest

    concurrency:
      group: kraken-monday-rotation
      cancel-in-progress: false

    env:
      PYTHONUNBUFFERED: "1"

      # Inputs (with safe defaults so cron runs work)
      BUY_USD: ${{ github.event.inputs.BUY_USD || '20' }}
      TP_PCT:  ${{ github.event.inputs.TP_PCT  || '8'  }}
      SL_PCT:  ${{ github.event.inputs.SL_PCT  || '1'  }}
      DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'ON' }}

      # Kraken API credentials (same as live bot)
      KRAKEN_API_KEY:    ${{ secrets.KRAKEN_API_KEY }}
      KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests python-dotenv pandas
          fi

      - name: Build momentum candidates (Kraken 24h gainers)
        run: |
          echo "Running momentum scan to refresh momentum_candidates.csv..."
          # This matches your existing kraken-momentum-scan workflow
          python tools/kraken_momentum_scan.py
          echo "==== Top of momentum_candidates.csv ===="
          head -n 20 momentum_candidates.csv || echo "No CSV generated?"

      - name: Run Monday rotation bot
        run: |
          echo "============================================================"
          echo "  Kraken — 1-Coin Rotation (Monday Baseline v2)"
          echo "------------------------------------------------------------"
          echo "  BUY_USD=${BUY_USD}"
          echo "  TP_PCT=${TP_PCT}"
          echo "  SL_PCT=${SL_PCT}"
          echo "  DRY_RUN=${DRY_RUN}"
          echo "============================================================"
          python kraken_monday_main.py
