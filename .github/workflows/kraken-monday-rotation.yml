# .github/workflows/kraken-monday-rotation.yml
#
# Kraken â€” 1-Coin Rotation (Monday Baseline v2)
# - Scheduled every 30 minutes in DRY mode (safe).
# - Manual runs can flip DRY_RUN to OFF to place real orders.

name: Kraken â€” 1-Coin Rotation (Monday Baseline v2)

on:
  # Every 30 minutes â€“ always DRY for safety
  schedule:
    - cron: "*/30 * * * *"

  # Manual runs â€“ you can override BUY_USD/TP/SL/DRY_RUN
  workflow_dispatch:
    inputs:
      BUY_USD:
        description: "USD notional to buy when flat"
        required: false
        default: "20"
      TP_PCT:
        description: "Take-profit % (e.g., 8 = 8%)"
        required: false
        default: "8"
      SL_PCT:
        description: "Stop-loss % (e.g., 1 = 1%)"
        required: false
        default: "1"
      DRY_RUN:
        description: "ON = simulate (recommended), OFF = real orders"
        required: false
        default: "ON"

jobs:
  rotation:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # This is the scan that writes .state/momentum_candidates.csv
      - name: Build momentum candidates (Kraken 24h gainers)
        run: |
          echo "Running momentum scan to refresh momentum_candidates.csv..."
          python tools/kraken_momentum_scan.py
        env:
          # Public-only scan, but keep keys available if script ever uses them
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

      - name: Run Monday rotation bot
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}

          # For schedule runs, github.event.inputs.* is empty â†’ fall back to defaults.
          BUY_USD: ${{ github.event.inputs.BUY_USD || '20' }}
          TP_PCT:  ${{ github.event.inputs.TP_PCT  || '8' }}
          SL_PCT:  ${{ github.event.inputs.SL_PCT  || '1' }}

          # ðŸ”‘ IMPORTANT:
          #  - If this is a manual run (workflow_dispatch), pass through what you typed.
          #  - If this is a scheduled run, the left side is false, so it falls back to 'ON'.
          #
          #    workflow_dispatch & DRY_RUN='OFF'  â†’ DRY_RUN='OFF' (LIVE)
          #    workflow_dispatch & DRY_RUN='ON'   â†’ DRY_RUN='ON'  (DRY)
          #    schedule                           â†’ DRY_RUN='ON'  (always DRY)
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.DRY_RUN || 'ON' }}

        run: |
          echo "============================================================"
          echo "  Kraken â€” 1-Coin Rotation (Monday Baseline v3 â€” Pure Rotation, C1)"
          echo "------------------------------------------------------------"
          echo "  BUY_USD=${BUY_USD}"
          echo "  TP_PCT=${TP_PCT}"
          echo "  SL_PCT=${SL_PCT}"
          echo "  DRY_RUN=${DRY_RUN}"
          echo "============================================================"

          python kraken_monday_main.py
