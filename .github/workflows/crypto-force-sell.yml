#!/usr/bin/env python3
"""
Self-contained Force Sell tool for Kraken.
- Accepts SYMBOL = 'SOON', 'SOONUSD', 'SOON/USD', or 'ALL'
- Reads secrets: KRAKEN_API_KEY / KRAKEN_API_SECRET
- Works without needing trader/kraken.py
"""

import os, sys, json, time, base64, hashlib, hmac, urllib.parse, requests

def kraken_private(path, data, key, secret):
    """Send signed private request to Kraken API."""
    nonce = str(int(time.time() * 1000))
    data["nonce"] = nonce
    postdata = urllib.parse.urlencode(data)
    message = (nonce + postdata).encode()
    sha256 = hashlib.sha256(message).digest()
    mac_data = path.encode() + sha256
    mac = hmac.new(base64.b64decode(secret), mac_data, hashlib.sha512)
    headers = {"API-Key": key, "API-Sign": base64.b64encode(mac.digest())}
    r = requests.post("https://api.kraken.com" + path, headers=headers, data=data, timeout=15)
    return r.json()

def get_balances(key, secret):
    resp = kraken_private("/0/private/Balance", {}, key, secret)
    return resp.get("result", {}) if isinstance(resp, dict) else {}

def get_ticker(symbol):
    pair = symbol.replace("/", "")
    try:
        r = requests.get("https://api.kraken.com/0/public/Ticker", params={"pair": pair}, timeout=10)
        j = r.json()
        res = list(j.get("result", {}).values())
        if not res: return 0.0
        return float(res[0]["c"][0])
    except Exception:
        return 0.0

def norm(s: str) -> str:
    s = (s or "").upper().strip().replace(" ", "").replace("-", "/")
    if s in ("", "ALL"): return s
    if "/" in s: return s
    if s.endswith("USD"): return f"{s[:-3]}/USD"
    return f"{s}/USD"

def sell(symbol, amount, key, secret):
    """Try market sell; fallback to limit if blocked by price-protection."""
    pair = symbol.replace("/", "")
    # First, try market
    print(f"[FORCE] Market sell {amount} {symbol}...")
    resp = kraken_private("/0/private/AddOrder", {
        "ordertype": "market",
        "type": "sell",
        "pair": pair,
        "volume": str(amount),
    }, key, secret)
    errs = resp.get("error", [])
    if errs:
        if any("price protection" in e.lower() for e in errs):
            px = get_ticker(symbol)
            if px <= 0:
                print("Could not fetch price for fallback limit.")
                return resp
            slip = float(os.getenv("LIMIT_SLIP_PCT", "1.5")) / 100.0
            limit_px = px * (1.0 - slip)
            print(f"[FORCE] Retrying with limit {limit_px:.8f} ({slip*100:.1f}% through book)")
            resp2 = kraken_private("/0/private/AddOrder", {
                "ordertype": "limit",
                "price": f"{limit_px:.8f}",
                "type": "sell",
                "pair": pair,
                "volume": str(amount),
            }, key, secret)
            return resp2
    return resp

def main():
    key = os.getenv("KRAKEN_API_KEY", "")
    secret = os.getenv("KRAKEN_API_SECRET", "")
    if not key or not secret:
        print("âŒ Missing Kraken API secrets in repo settings.")
        sys.exit(1)

    sym_in = os.getenv("SYMBOL", "ALL")
    limit_slip = float(os.getenv("LIMIT_SLIP_PCT", "1.5"))
    symbol = norm(sym_in)
    bals = get_balances(key, secret)
    print(json.dumps(bals, indent=2))

    targets = []
    if symbol == "ALL":
        for k, v in bals.items():
            if float(v) > 0 and k.endswith("USD"):
                targets.append((k.replace("USD", "/USD"), float(v)))
    else:
        for k, v in bals.items():
            if symbol.replace("/", "") in k and float(v) > 0:
                targets.append((symbol, float(v)))
                break

    if not targets:
        print("No matching holdings found to sell.")
        return

    for sym, amt in targets:
        resp = sell(sym, amt, key, secret)
        print(json.dumps(resp, indent=2))
        time.sleep(1)

if __name__ == "__main__":
    main()
